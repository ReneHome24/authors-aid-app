<!DOCTYPE html>
<html lang="en" class="theme-default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Author's Aid | Your AI Co-author for Christian Literature</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
    <!-- Font Awesome for eye icon and loading spinner -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent global scrollbar on editor pages */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
        }
        .font-lora { font-family: 'Lora', serif; }

        /* --- THEME DEFINITIONS --- */
        .theme-default .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(59, 130, 246, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(139, 92, 246, 0.08), transparent 60%); }
        .theme-default .accent-bg { background-color: #2563eb; }
        .theme-default .accent-bg-hover:hover { background-color: #1d4ed8; }
        .theme-default .accent-text { color: #60a5fa; }
        .theme-default .accent-text-hover:hover { color: #3b82f6; }
        .theme-default .accent-ring:focus { ring-color: #3b82f6; }
        .theme-default .ui-bg { background-color: #1f2937; }

        .theme-red .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(220, 38, 38, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(159, 18, 57, 0.1), transparent 60%); }
        .theme-red .accent-bg { background-color: #dc2626; }
        .theme-red .accent-bg-hover:hover { background-color: #b91c1c; }
        .theme-red .accent-text { color: #f87171; }
        .theme-red .accent-text-hover:hover { color: #ef4444; }
        .theme-red .accent-ring:focus { ring-color: #ef4444; }
        .theme-red .ui-bg { background-color: #261717; }


        .theme-gold .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(252, 211, 77, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(245, 158, 11, 0.1), transparent 60%); }
        .theme-gold .accent-bg { background-color: #f59e0b; }
        .theme-gold .accent-bg-hover:hover { background-color: #d97706; }
        .theme-gold .accent-text { color: #fcd34d; }
        .theme-gold .accent-text-hover:hover { color: #fbbf24; }
        .theme-gold .accent-ring:focus { ring-color: #fbbf24; }
        .theme-gold .ui-bg { background-color: #292211; }

        .theme-green .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(16, 185, 129, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(5, 150, 105, 0.1), transparent 60%); }
        .theme-green .accent-bg { background-color: #059669; }
        .theme-green .accent-bg-hover:hover { background-color: #047857; }
        .theme-green .accent-text { color: #34d399; }
        .theme-green .accent-text-hover:hover { color: #10b981; }
        .theme-green .accent-ring:focus { ring-color: #10b981; }
        .theme-green .ui-bg { background-color: #132a23; }

        .theme-purple .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(139, 92, 246, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(124, 58, 237, 0.1), transparent 60%); }
        .theme-purple .accent-bg { background-color: #7c3aed; }
        .theme-purple .accent-bg-hover:hover { background-color: #6d28d9; }
        .theme-purple .accent-text { color: #a78bfa; }
        .theme-purple .accent-text-hover:hover { color: #8b5cf6; }
        .theme-purple .accent-ring:focus { ring-color: #8b5cf6; }
        .theme-purple .ui-bg { background-color: #241c33; }

        /* Quill Editor specific styles */
        .ql-container { border: none !important; display: flex; flex-direction: column; height: 100%; }
        .ql-editor {
            flex-grow: 1; /* Allow editor to take available height */
            font-family: 'Lora', serif;
            font-size: 1.125rem;
            line-height: 1.75;
            background-color: #111827;
            color: #D1D5DB;
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto; /* Ensure Quill editor content scrolls */
        }
        .ql-toolbar {
            background-color: #1F2937 !important;
            border-top-left-radius: 8px !important;
            border-top-right-radius: 8px !important;
            border: 1px solid #374151 !important;
            border-bottom: none !important;
        }
        .ql-snow .ql-stroke { stroke: #9CA3AF !important; }
        .ql-snow .ql-picker-label { color: #9CA3AF !important; }
        .ql-snow .ql-picker-options { background-color: #374151 !important; color: #D1D5DB !important; }

        /* Custom scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1F2937; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }

        /* Styles for password toggle */
        .password-input-container {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9CA3AF;
        }

        /* Book Cover Selection Styles */
        .cover-image-wrapper {
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden; /* Ensure border-radius clips content */
        }
        .cover-image-wrapper:hover {
            border-color: #60a5fa; /* Accent color on hover */
        }
        .cover-image-wrapper.selected {
            border-color: #3b82f6; /* Stronger accent color when selected */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); /* Glowing effect */
        }
        .cover-image-wrapper img {
            display: block; /* Remove extra space below image */
        }
        .cover-selection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .cover-image-wrapper.selected .cover-selection-overlay {
            opacity: 1;
        }

        /* Loading spinner for buttons */
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 1em;
            height: 1em;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5em;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom style for dashboard card border based on theme */
        .project-card.theme-border-default { border-color: #2563eb; }
        .project-card.theme-border-red { border-color: #dc2626; }
        .project-card.theme-border-gold { border-color: #f59e0b; }
        .project-card.theme-border-green { border-color: #059669; }
        .project-card.theme-border-purple { border-color: #7c3aed; }

    </style>
</head>
<body class="text-gray-200">

    <!-- Main Application Container -->
    <div id="app-container" class="h-screen flex flex-col"></div>

    <!-- Notification & Modal Containers -->
    <div id="notification-container" class="fixed bottom-20 right-5 z-50"></div>
    <div id="modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4"></div>

    <!-- Theme Switcher (Global) -->
    <div id="theme-switcher" class="fixed bottom-4 right-4 bg-gray-900/80 backdrop-blur-sm p-3 rounded-xl border border-gray-700 shadow-lg">
        <div class="flex space-x-2">
            <button data-theme="theme-default" class="theme-button w-6 h-6 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-offset-gray-900 ring-white" title="Default Blue"></button>
            <button data-theme="theme-red" class="theme-button w-6 h-6 rounded-full bg-red-500" title="Redeemer's Red"></button>
            <button data-theme="theme-gold" class="theme-button w-6 h-6 rounded-full bg-amber-400" title="Golden Light"></button>
            <button data-theme="theme-green" class="theme-button w-6 h-6 rounded-full bg-emerald-500" title="Graceful Green"></button>
            <button data-theme="theme-purple" class="theme-button w-6 h-6 rounded-full bg-violet-500" title="Royal Purple"></button>
        </div>
    </div>

    <!-- ALL APPLICATION JAVASCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut as firebaseSignOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, linkWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, serverTimestamp, query, onSnapshot, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVsziM6I1QEU22YNPGTwLvN0EuW4k2SiY",
            authDomain: "christian-author-app-54c4d.firebaseapp.com",
            projectId: "christian-author-app-54c4d",
            storageBucket: "christian-author-app-54c4d.firebasestorage.app",
            messagingSenderId: "386312831448",
            appId: "1:386312831448:web:80999eae638bbed28572ad"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        //======================================================================
        // --- CONSOLIDATED JAVASCRIPT MODULES ---
        //======================================================================

        // --- auth.js content ---
        let authInstance;
        function initializeAuth(config) { if (!authInstance) { const app = initializeApp(config); authInstance = getAuth(app); } return authInstance; }
        function onAuth(callback) { return onAuthStateChanged(authInstance, callback); }
        async function signInAnon() {
            try {
                const result = await signInAnonymously(authInstance);
                showNotification('Signed in as guest!', 'success');
                return result;
            } catch (e) {
                console.error("Anon sign-in failed:", e);
                showNotification(`Guest sign-in failed: ${e.message}`, 'error');
            }
        }
        async function signOut() {
            try {
                await firebaseSignOut(authInstance);
                showNotification('Signed out successfully.', 'info');
            } catch (e) {
                console.error("Sign-out failed:", e);
                showNotification(`Sign-out failed: ${e.message}`, 'error');
            }
        }

        // New authentication functions
        async function signUpWithEmail(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(authInstance, email, password);
                showNotification('Account created successfully!', 'success');
                return userCredential.user;
            } catch (e) {
                console.error("Sign-up failed:", e);
                showNotification(`Sign-up failed: ${e.message}`, 'error');
                return null;
            }
        }

        async function signInWithEmail(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(authInstance, email, password);
                showNotification('Logged in successfully!', 'success');
                return userCredential.user;
            } catch (e) {
                console.error("Login failed:", e);
                showNotification(`Login failed: ${e.message}`, 'error');
                return null;
            }
        }

        async function linkGuestAccount(email, password) {
            try {
                const credential = EmailAuthProvider.credential(authInstance.currentUser.email, password); // Use current user's email if available
                await linkWithCredential(authInstance.currentUser, credential);
                showNotification('Guest account linked successfully!', 'success');
                return true;
            } catch (e) {
                console.error("Linking guest account failed:", e);
                showNotification(`Linking account failed: ${e.message}`, 'error');
                return false;
            }
        }

        // --- firestore.js content ---
        let dbInstance;
        let storageInstance; // Declare storage instance globally for access
        function initializeDb(config) {
            if (!dbInstance) {
                const app = initializeApp(config);
                dbInstance = getFirestore(app);
                storageInstance = getStorage(app); // Initialize Storage
            }
            return dbInstance;
        }
        function getProjectsCollection(userId) { return collection(dbInstance, `artifacts/${appId}/users/${userId}/projects`); }
        async function createProject(userId, data) {
            try {
                const projectRef = await addDoc(getProjectsCollection(userId), { ...data, createdAt: serverTimestamp(), lastModified: serverTimestamp() });
                const sectionsCollection = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectRef.id}/sections`);
                const emptyContent = JSON.stringify({ ops: [{ insert: '\n' }] });
                // Added new 'metadata' section at order 0
                await setDoc(doc(sectionsCollection, 'metadata'), { title: 'Project Metadata', content: JSON.stringify({ authorName: '', copyrightYear: '', publisher: '', isbn: '', seriesName: '', seriesNumber: '', lccn: '' }), order: 0 }); // Added LCCN
                await setDoc(doc(sectionsCollection, 'brainstorming'), { title: 'Brainstorming', content: emptyContent, order: 1 });
                await setDoc(doc(sectionsCollection, 'character_development'), { title: 'Character Development', content: emptyContent, order: 2 });
                await setDoc(doc(sectionsCollection, 'world_building'), { title: 'World-building', content: emptyContent, order: 3 });
                await setDoc(doc(sectionsCollection, 'outline'), { title: 'Outline', content: emptyContent, order: 4 });
                await setDoc(doc(sectionsCollection, 'book_cover'), { title: 'Book Cover', content: '', order: 5 });
                // Add new sections for Front and Back Matter
                await setDoc(doc(sectionsCollection, 'front_matter'), { title: 'Front Matter', content: emptyContent, order: 6 });
                await setDoc(doc(sectionsCollection, 'back_matter'), { title: 'Back Matter', content: emptyContent, order: 7 });
                await setDoc(doc(sectionsCollection, 'chapter_1'), { title: 'Chapter 1', content: emptyContent, order: 8 }); // Adjust order for chapters
                return projectRef.id;
            } catch (e) { console.error("Error creating project:", e); showNotification(`Error creating project: ${e.message}`, 'error'); }
        }
        async function addChapter(userId, projectId, chapterNumber) {
             try {
                const sectionsCollection = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`);
                const newChapterId = `chapter_${chapterNumber}`;
                const emptyContent = JSON.stringify({ ops: [{ insert: '\n' }] });
                // Adjust order to be after existing fixed sections (metadata, brainstorming, char_dev, world_building, outline, book_cover, front_matter, back_matter)
                // The order for chapter_1 is 8, so subsequent chapters should follow that.
                await setDoc(doc(sectionsCollection, newChapterId), { title: `Chapter ${chapterNumber}`, content: emptyContent, order: 7 + chapterNumber });
                return true;
            } catch (e) { console.error("Error adding chapter:", e); showNotification(`Error adding chapter: ${e.message}`, 'error'); return false; }
        }
        async function getProjects(userId) { try { const qSnapshot = await getDocs(getProjectsCollection(userId)); const projects = []; qSnapshot.forEach(d => projects.push({ id: d.id, ...d.data() })); projects.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); return projects; } catch (e) { console.error("Error fetching projects:", e); showNotification(`Error fetching projects: ${e.message}`, 'error'); return []; } }
        async function getProject(userId, projectId) { try { const docRef = doc(getProjectsCollection(userId), projectId); const docSnap = await getDoc(docRef); return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null; } catch (e) { console.error("Error fetching project:", e); showNotification(`Error fetching project: ${e.message}`, 'error'); } }
        async function getProjectSections(userId, projectId) { try { const sectionsRef = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`); const q = query(sectionsRef, orderBy("order")); const qSnapshot = await getDocs(q); const sections = []; qSnapshot.forEach(d => sections.push({ id: d.id, ...d.data() })); return sections; } catch (e) { console.error("Error fetching sections:", e); showNotification(`Error fetching sections: ${e.message}`, 'error'); return []; } }
        async function getSection(userId, projectId, sectionId) { try { const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, sectionId); const docSnap = await getDoc(sectionRef); return docSnap.exists() ? docSnap.data() : null; } catch (e) { console.error("Error getting section:", e); showNotification(`Error getting section: ${e.message}`, 'error'); return null; } }
        async function updateSectionContent(userId, projectId, sectionId, content) { try { const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, sectionId); await updateDoc(sectionRef, { content }); const projectRef = doc(getProjectsCollection(userId), projectId); await updateDoc(projectRef, { lastModified: serverTimestamp() }); } catch (e) { console.error("Error updating section:", e); showNotification(`Error updating section: ${e.message}`, 'error'); } }
        async function updateProjectCover(userId, projectId, coverUrl) { // New function to update project cover
            try {
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { bookCoverUrl: coverUrl, lastModified: serverTimestamp() });
                showNotification('Book cover saved successfully!', 'success');
            } catch (e) {
                console.error("Error updating project cover:", e);
                showNotification(`Error saving cover: ${e.message}`, 'error');
            }
        }
        // New function to update project title
        async function updateProjectTitle(userId, projectId, newTitle) {
            try {
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { title: newTitle, lastModified: serverTimestamp() });
                showNotification('Project title updated!', 'success');
            } catch (e) {
                console.error("Error updating project title:", e);
                showNotification(`Error updating project title: ${e.message}`, 'error');
            }
        }
        // New function to update project metadata
        async function updateProjectMetadata(userId, projectId, metadata) {
            try {
                const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, 'metadata');
                await updateDoc(sectionRef, { content: JSON.stringify(metadata) });
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { lastModified: serverTimestamp() });
                showNotification('Project metadata saved!', 'success');
            } catch (e) {
                console.error("Error updating project metadata:", e);
                showNotification(`Error saving metadata: ${e.message}`, 'error');
            }
        }

        async function deleteProject(userId, projectId) {
            try {
                await deleteDoc(doc(getProjectsCollection(userId), projectId));
                showNotification('Project deleted.', 'success');
            } catch (e) {
                console.error("Error deleting project:", e);
                showNotification(`Error deleting project: ${e.message}`, 'error');
            }
        }

        // --- utils.js content ---
        function debounce(func, wait) { let timeout; return function(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
        function showNotification(message, type = 'info', duration = 3000) { const container = document.getElementById('notification-container'); if (!container) return; const notification = document.createElement('div'); let bgColor; switch(type){ case 'success': bgColor='bg-green-500/90 border-green-400'; break; case 'error': bgColor='bg-red-500/90 border-red-400'; break; default: bgColor='bg-blue-500/90 border-blue-400'; break; } notification.className = `p-4 rounded-lg shadow-xl text-white ${bgColor} border mb-4 opacity-0 transition-all duration-500`; notification.textContent = message; container.appendChild(notification); setTimeout(() => notification.classList.remove('opacity-0'), 10); setTimeout(() => { notification.classList.add('opacity-0'); notification.addEventListener('transitionend', () => notification.remove()); }, duration); }
        function showModal(title, contentHtml, onConfirm, confirmText = 'Confirm', showCancel = true) {
            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) return;
            modalContainer.innerHTML = `<div class="bg-gray-800 text-gray-200 rounded-lg shadow-2xl w-full max-w-lg p-6 border border-gray-700"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-lora font-bold">${title}</h2><button id="modal-close-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button></div><div id="modal-content" class="max-h-[70vh] overflow-y-auto">${contentHtml}</div><div class="mt-6 flex justify-end space-x-4">${showCancel ? '<button id="modal-cancel-btn" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 transition-colors">Cancel</button>' : ''}<button id="modal-confirm-btn" type="submit" class="py-2 px-4 rounded-lg accent-bg accent-bg-hover transition-colors font-semibold">${confirmText}</button></div></div>`;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            const closeModal = () => { modalContainer.classList.add('hidden'); modalContainer.classList.remove('flex'); modalContainer.innerHTML = ''; };
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            if (showCancel) {
                document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
            }
            // Reverted: Attach onConfirm directly to the button click for simplicity,
            // as the form submit listener was causing issues.
            document.getElementById('modal-confirm-btn').addEventListener('click', async () => {
                const form = modalContainer.querySelector('form');
                if (form && !form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await onConfirm();
                closeModal();
            });

            // Add password toggle functionality after modal content is rendered
            modalContainer.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const passwordInput = toggle.previousElementSibling; // The input field is the previous sibling
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    toggle.querySelector('i').classList.toggle('fa-eye');
                    toggle.querySelector('i').classList.toggle('fa-eye-slash');
                });
            });
        }

        // Helper function to strip common Markdown bold/italic markers and HTML tags
        function stripMarkdownAndHtml(text) {
            // Remove Markdown bold (**) and italic (* or _)
            let cleanedText = text.replace(/\*\*(.*?)\*\*/g, '$1'); // bold
            cleanedText = cleanedText.replace(/\*(.*?)\*/g, '$1');   // italic (single asterisk)
            cleanedText = cleanedText.replace(/_(.*?)_/g, '$1');   // italic (underscore)

            // Remove common HTML tags (basic approach, not for complex HTML)
            cleanedText = cleanedText.replace(/<[^>]*>/g, '');

            return cleanedText.trim();
        }


        // --- aiService.js content ---
        const API_KEY = "AIzaSyCVsziM6I1QEU22YNPGTwLvN0EuW4k2SiY"; // User's provided API Key
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`; // Changed to gemini-2.5-flash
        // CORRECTED: Use the stable imagegeneration model
        const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`; // Corrected Imagen model

        // Global variable to store AI style preference
        let aiStylePreference = "";

        // Knowledge base for character types
        const characterTypesKnowledge = `
Characters are the lifeblood of fiction, driving the plot and engaging readers. While every character should feel unique and real, they often fall into certain categories or roles within a manuscript. Here's a breakdown of different types of characters, often considered in terms of their role, dynamism, and archetypal qualities:
I. By Role in the Narrative:
Protagonist: The central character of the story. The plot usually revolves around their journey, goals, and development. Readers are meant to invest in and care about them. There can be multiple protagonists in a story.
Examples: Katniss Everdeen (The Hunger Games), Harry Potter (Harry Potter series), Elizabeth Bennet (Pride and Prejudice).
Antagonist: The character or force that opposes the protagonist and creates conflict. They don't always have to be "evil"; sometimes they simply represent an opposing viewpoint or obstacle.
Examples: Lord Voldemort (Harry Potter series), President Coriolanus Snow (The Hunger Games), Mr. Darcy (initially, in Pride and Prejudice). An antagonist can also be an inanimate force like nature or society.
Deuteragonist: The second most important character, often serving as a close ally or companion to the protagonist. They might offer a different perspective or have their own subplot.
Examples: Dr. John Watson (Sherlock Holmes), Samwise Gamgee (Lord of the Rings).
Confidant(e): A character in whom the protagonist trusts and shares their thoughts and feelings. This allows the author to reveal the protagonist's inner world to the reader without relying solely on internal monologue.
Examples: Hermione Granger (Harry Potter series), Albus Dumbledore (Harry Potter series).
Love Interest: The romantic counterpart to the protagonist. Their relationship often impacts the protagonist's development and the overall plot.
Examples: Peeta Mellark (The Hunger Games), Mr. Darcy (later, in Pride and Prejudice).
Mentor: A wise and experienced character who guides, advises, and supports the protagonist. They often provide knowledge, training, or a moral compass.
Examples: Obi-Wan Kenobi (Star Wars), Albus Dumbledore (Harry Potter series).
Foil: A character who highlights the qualities (often contrasting ones) of another character, usually the protagonist, through comparison. They aren't necessarily antagonists.
Examples: Draco Malfoy to Harry Potter (highlighting Harry's inherent goodness), Effie Trinket to Katniss Everdeen (highlighting Katniss's grounded nature).
Sidekick: A character who supports the protagonist, often offering comic relief, practical assistance, or a loyal friendship.
Examples: Ron Weasley (Harry Potter series), Samwise Gamgee (Lord of the Rings).
Tertiary/Minor Characters (or Extras): Background characters who populate the story's world and add realism. They may have brief appearances and serve specific, often limited, functions.
II. By Dynamism and Complexity:
Dynamic Character: A character who undergoes significant internal change, growth, or transformation throughout the story due to the events they experience.
Examples: Ebenezer Scrooge (A Christmas Carol), Harry Potter (as he matures throughout the series).
Static Character: A character who remains largely the same throughout the story, without significant internal change. They often serve to highlight the changes in dynamic characters or maintain consistency in the narrative.
Examples: Many side characters or minor antagonists who have a fixed role.
Round Character: A complex and well-developed character with multiple personality traits, motivations, and sometimes contradictions, making them feel realistic and multifaceted. Dynamic characters are usually round.
Flat Character: A less developed character, often defined by one or two dominant traits. They typically serve a specific purpose in the plot or to represent a stereotype, rather than undergoing deep personal change. Stock characters (see below) are often flat.
Stock Character: A stereotypical character that is instantly recognizable due to recurring traits in various stories and genres (e.g., the "mad scientist," the "tough detective," the "damsel in distress"). While they can be clich√©s if not handled well, they can also be useful for quickly establishing a type of character.
Symbolic Character: A character who represents a larger idea, theme, or concept within the story, often beyond their literal role.
Example: Boo Radley in To Kill a Mockingbird can symbolize the hidden goodness in society or the innocence destroyed by prejudice.
III. By Archetype (based on Jungian psychology and recurring patterns in storytelling):
Archetypes are universally recognizable character types that resonate across cultures and time periods. While a character's role might be "protagonist," their archetype might be "The Hero."
Some common archetypes include:
The Hero: Embarks on a journey, faces challenges, and undergoes transformation to achieve a goal. (Often the protagonist).
The Innocent: Pure, optimistic, and seeks happiness. Vulnerable but can inspire others.
The Sage/Mentor: Possesses wisdom, knowledge, and guides others.
The Explorer: Driven by curiosity and a desire to push boundaries, seeking discovery and self-improvement.
The Ruler: Seeks control and power, often responsible for order or chaos.
The Creator: A visionary who brings new things into existence (art, ideas, structures).
The Caregiver: Nurturing, selfless, and protective of others.
The Everyman/Everywoman: Relatable and ordinary, representing the common person.
The Lover: Guided by the heart, valuing connection, passion, and sensuality.
The Jester/Trickster: Provides comic relief, challenges the status quo, and can be mischievous or insightful.
The Rebel/Outlaw: Defies societal norms and seeks revolution or freedom.
The Magician: Possesses special knowledge or abilities, often transforming things.
The Shadow: Represents the dark side of human nature, often the antagonist or an internal struggle within the protagonist.
Understanding these different types of characters can help authors create a diverse and compelling cast, ensuring that each character serves a purpose in advancing the plot, exploring themes, and engaging the reader.
`;

        async function callGemini(contents) {
            try {
                // Show loading spinner for Gemini calls
                document.getElementById('ai-output').innerHTML = `<div class="flex items-center justify-center py-4"><div class="loading-spinner"></div><span class="ml-2">Generating...</span></div>`;

                // Prepend style preference to the prompt
                const finalContents = contents.map(item => {
                    if (item.parts && item.parts.length > 0 && item.parts[0].text) {
                        return {
                            ...item,
                            parts: [{ text: `AI Style Preference: ${aiStylePreference}\n\n${item.parts[0].text}` }]
                        };
                    }
                    return item;
                });

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: finalContents })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("AI API Error Response:", errorData);
                    // Provide a more user-friendly message based on common API errors
                    let errorMessage = `API request failed with status ${response.status}.`;
                    if (response.status === 403) {
                        errorMessage += " This usually means the API is not enabled for your Google Cloud project or your API key has insufficient permissions.";
                    } else if (response.status === 429) {
                        errorMessage += " You've exceeded your API quota. Please try again later.";
                    } else if (errorData && errorData.error && errorData.error.message) {
                        errorMessage += ` Details: ${errorData.error.message}`;
                    } else {
                        errorMessage += ` Details: ${JSON.stringify(errorData.error || errorData)}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("AI Error: Unexpected response structure:", result);
                    return "Error: Could not generate content (unexpected AI response).";
                }
            } catch (e) {
                console.error("Error calling Gemini API:", e);
                showNotification(`AI call failed: ${e.message}`, 'error');
                return `Error: API call failed: ${e.message}`;
            } finally {
                // Clear loading spinner, but allow specific functions to re-render output
                // document.getElementById('ai-output').innerHTML = '';
            }
        }


        async function generateConcepts(idea) { const prompt = `You are an AI story consultant. Based on the user's basic idea, generate a numbered list of 5 distinct core concept ideas for a new book. Each concept should be a single, concise paragraph. The tone should be encouraging and creative.\n\nBasic Idea: "${idea}"`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function generateOutlineBeats(context) { const prompt = `You are an AI outliner for an author. Based on the provided project details (synopsis, characters, world-building), generate a detailed chapter-by-chapter outline with key beats for each chapter. The outline should be well-structured and provide a clear roadmap for the story.\n\nProject Details:\n---\n${context}\n---\n\nGenerate the chapter-by-chapter outline:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function generateCharacterProfiles(context) {
            const prompt = `You are an AI character developer. Based on the provided project details (synopsis), generate a numbered list of 5 distinct character profile ideas. Each profile should include a name, a brief backstory, core motivations, personality quirks, and **explicitly identify what type of character they are based on the following taxonomy (By Role, By Dynamism and Complexity, and By Archetype).**

${characterTypesKnowledge}

Project Details:
---
${context}
---

Generate 5 character profiles:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateWorldPrompts(context) { const prompt = `You are an AI world-builder. Based on the provided project details (synopsis, characters), generate a numbered list of 5 distinct world-building element ideas. These could include magic systems, futuristic technologies, societal structures, or key historical events relevant to the story.\n\nProject Details:\n---\n${context}\n---\n\nGenerate 5 world-building prompts:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function suggestAlternatives(selectedText, context) { const prompt = `You are an AI thesaurus and editor. Given the following selected word/phrase and its surrounding context, provide a numbered list of 5 alternative words or short phrases that would fit well.\n\nContext:\n---\n${context}\n---\n\nSelected Text: "${selectedText}"\n\nProvide 5 alternatives:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function suggestScripture(selectedText, context) { const prompt = `You are a theological assistant specializing in the NIV Bible. Based on the following selected text, suggest a numbered list of 3 relevant NIV Bible scriptures. For each, provide the reference and the full verse text.\n\nSelected Text for Context:\n---\n${context}\n---\n\nSuggest 3 relevant NIV scriptures:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function suggestPOVs(context) { const prompt = `You are an AI writing coach. Based on the story's synopsis, suggest a numbered list of 3 potential Point of View (POV) & Voice choices (e.g., First Person, Third Person Limited). For each, briefly explain how that choice would shape the narration and affect the reader's experience.\n\nSynopsis:\n---\n${context}\n---\n\nGenerate 3 POV & Voice options:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function suggestStructures(context) { const prompt = `You are an AI writing coach. Based on the story's synopsis, suggest a numbered list of 3 potential structural templates (e.g., Three-Act Structure, Hero's Journey, Fichtean Curve). For each, briefly explain why that structure would be a good fit for the story.\n\nSynopsis:\n---\n${context}\n---\n\nSuggest 3 structural templates:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function analyzeChapter(chapterText, context) { const prompt = `You are an AI developmental editor. Review the following book chapter in the context of the provided project details. Provide high-level feedback on Pacing, Plot Progression, and Character Consistency. The feedback should be constructive and encouraging.\n\nProject Details:\n---\n${context}\n---\n\nChapter Text to Analyze:\n---\n${chapterText}\n---\n\nProvide your analysis:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function proofreadChapter(chapterText) { const prompt = `You are an AI proofreader. Review the following text and provide a numbered list of suggested corrections for any grammatical errors, spelling mistakes, or punctuation issues. For each suggestion, clearly state the original text and the proposed change.\n\nText to Proofread:\n---\n${chapterText}\n---\n\nSuggestions:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function suggestYouthPhrases(selectedText, context) { const prompt = `You are an AI dialogue coach. Given the following selected text (likely dialogue) and its surrounding context, provide a numbered list of 5 alternative phrases that sound more contemporary or like common youth slang. Ensure suggestions are appropriate and fit a Christian context if possible.\n\nContext:\n---\n${context}\n---\n\nSelected Text: "${selectedText}"\n\nProvide 5 youth phrase alternatives:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); } // New AI function
        async function generateCoverConcepts(context) { const prompt = `You are an AI art director. Based on the provided book synopsis, generate a numbered list of 3 distinct and compelling visual concepts for a book cover. Each concept should be a short, descriptive paragraph that could be used as a prompt for an AI image generator.\n\nSynopsis:\n---\n${context}\n---\n\nGenerate 3 book cover concepts:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function generateNext(currentText, context) { // Changed 'style' to 'context' for clarity
            const prompt = `Continue the following text, keeping in mind the following project context:\n\n${context}\n\nProvide the next paragraph or section to logically follow the existing content. Ensure the tone and style are consistent with the provided context.
            Current Text:
            ---
            ${currentText}
            ---
            Continue:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        // New AI function to generate titles
        async function generateTitles(context) {
            const prompt = `You are an AI creative assistant for authors. Based on the following synopsis or brainstorming content, generate a numbered list of 5 distinct and compelling title suggestions for a Christian book. Titles should be concise and impactful, reflecting the themes and genre.\n\nContent:\n---\n${context}\n---\n\nGenerate 5 title suggestions:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }


        // --- views.js content ---
        const appContainer = document.getElementById('app-container');
        let currentUserId = null;
        // This variable will store the current selection range for 'Alternative Words' and 'Suggested Youth Phrases'
        let currentSelectionRange = null;
        let currentTheme = 'theme-default'; // Track current theme for dynamic borders

        // Function to render the Help modal
        function renderHelpModal() {
            const helpContent = `
                <div class="space-y-4 text-gray-300 overflow-y-auto max-h-[70vh] pr-4">
                    <p class="text-lg font-semibold text-white">Welcome to Author's Aid!</p>
                    <p>Your AI Co-author is here to assist you through every step of your manuscript writing journey, grounded in Christian values.</p>

                    <h4 class="text-md font-semibold text-white mt-4">Getting Started:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Sign Up/Login:</strong> Create an account to save your projects permanently across sessions. You can also continue as a guest, but guest data may not persist.</li>
                        <li><strong>New Project:</strong> From the Dashboard, click "+ New Project" to start a new book. Provide a title and select its type, genre, and target audience.</li>
                        <li><strong>Dashboard:</strong> View all your existing projects, open them, or delete them.</li>
                    </ul>

                    <h4 class="text-md font-semibold text-white mt-4">Using the Editor:</h4>
                    <p>The main editor screen is where your writing and AI tools come together. It's divided into three main panels:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Left Sidebar:</strong> Navigate between different sections of your project (Brainstorming, Character Development, Outline, Chapters, Book Cover, etc.).</li>
                        <li><strong>Center Panel:</strong> This is your primary writing area, powered by Quill.js. Type directly here, and your progress is automatically saved.</li>
                        <li><strong>Right Sidebar (AI Co-Author):</strong> This is where you interact with the AI tools.</li>
                    </ul>

                    <h4 class="text-md font-semibold text-white mt-4">AI Co-Author Features:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>AI Style Preference:</strong> Use the text area at the top to describe the writing style or tone you'd like the AI to adopt (e.g., "Write in a formal, encouraging tone," "Use concise, impactful language"). This preference is applied to all AI-generated content.</li>
                        <li><strong>Generate Synopsis Ideas (Brainstorming):</strong> Provide a basic idea in the editor, and the AI will generate core concept ideas for your book.</li>
                        <li><strong>POV & Voice (Brainstorming):</strong> Based on your synopsis, the AI can suggest different points of view and narrative voices.</li>
                        <li><strong>Structural Template (Brainstorming):</strong> Get AI-generated structural ideas (e.g., Three-Act Structure) for your story.</li>
                        <li><strong>Generate Character Profiles (Character Development):</strong> The AI helps you create detailed character ideas based on your story's concept.</li>
                        <li><strong>Generate Chapter Beats (Outline):</strong> Get a detailed chapter-by-chapter outline based on your project's synopsis, characters, and world-building.</li>
                        <li><strong>Generate Next (Chapters):</strong> Overcome writer's block! Click this button in any chapter to have the AI generate the next section of text, using your existing content and project context.</li>
                        <li><strong>Analyze Chapter (Chapters):</strong> Get high-level feedback on pacing, plot progression, and character consistency for your chapter.</li>
                        <li><strong>Proofread Chapter (Chapters):</strong> Receive suggested corrections for grammar, spelling, and punctuation. Click on a suggestion to apply the fix directly to your text.</li>
                        <li><strong>Suggest Youth Phrases (Chapters):</strong> Select text (e.g., dialogue) and get contemporary youth slang suggestions, suitable for a Christian context.</li>
                        <li><strong>Generate Cover Concepts (Book Cover):</strong> Get descriptive prompts for an AI image generator based on your book's synopsis. Click a concept to generate a visual book cover.</li>
                        <li><strong>Select Book Cover (Book Cover):</strong> After generating images, click on your preferred cover to highlight it and save its URL to your project.</li>
                    </ul>

                    <h4 class="text-md font-semibold text-white mt-4">Exporting Your Work:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Export Project:</strong> Use the "Export Project" button in the footer to download your entire manuscript as a clean HTML file. This file is suitable for importing into professional book formatting software for eBook and print preparation.</li>
                    </ul>

                    <p class="text-sm text-gray-400 mt-4">Remember that AI generation relies on external services. If you encounter "API call failed" errors, please check your Google Cloud Project settings for API enablement and quotas.</p>
                </div>
            `;
            showModal('How to Use Author\'s Aid', helpContent, () => {}, 'Close', false); // No confirm button, just close
        }


        function renderHeader(isLoggedIn, inEditor = false, userId = '') {
            let navLinksHtml = '';
            let userDisplay = '';
            if (isLoggedIn) {
                userDisplay = `<span class="text-gray-400 text-sm">${userId.substring(0, 8)}...</span>`; // Display truncated user ID
                navLinksHtml = `
                    <a href="#" id="help-link" class="accent-text-hover transition-colors text-sm">Help</a>
                    ${userDisplay}
                    <button id="sign-out-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md text-sm transition-colors">Logout</button>
                `;
            }
             const dashboardLink = inEditor ? `<a href="#" data-route="dashboard" class="nav-button text-sm accent-text-hover flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Dashboard</a>` : '';

            const headerHtml = `
                <header class="ui-bg p-4 border-b border-gray-700 flex-shrink-0">
                    <div class="container mx-auto flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            ${dashboardLink}
                            <h1 class="text-xl font-bold text-white">Author's Aid</h1>
                        </div>
                        <nav class="flex space-x-4 items-center">
                            ${navLinksHtml}
                        </nav>
                    </div>
                </header>`;

            const headerElement = document.createElement('div');
            headerElement.innerHTML = headerHtml;

            const signOutBtn = headerElement.querySelector('#sign-out-btn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await signOut();
                    navigateTo('landing');
                });
            }
            // Add event listener for the Help link
            const helpLink = headerElement.querySelector('#help-link');
            if (helpLink) {
                helpLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderHelpModal();
                });
            }

            return headerElement;
        }

        async function handleSignUpClick(e) {
            e.preventDefault();
            const content = `
                <form id="signup-form">
                    <p class="text-gray-400 mb-4">Create an account to save your work permanently.</p>
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="email" name="email" required autocomplete="email" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                    </div>
                    <div class="password-input-container">
                        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="password" name="password" required minlength="6" autocomplete="new-password" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        <span class="password-toggle" data-target="password"><i class="fas fa-eye"></i></span>
                        <p class="text-xs text-gray-400 mt-1">Minimum 6 characters.</p>
                    </div>
                </form>
            `;
            showModal('Sign Up for Free', content, async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                if (email && password) {
                    const user = authInstance.currentUser;
                    if (user && user.isAnonymous) {
                        // Link anonymous account
                        const success = await linkGuestAccount(email, password);
                        if (success) {
                            navigateTo('dashboard');
                        }
                    } else {
                        // Create new account
                        const newUser = await signUpWithEmail(email, password);
                        if (newUser) {
                            navigateTo('dashboard');
                        }
                    }
                }
            }, 'Sign Up');
        }

        async function handleLoginClick(e) {
            e.preventDefault();
            const content = `
                <form id="login-form">
                    <p class="text-gray-400 mb-4">Log in to access your saved projects.</p>
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="login-email" name="email" required autocomplete="email" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                    </div>
                    <div class="password-input-container">
                        <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="login-password" name="password" required autocomplete="current-password" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        <span class="password-toggle" data-target="login-password"><i class="fas fa-eye"></i></span>
                    </div>
                </form>
            `;
            showModal('Log In', content, async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (email && password) {
                    const user = await signInWithEmail(email, password);
                    if (user) {
                        navigateTo('dashboard');
                    }
                }
            }, 'Login');
        }

        function renderLandingPage() {
            document.body.style.overflow = 'auto'; // Allow scrolling on landing page
            document.getElementById('theme-switcher').style.display = 'block';
            appContainer.innerHTML = `
                <div class="gradient-bg">
                    <header class="absolute top-0 left-0 w-full z-10 p-4">
                        <div class="container mx-auto flex justify-between items-center">
                            <h1 class="text-2xl font-bold font-lora text-white">Author's Aid</h1>
                            <nav class="hidden md:flex space-x-6 items-center">
                                <a href="#features" class="accent-text-hover transition-colors">Features</a>
                                <a href="#" id="sign-up-link" class="accent-text-hover transition-colors">Sign Up</a>
                                <a href="#" id="login-link" class="accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg transition-colors">Login</a>
                            </nav>
                        </div>
                    </header>
                    <main class="relative pt-32 pb-20 md:pt-48 md:pb-32">
                        <div class="container mx-auto text-center px-4">
                            <h2 class="text-4xl md:text-6xl font-bold font-lora text-white leading-tight mb-4">Your AI Co-Author, Guided by Faith</h2>
                            <p class="text-lg md:text-xl text-gray-400 max-w-3xl mx-auto mb-8">
                                Welcome, Rene' Stanley. Author's Aid is your personalized writing partner, trained on your unique style and grounded in Christian values. From manuscript to cover, let's bring your next masterpiece to life.
                            </p>
                            <button id="guest-btn" class="accent-bg accent-bg-hover text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 inline-block">Continue as Guest</button>
                        </div>
                    </main>
                    <section id="features" class="py-20 bg-black/30">
                        <div class="container mx-auto px-4"><div class="text-center mb-12"><h3 class="text-3xl md:text-4xl font-bold font-lora">A Tool for Every Step of Your Journey</h3></div>
                        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">AI Co-Author & Ghostwriter</h4><p class="text-gray-400">Trained on your works, the AI learns your voice to help write, edit, and offer suggestions that sound authentically like you.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Multi-Format Support</h4><p class="text-gray-400">Get a tailored roadmap for fiction, non-fiction, devotionals, or Bible studies.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Faith-Based Assistance</h4><p class="text-gray-400">Get suggestions for relevant NIV Bible scriptures and theological insights.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Book Cover Generation</h4><p class="text-gray-400">Generate professional front, spine, and back covers using AI image prompts.
</p></div>
                        </div>
                    </section>
                    <section id="cta" class="py-20 bg-black/30">
                        <div class="container mx-auto text-center px-4">
                            <h3 class="text-3xl md:text-4xl font-bold font-lora text-white mb-4">Ready to Write Your Next Chapter?</h3>
                            <p class="text-lg text-gray-400 max-w-2xl mx-auto mb-8">Sign up today to begin your journey with an AI partner that understands your faith, your voice, and your vision.</p>
                            <div class="max-w-md mx-auto">
                                <form class="flex flex-col sm:flex-row gap-4">
                                    <input type="email" placeholder="Enter your email" class="w-full px-4 py-3 rounded-lg bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 accent-ring" required>
                                    <button type="submit" id="signup-free-btn" class="accent-bg accent-bg-hover text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">Sign Up for Free</button>
                                </form>
                            </div>
                        </div>
                    </section>
                    <footer class="py-8 border-t border-gray-800">
                        <div class="container mx-auto text-center text-gray-500">
                            <p>&copy; 2025 Author's Aid. All Rights Reserved.</p>
                            <p class="mt-2 text-sm">Created with faith for Rene' Stanley.</p>
                        </div>
                    </footer>
                </div>
            `;
            document.getElementById('guest-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                showNotification('Signing in as guest...');
                await signInAnon();
            });
            document.getElementById('signup-free-btn').addEventListener('click', handleSignUpClick);
            document.getElementById('login-link').addEventListener('click', handleLoginClick); // Changed to call handleLoginClick
            document.getElementById('sign-up-link').addEventListener('click', handleSignUpClick);
        }

        async function renderDashboard(userId) {
            currentUserId = userId;
            document.body.style.overflow = 'auto';
            document.getElementById('theme-switcher').style.display = 'block';
            appContainer.innerHTML = '';
            appContainer.appendChild(renderHeader(true, false, userId)); // Pass userId to header
            const mainContent = document.createElement('main');
            mainContent.className = "container mx-auto p-8 flex-grow";
            mainContent.innerHTML = `<div class="text-center text-gray-400">Loading projects...</div>`;
            appContainer.appendChild(mainContent);

            const projects = await getProjects(userId);
            let listHtml = projects.map(p => {
                // Determine the border color class based on the current theme
                const themeBorderClass = `theme-border-${currentTheme.replace('theme-', '')}`;

                return `
                <div class="project-card bg-gray-800 p-4 rounded-lg border-2 ${themeBorderClass} flex flex-col justify-between">
                    <div class="flex items-start mb-2">
                        ${p.bookCoverUrl ? `<img src="${p.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/100x150/1F2937/D1D5DB?text=Image+Load+Error';" class="w-16 h-24 object-cover rounded-md mr-4 shadow-md" alt="Book Cover Thumbnail"/>` : `<img src="https://placehold.co/100x150/1F2937/D1D5DB?text=No+Cover" class="w-16 h-24 object-cover rounded-md mr-4 shadow-md" alt="Placeholder Cover"/>`}
                        <div class="flex-grow">
                            <h3 class="text-xl font-lora font-semibold text-white leading-tight">${stripMarkdownAndHtml(p.title || 'Untitled Project')}</h3>
                            ${p.authorName ? `<p class="text-sm text-gray-400">by ${escapeHtml(p.authorName)}</p>` : ''}
                            <p class="text-xs text-gray-500 mt-1">Edited: ${p.lastModified ? new Date(p.lastModified.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                        </div>
                    </div>
                    <div class="flex mt-4 space-x-2">
                        <button data-route="editor" data-id="${p.id}" class="nav-button flex-grow accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Open</button>
                        <button data-action="delete" data-id="${p.id}" class="bg-gray-600 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">üóëÔ∏è</button>
                    </div>
                </div>`;
            }).join('');

            if (projects.length === 0) {
                listHtml = `<p class="col-span-full text-center text-gray-400">You have no projects yet. Start your first one!</p>`;
            }

            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-lora font-bold text-white">Your Projects</h2>
                    <button id="new-project-btn" class="accent-bg accent-bg-hover text-white font-bold py-2 px-6 rounded-lg text-lg">+ New Project</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    ${listHtml}
                </div>`;

            document.getElementById('new-project-btn').addEventListener('click', handleNewProject);
            mainContent.querySelectorAll('[data-action="delete"]').forEach(btn => btn.addEventListener('click', () => handleDeleteProject(btn.dataset.id)));
        }

        function handleNewProject() {
            const content = `
                <form id="new-project-form">
                    <div class="space-y-4">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Enter your book title (optional)</label>
                            <input type="text" id="title" name="title" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        </div>
                        <div>
                            <label for="bookType" class="block text-sm font-medium text-gray-300 mb-1">Book Type</label>
                            <select id="bookType" name="bookType" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>Fiction</option>
                                <option>Non-Fiction</option>
                                <option>Low Content</option>
                            </select>
                        </div>
                        <div>
                            <label for="genre" class="block text-sm font-medium text-gray-300 mb-1">Genre</label>
                            <select id="genre" name="genre" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>Christian Romance</option>
                                <option>Christian Fantasy</option>
                                <option>Christian Thriller</option>
                                <option>Children's Storybook</option>
                                <option>Devotional</option>
                                <option>Bible Study</option>
                                <option>Memoir</option>
                                <option>Christian Living</option>
                                <option>Theology</option>
                                <option>History</option>
                                <option>Prayer Journal</option>
                                <option>Gratitude Journal</option>
                                <option>Planner</option>
                            </select>
                        </div>
                        <div>
                            <label for="targetAudience" class="block text-sm font-medium text-gray-300 mb-1">Target Audience</label>
                            <select id="targetAudience" name="targetAudience" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>African American Adult</option>
                                <option>African American Young Adult</option>
                                <option>African American Children</option>
                                <option>Adult</option>
                                <option>Young Adult</option>
                                <option>Middle Grade</option>
                                <option>Children</option>
                                <option>All Ages</option>
                            </select>
                        </div>
                    </div>
                </form>
            `;
            showModal('Create a New Project', content, async () => {
                const title = document.getElementById('title').value || 'Untitled Project';
                const bookType = document.getElementById('bookType').value;
                const genre = document.getElementById('genre').value;
                const targetAudience = document.getElementById('targetAudience').value;
                const projectData = { title, bookType, genre, targetAudience };
                const newId = await createProject(currentUserId, projectData);
                if (newId) {
                    navigateTo('editor', { projectId: newId });
                }
            }, 'Create Project');
        }

        function handleDeleteProject(projectId) {
            showModal('Confirm Deletion', '<p>Are you sure you want to permanently delete this project and all its content?</p>', async () => {
                await deleteProject(currentUserId, projectId);
                renderDashboard(currentUserId);
            }, 'Delete');
        }

        async function renderEditor(userId, projectId) {
            currentUserId = userId;
            document.body.style.overflow = 'hidden'; // Prevent global scrollbar on editor page
            document.getElementById('theme-switcher').style.display = 'none'; // Hide global switcher
            appContainer.innerHTML = '';
            appContainer.appendChild(renderHeader(true, true, userId)); // Pass userId to header
            const mainContent = document.createElement('main');
            mainContent.className = "flex flex-grow flex-col h-full min-h-0"; /* Added min-h-0 */
            mainContent.innerHTML = `<div class="text-center text-gray-400">Loading project...</div>`;
            appContainer.appendChild(mainContent);

            const project = await getProject(userId, projectId);
            if (!project) {
                mainContent.innerHTML = `<div class="text-center text-red-400 p-8">Error: Project not found.</div>`;
                return;
            }

            mainContent.innerHTML = `
                <div class="flex flex-grow overflow-hidden"> <!-- Changed to overflow-hidden to contain internal scrolling -->
                    <div id="left-sidebar" class="w-2/12 bg-gray-800 p-4 border-r border-gray-700 flex flex-col overflow-y-auto"></div>
                    <div id="center-panel" class="w-7/12 p-8 flex flex-col overflow-y-auto bg-[#111827]">
                        <h3 id="project-main-title" class="text-3xl font-lora font-bold mb-4 text-white">${stripMarkdownAndHtml(project.title || 'Untitled Page')}</h3> <!-- Updated to display project title, stripped markdown -->
                        <div id="editor-container" class="flex-grow relative flex flex-col"> <!-- Added flex flex-col -->
                           <div id="editor-toolbar"></div>
                           <div id="editor" class="flex-grow"></div> <!-- Removed h-full, added flex-grow -->
                        </div>
                         <div id="cover-display-container" class="hidden flex-grow relative items-center justify-center"></div>
                         <div id="metadata-form-container" class="hidden flex-grow relative items-center justify-center p-4"></div>
                    </div>
                    <div id="right-sidebar" class="w-3/12 bg-gray-800 p-4 border-l border-gray-700 flex flex-col overflow-y-auto"></div> <!-- Added flex flex-col -->
                </div>
            `;

            const editorFooter = document.createElement('footer');
            editorFooter.className = "ui-bg p-4 border-t border-gray-700 flex-shrink-0"; /* Added flex-shrink-0 */
            editorFooter.innerHTML = `
                <div class="container mx-auto flex justify-between items-center">
                    <button id="add-chapter-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">+ New Chapter</button>
                    <button id="export-project-btn" class="accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Export Project</button>
                    <div class="flex space-x-2 items-center">
                         <!-- Theme buttons are removed from here in editor view -->
                    </div>
                </div>
            `;
            appContainer.appendChild(editorFooter);

            await setupEditorFunctionality(userId, projectId, project);
        }

        async function setupEditorFunctionality(userId, projectId, project) {
            const projectMainTitle = document.getElementById('project-main-title'); // Renamed from sectionTitle
            const leftSidebar = document.getElementById('left-sidebar');
            const rightSidebar = document.getElementById('right-sidebar');
            const editorContainer = document.getElementById('editor-container');
            const coverDisplayContainer = document.getElementById('cover-display-container');
            const metadataFormContainer = document.getElementById('metadata-form-container'); // Get metadata container

            let activeSectionId = 'brainstorming';
            let editor;
            let sections = [];

            const renderSidebar = () => {
                // Update the project object to ensure the latest cover URL is used
                getProject(userId, projectId).then(updatedProject => {
                    if (updatedProject) {
                        project.bookCoverUrl = updatedProject.bookCoverUrl;
                        project.title = updatedProject.title; // Also update title in case it was changed
                    }

                    leftSidebar.innerHTML = `
                        <div class="flex flex-col items-center mb-4">
                            ${project.bookCoverUrl ? `<img src="${project.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/90x135/1F2937/D1D5DB?text=Cover';" class="w-[90px] h-[135px] object-cover rounded-md shadow-md mb-2" alt="Book Cover Thumbnail"/>` : `<img src="https://placehold.co/90x135/1F2937/D1D5DB?text=No+Cover" class="w-[90px] h-[135px] object-cover rounded-md shadow-md mb-2" alt="Placeholder Cover"/>`}
                            <!-- Removed h2 for project title from here -->
                        </div>
                        <nav id="project-sections" class="flex flex-col space-y-2 flex-grow overflow-y-auto">
                            ${sections.map(s => `<a href="#" data-section-id="${s.id}" class="section-link p-2 rounded-md hover:bg-gray-700 transition-colors ${s.id === activeSectionId ? 'bg-blue-600 text-white' : ''}">${s.title}</a>`).join('')}
                        </nav>
                    `;
                    leftSidebar.querySelectorAll('.section-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            activeSectionId = e.target.dataset.sectionId;
                            loadSection(activeSectionId);
                        });
                    });
                });
            };

            document.getElementById('add-chapter-btn').addEventListener('click', async () => {
                const chapterCount = sections.filter(s => s.id.startsWith('chapter_')).length;
                const success = await addChapter(userId, projectId, chapterCount + 1);
                if(success) {
                    sections = await getProjectSections(userId, projectId);
                    renderSidebar();
                    showNotification(`Chapter ${chapterCount + 1} added!`, 'success');
                }
            });

            // Export Project Functionality
            document.getElementById('export-project-btn').addEventListener('click', async () => {
                showNotification('Preparing manuscript for export...', 'info');
                try {
                    const allSections = await getProjectSections(userId, projectId);
                    let fullHtmlContent = '';

                    // Add a title to the exported document
                    fullHtmlContent += `<h1>${stripMarkdownAndHtml(project.title || 'Untitled Manuscript')}</h1>\n\n`;

                    for (const section of allSections) {
                        // Skip book_cover and metadata as they are not text content for export
                        if (section.id === 'book_cover' || section.id === 'metadata') continue;
                        // Skip front_matter and back_matter as they will be handled separately for export
                        if (section.id === 'front_matter' || section.id === 'back_matter') continue;


                        // Add section title as a heading
                        fullHtmlContent += `<h2>${section.title}</h2>\n`;

                        // Convert Quill Delta to HTML
                        // Temporarily create a Quill instance to convert content
                        const tempDiv = document.createElement('div');
                        const tempQuill = new Quill(tempDiv, { readOnly: true });
                        try {
                            tempQuill.setContents(JSON.parse(section.content));
                        } catch (e) {
                            tempQuill.setText(section.content || '');
                        }
                        fullHtmlContent += tempDiv.querySelector('.ql-editor').innerHTML + '\n\n';
                    }

                    const blob = new Blob([fullHtmlContent], { type: 'text/html;charset=utf-8' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `${stripMarkdownAndHtml(project.title).replace(/\s+/g, '-') || 'untitled-manuscript'}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showNotification('Manuscript exported as HTML!', 'success');

                } catch (e) {
                    console.error("Export failed:", e);
                    showNotification(`Export failed: ${e.message}`, 'error');
                }
            });


            const renderAiPanel = (sectionId) => {
                let aiPanelHtml = `
                    <h3 class="text-lg font-bold mb-4">AI Co-Author</h3>
                    <div class="space-y-4 flex-grow flex flex-col">
                        <div class="pb-4 border-b border-gray-700">
                            <p class="text-sm font-semibold mb-2">AI Style Preference</p>
                            <textarea id="ai-style-preference-input" class="w-full h-20 p-2 bg-gray-700 border border-gray-600 rounded-md text-sm" placeholder="e.g., Write in a formal, encouraging tone."></textarea>
                            <p class="text-xs text-gray-400 mt-1">Describe the tone or style you'd like the AI to use. For deeper style mimicry from your books, more advanced features are needed.</p>
                        </div>
                `;

                if (sectionId === 'brainstorming') {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Synopsis Ideas</p>
                            <textarea id="ai-idea-input" class="w-full h-24 p-2 bg-gray-700 border border-gray-600 rounded-md text-sm" placeholder="e.g., A story about a family..."></textarea>
                            <button id="generate-concepts-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate</button>
                        </div>
                        <div class="pt-4 border-t border-gray-700">
                            <p class="text-sm font-semibold mb-2">Brainstorming Tools</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="generate-pov-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">POV & Voice</button>
                                <button id="generate-structure-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Structural Template</button>
                                <button id="generate-titles-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Titles</button>
                            </div>
                        </div>`;
                } else if (sectionId === 'character_development') {
                     aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Character Profiles</p>
                            <p class="text-xs text-gray-400 mb-2">Let the AI create character ideas based on your story's concept.</p>
                            <button id="generate-characters-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Characters</button>
                        </div>`;
                } else if (sectionId === 'world_building') {
                     aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate World Prompts</p>
                            <p class="text-xs text-gray-400 mb-2">Brainstorm elements for your story's universe.</p>
                            <button id="generate-world-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate World Ideas</button>
                        </div>`;
                }
                else if (sectionId === 'outline') {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Chapter Beats</p>
                            <p class="text-xs text-gray-400 mb-2">Let the AI create a detailed outline based on your project's foundation.</p>
                            <button id="generate-outline-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Outline</button>
                        </div>`;
                } else if (sectionId.startsWith('chapter_')) {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Drafting & Revising</p>
                            <div class="grid grid-cols-2 gap-2"> <!-- Two columns for drafting buttons -->
                                <button id="generate-next-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Next</button>
                                <button id="analyze-chapter-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Analyze Chapter</button>
                                <button id="proofread-chapter-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Proofread Chapter</button>
                            </div>
                        </div>`;
                } else if (sectionId === 'book_cover') {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Cover Concepts</p>
                            <p class="text-xs text-gray-400 mb-2">Generate descriptive prompts for an AI image generator based on your synopsis.</p>
                            <button id="generate-cover-concepts-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Concepts</button>
                        </div>`;
                } else if (sectionId === 'front_matter') {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Front Matter</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="generate-dedication-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Dedication</button>
                                <button id="generate-acknowledgments-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Acknowledge</button>
                                <button id="generate-preface-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Preface</button>
                            </div>
                        </div>`;
                } else if (sectionId === 'back_matter') {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Back Matter</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="generate-blurb-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Blurb</button>
                                <button id="generate-author-bio-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Author Bio</button>
                                <button id="generate-discussion-questions-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Discussion Questions</button>
                            </div>
                        </div>`;
                } else if (sectionId === 'metadata') {
                    // No AI generation for metadata section, but still show style preference
                    aiPanelHtml += `<div class="p-4 text-gray-400 text-sm">No AI generation tools for Project Metadata. This section is for manual input.</div>`;
                }


                aiPanelHtml += `
                    <div class="pt-4 border-t border-gray-700 flex-shrink-0">
                        <p class="text-sm font-semibold mb-2">Editing & Faith Tools</p>
                        <div class="grid grid-cols-2 gap-2"> <!-- Two columns for editing buttons -->
                            <button id="suggest-alternatives-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Alternative Words</button> <!-- Renamed button -->
                            <button id="suggest-scripture-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Suggest Scripture</button>
                            <button id="suggest-youth-phrases-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Suggest Youth Phrases</button> <!-- Enabled and ready for logic -->
                        </div>
                    </div>
                    <div id="ai-output" class="mt-4 text-sm text-gray-300 space-y-2 flex-grow overflow-y-auto"></div>
                    </div>`;

                rightSidebar.innerHTML = aiPanelHtml;
                setupAiPanelListeners(sectionId);
            };

            const setupAiPanelListeners = (sectionId) => {
                const outputDiv = document.getElementById('ai-output');

                // Helper function to show content in a modal and allow insertion
                const showContentInModal = (title, content, onAcceptCallback) => {
                    showModal(title, `<div class="whitespace-pre-wrap text-gray-300 text-sm">${escapeHtml(content)}</div>`, async () => {
                        await onAcceptCallback(content);
                    }, 'Accept & Add to Editor');
                };

                // Initialize AI Style Preference input and listener
                const aiStyleInput = document.getElementById('ai-style-preference-input');
                if (aiStyleInput) {
                    aiStyleInput.value = aiStylePreference; // Load saved preference
                    aiStyleInput.addEventListener('input', debounce(() => {
                        aiStylePreference = aiStyleInput.value; // Save preference on input
                        showNotification('AI style preference updated!', 'info', 1000);
                    }, 500));
                }


                if (sectionId === 'brainstorming') {
                    const ideaInput = document.getElementById('ai-idea-input');

                    document.getElementById('generate-concepts-btn').addEventListener('click', async () => {
                        const idea = editor.getText().trim() || ideaInput.value;
                        if (!idea) { showNotification("Please enter a basic idea in the editor or the text box.", "error"); return; }
                        const conceptsText = await generateConcepts(idea);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        const concepts = conceptsText.split(/\d+\.\s+/).filter(c => c.trim().length > 0);
                        // Changed to open in modal
                        outputDiv.innerHTML = concepts.map((concept, index) => `<button data-content="${escapeHtml(concept.trim())}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Concept ${index + 1}:</strong> ${escapeHtml(concept.trim().substring(0, 80))}...</button>`).join('');
                    });

                    document.getElementById('generate-pov-btn').addEventListener('click', async () => {
                        const context = editor.getText().trim();
                        if (!context) { showNotification("Please write a synopsis in the editor first.", "error"); return; }
                        const povsText = await suggestPOVs(context);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        // Remove introductory sentence if present
                        const cleanPovsText = povsText.replace(/^(Option \d+: )?Here are \d+ potential Point of View \(POV\) & Voice choices for.*?\n\n/i, '').trim();
                        const povs = cleanPovsText.split(/\d+\.\s+/).filter(c => c.trim().length > 0);
                        // Changed to open in modal
                        outputDiv.innerHTML = povs.map((pov, index) => `<button data-content="${escapeHtml(pov.trim())}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Option ${index + 1}:</strong> ${escapeHtml(pov.trim().substring(0, 80))}...</button>`).join('');
                    });

                     document.getElementById('generate-structure-btn').addEventListener('click', async () => {
                        const context = editor.getText().trim();
                        if (!context) { showNotification("Please write a synopsis in the editor first.", "error"); return; }
                        const structuresText = await suggestStructures(context);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        // Remove introductory sentence if present
                        const cleanStructuresText = structuresText.replace(/^(Option \d+: )?Here are \d+ potential structural templates.*?\n\n/i, '').trim();
                        const structures = cleanStructuresText.split(/\d+\.\s+/).filter(c => c.trim().length > 0);
                        // Changed to open in modal
                        outputDiv.innerHTML = structures.map((structure, index) => `<button data-content="${escapeHtml(structure.trim())}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Option ${index + 1}:</strong> ${escapeHtml(structure.trim().substring(0, 80))}...</button>`).join('');
                    });

                    // New: Generate Titles listener
                    document.getElementById('generate-titles-btn').addEventListener('click', async () => {
                        const context = editor.getText().trim();
                        if (!context) { showNotification("Please write a synopsis or brainstorming content in the editor first.", "error"); return; }
                        const titlesText = await generateTitles(context);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        const titles = titlesText.split(/\d+\.\s+/).filter(t => t.trim().length > 0);
                        // Changed to open in modal
                        outputDiv.innerHTML = titles.map((title, index) => `<button data-content="${escapeHtml(title.trim())}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Title ${index + 1}:</strong> ${escapeHtml(title.trim())}</button>`).join('');
                    });

                } else if (sectionId === 'character_development') {
                    const generateBtn = document.getElementById('generate-characters-btn');
                    generateBtn.addEventListener('click', async () => {
                        const synopsisDoc = await getSection(userId, projectId, 'brainstorming');
                        const context = `Synopsis: ${synopsisDoc.content}`;
                        const charactersText = await generateCharacterProfiles(context);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        // Problem 1 Fix: Display all characters in one go and add an "Accept" button
                        // Changed to open in modal
                        showContentInModal('Generated Character Profiles', charactersText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Character profiles added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                } else if (sectionId === 'world_building') {
                    const generateBtn = document.getElementById('generate-world-btn');
                    generateBtn.addEventListener('click', async () => {
                        const synopsisDoc = await getSection(userId, projectId, 'brainstorming');
                        const charDevDoc = await getSection(userId, projectId, 'character_development');
                        const context = `Synopsis: ${charDevDoc.content}\n\nCharacter Development: ${charDevDoc.content}`;
                        const worldText = await generateWorldPrompts(context);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        const prompts = worldText.split(/\d+\.\s+/).filter(c => c.trim().length > 0);
                        // Changed to open in modal
                        outputDiv.innerHTML = prompts.map((prompt, index) => `<button data-content="${escapeHtml(prompt.trim())}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Idea ${index + 1}:</strong> ${escapeHtml(prompt.trim().substring(0, 80))}...</button>`).join('');
                    });
                }
                else if (sectionId === 'outline') {
                    const generateBtn = document.getElementById('generate-outline-btn');
                     generateBtn.addEventListener('click', async () => {
                        outputDiv.innerHTML = `<p>Gathering context and generating outline...</p>`; // Show loading
                        const synopsisDoc = await getSection(userId, projectId, 'brainstorming');
                        const charDevDoc = await await getSection(userId, projectId, 'character_development');
                        const worldDoc = await getSection(userId, projectId, 'world_building');
                        const context = `Synopsis: ${synopsisDoc.content}\n\nCharacter Development: ${charDevDoc.content}\n\nWorld-building: ${worldDoc.content}`;
                        const outline = await generateOutlineBeats(context);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        // Changed to open in modal
                        showContentInModal('Generated Outline', outline, (content) => {
                            editor.setText(content);
                            showNotification("Outline added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                } else if (sectionId.startsWith('chapter_')) {
                    const generateNextBtn = document.getElementById('generate-next-btn');
                    const analyzeChapterBtn = document.getElementById('analyze-chapter-btn');
                    const proofreadBtn = document.getElementById('proofread-chapter-btn');
                    const suggestYouthPhrasesBtn = document.getElementById('suggest-youth-phrases-btn'); // Get the new button
                    const suggestAlternativesBtn = document.getElementById('suggest-alternatives-btn'); // Get the alternative words button
                    const suggestScriptureBtn = document.getElementById('suggest-scripture-btn'); // Get the scripture button

                    generateNextBtn.addEventListener('click', async () => {
                        const currentText = editor.getText();
                        const synopsisDoc = await getSection(userId, projectId, 'brainstorming');
                        const outlineDoc = await getSection(userId, projectId, 'outline');
                        const context = `Overall Synopsis: ${synopsisDoc ? synopsisDoc.content : ''}\nOutline: ${outlineDoc ? outlineDoc.content : ''}\n\n`;

                        const suggestion = await generateNext(currentText, context); // Pass context to generateNext
                        outputDiv.innerHTML = ''; // Clear loading after response
                        // Changed to open in modal
                        showContentInModal('Generated Next Section', suggestion, (content) => {
                            editor.insertText(editor.getLength(), ' ' + content);
                            showNotification("Text added!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                    analyzeChapterBtn.addEventListener('click', async () => {
                        const chapterText = editor.getText();
                        const synopsisDoc = await getSection(userId, projectId, 'brainstorming');
                        const charDevDoc = await getSection(userId, projectId, 'character_development');
                        const context = `Synopsis: ${synopsisDoc.content}\n\nCharacter Development: ${charDevDoc.content}`;
                        const analysis = await analyzeChapter(chapterText, context);
                        outputDiv.innerHTML = `<div class="whitespace-pre-wrap p-2 bg-gray-900 rounded-md">${analysis}</div>`;
                    });
                     proofreadBtn.addEventListener('click', async () => {
                        const chapterText = editor.getText();
                        const suggestionsText = await proofreadChapter(chapterText);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        // Parse suggestions to extract original and replacement parts
                        const suggestions = suggestionsText.split(/\d+\.\s+/).filter(c => c.trim().length > 0).map(s => {
                            // Attempt to parse "Original: ... Proposed: ..." format
                            const match = s.match(/Original:\s*(.*?)\s*Proposed:\s*(.*)/is);
                            if (match && match[1] && match[2]) {
                                return { original: match[1].trim(), proposed: match[2].trim(), full: s.trim() };
                            }
                            // Fallback if the format is different
                            return { original: s.trim(), proposed: s.trim(), full: s.trim() }; // Use full suggestion as both if format isn't matched
                        });

                        if (suggestions.length > 0) {
                            outputDiv.innerHTML = `
                                <p class="mb-2">Click a suggestion to apply it:</p>
                                ${suggestions.map((suggestion, index) => `
                                    <button data-original="${escapeHtml(suggestion.original)}" data-proposed="${escapeHtml(suggestion.proposed)}"
                                            class="ai-proofread-suggestion-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2 text-sm">
                                        <strong>Suggestion ${index + 1}:</strong> <span class="line-through text-red-300">${escapeHtml(suggestion.original)}</span> ‚Üí <span class="text-green-300">${escapeHtml(suggestion.proposed)}</span>
                                    </button>
                                `).join('')}
                            `;
                        } else {
                            outputDiv.innerHTML = `<p>No proofreading suggestions found or text is already perfect!</p>`;
                        }
                    });

                    // Problem 1 Fix: Alternative Words - Capture selection and provide suggestions
                    if (suggestAlternativesBtn) {
                        suggestAlternativesBtn.addEventListener('click', async () => {
                            const range = editor.getSelection();
                            if (!range || range.length === 0) { showNotification("Please select text in the editor to get alternative words.", "info"); return; }

                            currentSelectionRange = range; // Store the selection range
                            const selectedText = editor.getText(range.index, range.length);
                            const context = editor.getText(Math.max(0, range.index - 100), 200 + range.length); // Broader context

                            const alternativesText = await suggestAlternatives(selectedText, context);
                            outputDiv.innerHTML = '';
                            const alternatives = alternativesText.split(/\d+\.\s+/).filter(c => c.trim().length > 0);
                            // Changed to open in modal
                            outputDiv.innerHTML = alternatives.map(alt => `<button data-content="${escapeHtml(alt.trim())}" class="ai-suggestion-modal-btn ai-alternative-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2">${escapeHtml(alt.trim())}</button>`).join('');
                        });
                    }


                    // Problem 1 Fix: Suggested Youth Phrases - Capture selection and provide suggestions
                    if (suggestYouthPhrasesBtn) {
                        suggestYouthPhrasesBtn.disabled = false;
                        suggestYouthPhrasesBtn.classList.remove('bg-gray-600', 'text-gray-400', 'cursor-not-allowed');
                        suggestYouthPhrasesBtn.classList.add('accent-bg', 'accent-bg-hover');

                        suggestYouthPhrasesBtn.addEventListener('click', async () => {
                            const range = editor.getSelection();
                            if (!range || range.length === 0) { showNotification("Please select text (e.g., dialogue) in the editor to get youth phrase suggestions.", "info"); return; }

                            // Store the current selection range globally for youth phrases
                            currentSelectionRange = range;

                            const selectedText = editor.getText(range.index, range.length);
                            const context = editor.getText(Math.max(0, range.index - 100), 200 + range.length); // Broader context
                            const phrasesText = await suggestYouthPhrases(selectedText, context);
                            outputDiv.innerHTML = ''; // Clear loading after response
                            const phrases = phrasesText.split(/\d+\.\s+/).filter(c => c.trim().length > 0);
                            // Changed to open in modal
                            outputDiv.innerHTML = phrases.map(phrase => `<button data-content="${escapeHtml(phrase.trim())}" class="ai-suggestion-modal-btn ai-youth-phrase-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2">${escapeHtml(phrase.trim())}</button>`).join('');
                        });
                    }
                    if (suggestScriptureBtn) {
                        suggestScriptureBtn.addEventListener('click', async () => {
                            const range = editor.getSelection();
                            if (!range || range.length === 0) { showNotification("Please select text in the editor to get scripture suggestions.", "info"); return; }

                            const selectedText = editor.getText(range.index, range.length);
                            const context = editor.getText(Math.max(0, range.index - 100), 200 + range.length); // Broader context
                            const scriptureText = await suggestScripture(selectedText, context);
                            outputDiv.innerHTML = ''; // Clear loading after response
                            // Changed to open in modal
                            showContentInModal('Suggested Scripture', scriptureText, (content) => {
                                editor.insertText(editor.getLength(), '\n\n' + content);
                                showNotification("Scripture added to editor!", "success");
                                outputDiv.innerHTML = '';
                            });
                        });
                    }

                } else if (sectionId === 'book_cover') {
                    const generateBtn = document.getElementById('generate-cover-concepts-btn');
                    generateBtn.addEventListener('click', async () => {
                        outputDiv.innerHTML = `<p>Generating cover concepts...</p>`;
                        const synopsisDoc = await getSection(userId, projectId, 'brainstorming');
                        const context = `Synopsis: ${synopsisDoc.content}`;
                        const conceptsText = await generateCoverConcepts(context);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        const concepts = conceptsText.split(/\d+\.\s+/).filter(c => c.trim().length > 0);
                        // Changed data attribute to data-full-concept and added class for specific handling
                        outputDiv.innerHTML = concepts.map((concept, index) => `<button data-full-concept="${escapeHtml(concept.trim())}" class="ai-cover-concept-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Concept ${index + 1}:</strong> ${escapeHtml(concept.trim())}</button>`).join('');

                        // The event listener is now attached via delegation below, no need to re-attach here.
                    });
                }

                // IMPORTANT: Event Delegation for all dynamically created AI suggestion buttons
                // This single listener handles clicks on all buttons with class 'ai-suggestion-btn'
                // that are children of outputDiv, even if they are added to the DOM later.
                outputDiv.addEventListener('click', async (e) => {
                    const target = e.target.closest('.ai-suggestion-modal-btn, .ai-title-suggestion-btn, .ai-cover-concept-btn, .ai-proofread-suggestion-btn');
                    if (target) {
                        // Handle generic suggestion buttons that open a modal
                        if (target.classList.contains('ai-suggestion-modal-btn')) {
                            const contentToDisplay = target.dataset.content;
                            const isAlternativeOrYouth = target.classList.contains('ai-alternative-btn') || target.classList.contains('ai-youth-phrase-btn');

                            showModal('AI Suggestion', `<div class="whitespace-pre-wrap text-gray-300 text-sm">${escapeHtml(contentToDisplay)}</div>`, async () => {
                                let contentToInsert = contentToDisplay;
                                if (isAlternativeOrYouth) {
                                    contentToInsert = stripMarkdownAndHtml(contentToInsert);
                                    if (currentSelectionRange && currentSelectionRange.length > 0) {
                                        editor.setSelection(currentSelectionRange.index, currentSelectionRange.length);
                                        editor.deleteText(currentSelectionRange.index, currentSelectionRange.length);
                                        editor.insertText(currentSelectionRange.index, contentToInsert);
                                        showNotification("Text replaced!", "success");
                                        currentSelectionRange = null; // Clear the stored range after use
                                    } else {
                                        editor.insertText(editor.getLength(), '\n\n' + contentToInsert);
                                        showNotification("Content added to editor (selected text could not be replaced).", "info");
                                    }
                                } else {
                                    editor.insertText(editor.getLength(), '\n\n' + contentToInsert);
                                    showNotification("Content added to editor!", "success");
                                }
                                outputDiv.innerHTML = ''; // Clear suggestions after applying
                            }, 'Accept & Add to Editor');
                        }
                        // Title suggestion button handling
                        else if (target.classList.contains('ai-title-suggestion-btn')) {
                            const newTitle = target.dataset.content; // Changed from data-title to data-content
                            if (newTitle) {
                                await updateProjectTitle(userId, projectId, newTitle);
                                project.title = newTitle; // Update local project object
                                projectMainTitle.textContent = stripMarkdownAndHtml(newTitle); // Update editor header, stripped markdown
                                renderSidebar(); // Re-render sidebar to update project title there
                                outputDiv.innerHTML = ''; // Clear suggestions after applying
                            }
                        }
                        // Book Cover Concept button handling (now opens an editable modal)
                        else if (target.classList.contains('ai-cover-concept-btn')) {
                            const fullConcept = target.dataset.fullConcept;
                            showModal('Edit Image Prompt', `
                                <div class="space-y-4">
                                    <p class="text-gray-400">Review and edit the prompt before generating images:</p>
                                    <textarea id="image-prompt-editor" class="w-full h-40 p-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 accent-ring">${escapeHtml(fullConcept)}</textarea>
                                </div>
                            `, async () => {
                                const editedPrompt = document.getElementById('image-prompt-editor').value;
                                if (editedPrompt) {
                                    const imageUrls = await generateImage(editedPrompt);
                                    if (imageUrls && imageUrls.length > 0) {
                                        coverDisplayContainer.innerHTML = `
                                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 p-4">
                                                ${imageUrls.map(url => `
                                                    <div class="cover-image-wrapper" data-image-url="${escapeHtml(url)}">
                                                        <img src="${url}" onerror="this.onerror=null;this.src='https://placehold.co/400x600/FF0000/FFFFFF?text=Image+Load+Error';" class="w-full h-auto rounded-lg shadow-lg" alt="Generated Book Cover"/>
                                                        <div class="cover-selection-overlay"><i class="fas fa-check-circle"></i> Selected</div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                        showNotification('Images generated! Click to select your favorite.', 'success');
                                    } else {
                                        showNotification('Failed to generate images.', 'error');
                                    }
                                } else {
                                    showNotification('Image prompt cannot be empty.', 'error');
                                }
                                outputDiv.innerHTML = ''; // Clear concepts after generating images
                            }, 'Generate Images');
                        }
                        // Proofread suggestion button handling
                        else if (target.classList.contains('ai-proofread-suggestion-btn')) {
                            const originalText = target.dataset.original;
                            const proposedText = target.dataset.proposed;
                            const editorContent = editor.getText();
                            const index = editorContent.indexOf(originalText);
                            if (index !== -1) {
                                editor.setSelection(index, originalText.length);
                                editor.deleteText(index, originalText.length);
                                editor.insertText(index, proposedText);
                                showNotification("Fix applied!", "success");
                                outputDiv.innerHTML = '';
                            } else {
                                showNotification("Could not find original text in editor.", "error");
                            }
                        }
                    }
                });

                // Problem 2.1 Fix: Dedicated listener for cover image selection
                coverDisplayContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('.cover-image-wrapper');
                    if (target && sectionId === 'book_cover') { // Ensure we are in the book_cover section
                        const imageUrl = target.dataset.imageUrl;
                        if (imageUrl) {
                            // Remove 'selected' class from all other images
                            coverDisplayContainer.querySelectorAll('.cover-image-wrapper').forEach(el => el.classList.remove('selected'));
                            // Add 'selected' class to the clicked image
                            target.classList.add('selected');
                            // Save the selected image URL to Firestore
                            try {
                                // Generate a unique file name for the image in storage
                                const storageRef = ref(storageInstance, `artifacts/${appId}/users/${currentUserId}/project_covers/${projectId}_${Date.now()}.png`);
                                // Upload the base64 string directly
                                await uploadString(storageRef, imageUrl, 'data_url');
                                const downloadURL = await getDownloadURL(storageRef);
                                await updateProjectCover(currentUserId, projectId, downloadURL);
                                project.bookCoverUrl = downloadURL; // Update local project object
                                renderSidebar(); // Re-render sidebar to show the new cover
                                showNotification('Book cover uploaded and saved!', 'success');
                                // Stay in editor section instead of navigating to dashboard
                                // Removed: navigateTo('dashboard');
                            } catch (storageError) {
                                console.error("Error uploading cover to storage:", storageError);
                                showNotification(`Failed to save cover: ${storageError.message}`, 'error');
                            }
                        }
                    }
                });


                // Re-attach specific listeners for buttons that are NOT dynamically replaced within outputDiv
                // (e.g., Generate Next, Analyze Chapter, Proofread Chapter)
                // These buttons are always present in the AI panel once the section is loaded.
                const generateNextBtn = document.getElementById('generate-next-btn');
                if (generateNextBtn) {
                    generateNextBtn.addEventListener('click', async () => {
                        const currentText = editor.getText();
                        const synopsisDoc = await getSection(userId, projectId, 'brainstorming');
                        const outlineDoc = await getSection(userId, projectId, 'outline');
                        const context = `Overall Synopsis: ${synopsisDoc ? synopsisDoc.content : ''}\nOutline: ${outlineDoc ? outlineDoc.content : ''}\n\n`;

                        const suggestion = await generateNext(currentText, context);
                        // Changed to open in modal
                        showContentInModal('Generated Next Section', suggestion, (content) => {
                            editor.insertText(editor.getLength(), ' ' + content);
                            showNotification("Text added!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }
                const analyzeChapterBtn = document.getElementById('analyze-chapter-btn');
                if (analyzeChapterBtn) {
                    analyzeChapterBtn.addEventListener('click', async () => {
                        const chapterText = editor.getText();
                        const synopsisDoc = await getSection(userId, projectId, 'brainstorming');
                        const charDevDoc = await getSection(userId, projectId, 'character_development');
                        const context = `Synopsis: ${synopsisDoc.content}\n\nCharacter Development: ${charDevDoc.content}`;
                        const analysis = await analyzeChapter(chapterText, context);
                        outputDiv.innerHTML = `<div class="whitespace-pre-wrap p-2 bg-gray-900 rounded-md">${analysis}</div>`;
                    });
                }
                const proofreadBtn = document.getElementById('proofread-chapter-btn');
                if (proofreadBtn) {
                    proofreadBtn.addEventListener('click', async () => {
                        const chapterText = editor.getText();
                        const suggestionsText = await proofreadChapter(chapterText);
                        const suggestions = suggestionsText.split(/\d+\.\s+/).filter(c => c.trim().length > 0).map(s => {
                            const match = s.match(/Original:\s*(.*?)\s*Proposed:\s*(.*)/is);
                            if (match && match[1] && match[2]) {
                                return { original: match[1].trim(), proposed: match[2].trim(), full: s.trim() };
                            }
                            return { original: s.trim(), proposed: s.trim(), full: s.trim() };
                        });

                        if (suggestions.length > 0) {
                            outputDiv.innerHTML = `
                                <p class="mb-2">Click a suggestion to apply it:</p>
                                ${suggestions.map((suggestion, index) => `
                                    <button data-original="${escapeHtml(suggestion.original)}" data-proposed="${escapeHtml(suggestion.proposed)}"
                                            class="ai-proofread-suggestion-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2 text-sm">
                                        <strong>Suggestion ${index + 1}:</strong> <span class="line-through text-red-300">${escapeHtml(suggestion.original)}</span> ‚Üí <span class="text-green-300">${escapeHtml(suggestion.proposed)}</span>
                                    </button>
                                `).join('')}
                            `;
                        } else {
                            outputDiv.innerHTML = `<p>No proofreading suggestions found or text is already perfect!</p>`;
                        }
                    });
                }

                // Front Matter and Back Matter button listeners
                const generateDedicationBtn = document.getElementById('generate-dedication-btn');
                if (generateDedicationBtn) {
                    generateDedicationBtn.addEventListener('click', async () => {
                        const metadataDoc = await getSection(userId, projectId, 'metadata');
                        const metadata = metadataDoc ? JSON.parse(metadataDoc.content) : {};
                        const projectData = await getProject(userId, projectId);
                        const prompt = `Generate a dedication for a book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}". Author: ${metadata.authorName || 'Rene\' Stanley'}. Make it heartfelt and concise.`;
                        const dedicationText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        // Changed to open in modal
                        showContentInModal('Generated Dedication', dedicationText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Dedication added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }

                const generateAcknowledgmentsBtn = document.getElementById('generate-acknowledgments-btn');
                if (generateAcknowledgmentsBtn) {
                    generateAcknowledgmentsBtn.addEventListener('click', async () => {
                        const metadataDoc = await getSection(userId, projectId, 'metadata');
                        const metadata = metadataDoc ? JSON.parse(metadataDoc.content) : {};
                        const projectData = await getProject(userId, projectId);
                        const prompt = `Generate an acknowledgments section for a book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}". Author: ${metadata.authorName || 'Rene\' Stanley'}. Include thanks to family, friends, and inspiration.`;
                        const acknowledgmentsText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        // Changed to open in modal
                        showContentInModal('Generated Acknowledgments', acknowledgmentsText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Acknowledgments added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }

                const generatePrefaceBtn = document.getElementById('generate-preface-btn');
                if (generatePrefaceBtn) {
                    generatePrefaceBtn.addEventListener('click', async () => {
                        const synopsisDoc = await getSection(userId, projectId, 'brainstorming');
                        const metadataDoc = await getSection(userId, projectId, 'metadata');
                        const metadata = metadataDoc ? JSON.parse(metadataDoc.content) : {};
                        const projectData = await getProject(userId, projectId);
                        const prompt = `Generate a preface for a book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}". Author: ${metadata.authorName || 'Rene\' Stanley'}. Briefly introduce the book's purpose or inspiration. Synopsis: ${synopsisDoc ? synopsisDoc.content : ''}`;
                        const prefaceText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        // Changed to open in modal
                        showContentInModal('Generated Preface', prefaceText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Preface added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }

                const generateBlurbBtn = document.getElementById('generate-blurb-btn');
                if (generateBlurbBtn) {
                    generateBlurbBtn.addEventListener('click', async () => {
                        const synopsisDoc = await getSection(userId, projectId, 'brainstorming');
                        const metadataDoc = await getSection(userId, projectId, 'metadata');
                        const metadata = metadataDoc ? JSON.parse(metadataDoc.content) : {};
                        const projectData = await getProject(userId, projectId);
                        const prompt = `Generate a compelling back cover blurb (2-3 paragraphs) for a book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}" targeting "${projectData.targetAudience}". Author: ${metadata.authorName || 'Rene\' Stanley'}. Focus on hooks and intrigue. Synopsis: ${synopsisDoc ? synopsisDoc.content : ''}`;
                        const blurbText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        // Changed to open in modal
                        showContentInModal('Generated Blurb', blurbText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Blurb added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }

                const generateAuthorBioBtn = document.getElementById('generate-author-bio-btn');
                if (generateAuthorBioBtn) {
                    generateAuthorBioBtn.addEventListener('click', async () => {
                        const metadataDoc = await getSection(userId, projectId, 'metadata');
                        const metadata = metadataDoc ? JSON.parse(metadataDoc.content) : {};
                        const projectData = await getProject(userId, projectId);
                        const prompt = `Generate a concise (1-2 paragraph) author biography for ${metadata.authorName || 'Rene\' Stanley'}, author of a book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}". Highlight key experiences like being born in Washington D.C., teenage years in Maryland, finding solace in thoughts and observations, interest in older adults' wisdom, and military service in Desert Storm.`;
                        const authorBioText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        // Changed to open in modal
                        showContentInModal('Generated Author Biography', authorBioText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Author biography added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }

                const generateDiscussionQuestionsBtn = document.getElementById('generate-discussion-questions-btn');
                if (generateDiscussionQuestionsBtn) {
                    generateDiscussionQuestionsBtn.addEventListener('click', async () => {
                        const synopsisDoc = await getSection(userId, projectId, 'brainstorming');
                        const projectData = await getProject(userId, projectId);
                        const prompt = `Generate 5 thought-provoking discussion questions for a book club based on a book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}". Focus on themes and characters. Synopsis: ${synopsisDoc ? synopsisDoc.content : ''}`;
                        const questionsText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        // Changed to open in modal
                        showContentInModal('Generated Discussion Questions', questionsText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Discussion questions added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }
            };

            const loadSection = async (sectionId) => {
                const sectionData = await getSection(userId, projectId, sectionId);
                // The project's main title will now always be displayed by projectMainTitle element.
                if (projectMainTitle) {
                    projectMainTitle.textContent = stripMarkdownAndHtml(project.title || 'Untitled Page');
                }

                activeSectionId = sectionId;

                // Hide all content containers initially
                editorContainer.classList.add('hidden');
                coverDisplayContainer.classList.add('hidden');
                metadataFormContainer.classList.add('hidden');

                if (sectionId === 'book_cover') {
                    coverDisplayContainer.classList.remove('hidden');
                    // Display previously saved cover if available
                    const projectData = await getProject(userId, projectId);
                    if (projectData && projectData.bookCoverUrl) {
                        coverDisplayContainer.innerHTML = `
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 p-4">
                                <div class="cover-image-wrapper selected" data-image-url="${escapeHtml(projectData.bookCoverUrl)}">
                                    <img src="${projectData.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/400x600/FF0000/FFFFFF?text=Image+Load+Error';" class="w-full h-auto rounded-lg shadow-lg" alt="Selected Book Cover"/>
                                    <div class="cover-selection-overlay"><i class="fas fa-check-circle"></i> Selected</div>
                                </div>
                                <div class="cover-image-wrapper" data-image-url="https://placehold.co/400x600/111827/FFFFFF?text=More+Options+Coming">
                                    <img src="https://placehold.co/400x600/111827/FFFFFF?text=More+Options+Coming" class="w-full h-auto rounded-lg" alt="Placeholder for more options"/>
                                    <div class="cover-selection-overlay"><i class="fas fa-check-circle"></i> Selected</div>
                                </div>
                                <div class="cover-image-wrapper" data-image-url="https://placehold.co/400x600/374151/FFFFFF?text=More+Options+Coming">
                                    <img src="https://placehold.co/400x600/374151/FFFFFF?text=More+Options+Coming" class="w-full h-auto rounded-lg" alt="Placeholder for more options"/>
                                    <div class="cover-selection-overlay"><i class="fas fa-check-circle"></i> Selected</div>
                                </div>
                            </div>
                        `;
                    } else {
                        coverDisplayContainer.innerHTML = `<div class="text-center text-gray-400">Your generated book cover will appear here.</div>`;
                    }
                } else if (sectionId === 'metadata') {
                    metadataFormContainer.classList.remove('hidden');
                    let metadata = {};
                    try {
                        metadata = JSON.parse(sectionData.content);
                    } catch (e) {
                        console.error("Error parsing metadata content:", e);
                        // Fallback to empty object if content is not valid JSON
                        metadata = {};
                    }

                    metadataFormContainer.innerHTML = `
                        <div class="bg-gray-900 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-md">
                            <h3 class="text-xl font-lora font-bold mb-4 text-white">Project Metadata</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="meta-author-name" class="block text-sm font-medium text-gray-300 mb-1">Author Name</label>
                                    <input type="text" id="meta-author-name" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${escapeHtml(metadata.authorName || '')}">
                                </div>
                                <div>
                                    <label for="meta-copyright-year" class="block text-sm font-medium text-gray-300 mb-1">Copyright Year</label>
                                    <input type="number" id="meta-copyright-year" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${metadata.copyrightYear || new Date().getFullYear()}">
                                </div>
                                <div>
                                    <label for="meta-publisher" class="block text-sm font-medium text-gray-300 mb-1">Publisher</label>
                                    <input type="text" id="meta-publisher" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${escapeHtml(metadata.publisher || '')}">
                                </div>
                                <div>
                                    <label for="meta-isbn" class="block text-sm font-medium text-gray-300 mb-1">ISBN (Optional)</label>
                                    <input type="text" id="meta-isbn" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${escapeHtml(metadata.isbn || '')}">
                                </div>
                                <div>
                                    <label for="meta-series-name" class="block text-sm font-medium text-gray-300 mb-1">Series Name (Optional)</label>
                                    <input type="text" id="meta-series-name" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${escapeHtml(metadata.seriesName || '')}">
                                </div>
                                <div>
                                    <label for="meta-series-number" class="block text-sm font-medium text-gray-300 mb-1">Series Number (Optional)</label>
                                    <input type="number" id="meta-series-number" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${metadata.seriesNumber || ''}">
                                </div>
                                <div>
                                    <label for="meta-lccn" class="block text-sm font-medium text-gray-300 mb-1">Library of Congress Control Number (LCCN)</label>
                                    <input type="text" id="meta-lccn" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${escapeHtml(metadata.lccn || '')}">
                                </div>
                                <button id="save-metadata-btn" class="w-full mt-4 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Save Metadata</button>
                            </div>
                        </div>
                    `;

                    document.getElementById('save-metadata-btn').addEventListener('click', async () => {
                        const newMetadata = {
                            authorName: document.getElementById('meta-author-name').value,
                            copyrightYear: parseInt(document.getElementById('meta-copyright-year').value) || null,
                            publisher: document.getElementById('meta-publisher').value,
                            isbn: document.getElementById('meta-isbn').value,
                            seriesName: document.getElementById('meta-series-name').value,
                            seriesNumber: parseInt(document.getElementById('meta-series-number').value) || null,
                            lccn: document.getElementById('meta-lccn').value, // Save LCCN
                        };
                        await updateProjectMetadata(userId, projectId, newMetadata);
                    });

                } else {
                    editorContainer.classList.remove('hidden');
                    if (!editor) {
                        const toolbarOptions = [['bold', 'italic', 'underline'], [{ 'header': 1 }, { 'header': 2 }], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']];
                        // Initialize Quill with the toolbar and editor container
                        editor = new Quill('#editor', {
                            modules: { toolbar: '#editor-toolbar' }, // Link toolbar to its ID
                            theme: 'snow'
                        });
                        editor.on('text-change', debounce(async () => {
                            const content = JSON.stringify(editor.getContents());
                            await updateSectionContent(userId, projectId, activeSectionId, content);
                            showNotification('Progress Saved', 'success', 1500);
                        }, 1500));
                    }
                    try {
                        editor.setContents(JSON.parse(sectionData.content));
                    } catch(e) {
                        editor.setText(sectionData.content || '');
                    }
                }

                renderSidebar();
                renderAiPanel(sectionId);
            };

            // Helper function to escape HTML for display in data attributes
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            sections = await getProjectSections(userId, projectId);
            await loadSection(activeSectionId);
        }

        //======================================================================
        // --- MAIN APPLICATION LOGIC ---
        //======================================================================

        let mainCurrentUserId = null;

        function navigateTo(viewName, data = {}) {
            appContainer.innerHTML = '';
            // Ensure body overflow is managed correctly based on view
            document.body.style.overflow = (viewName === 'landing' || viewName === 'dashboard') ? 'auto' : 'hidden';

            // Control visibility of theme switcher
            const themeSwitcher = document.getElementById('theme-switcher');
            if (themeSwitcher) {
                themeSwitcher.style.display = (viewName === 'landing' || viewName === 'dashboard') ? 'block' : 'none';
            }


            if (viewName === 'editor' && data.projectId) {
                document.location.hash = `editor/${data.projectId}`;
            } else if (viewName === 'dashboard') {
                document.location.hash = 'dashboard';
            } else {
                document.location.hash = '';
            }

            switch (viewName) {
                case 'landing': renderLandingPage(); break;
                case 'dashboard': if (mainCurrentUserId) renderDashboard(mainCurrentUserId); break;
                case 'editor': if (mainCurrentUserId && data.projectId) renderEditor(mainCurrentUserId, data.projectId); break;
                default: if(mainCurrentUserId) renderDashboard(mainCurrentUserId); else renderLandingPage();
            }
        }

        // --- App Startup ---
        document.addEventListener('DOMContentLoaded', () => {
            const auth = initializeAuth(firebaseConfig);
            initializeDb(firebaseConfig);

            function handleThemeSwitching() {
                function applyTheme(themeName) {
                    document.documentElement.className = '';
                    document.documentElement.classList.add(themeName);
                    document.querySelectorAll('.theme-button').forEach(btn => {
                        btn.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-gray-900', 'ring-white');
                        if (btn.dataset.theme === themeName) btn.classList.add('ring-2', 'ring-offset-2', 'ring-offset-gray-900', 'ring-white');
                    });
                    currentTheme = themeName; // Update global theme tracker
                    // Re-render dashboard to apply new border colors
                    if (document.location.hash === '#dashboard' && mainCurrentUserId) {
                        renderDashboard(mainCurrentUserId);
                    }
                }
                document.body.addEventListener('click', (event) => {
                    if (event.target.matches('.theme-button')) {
                        applyTheme(event.target.dataset.theme);
                    }
                });
            }
            handleThemeSwitching();

            onAuth(async (user) => {
                if (user) {
                    mainCurrentUserId = user.uid;
                    currentUserId = user.uid;

                    // Check if the user is anonymous and display a prompt to link account
                    if (user.isAnonymous) {
                        showNotification('You are signed in as a guest. Your data may be lost if you clear browser data. Consider signing up to save your work permanently!', 'info', 7000);
                    }

                    const hash = document.location.hash;
                    if (hash.startsWith('#editor/')) {
                        const projectId = hash.split('/')[1];
                        navigateTo('editor', { projectId });
                    } else {
                        navigateTo('dashboard');
                    }
                } else {
                    mainCurrentUserId = null;
                    currentUserId = null;
                    navigateTo('landing');
                }
            });

            document.body.addEventListener('click', (event) => {
                const target = event.target.closest('.nav-button, [data-route]');
                if (target) {
                    event.preventDefault();
                    const view = target.dataset.route;
                    const projectId = target.dataset.id;
                    navigateTo(view, { projectId });
                }
            });
        });
    </script>

</body>
</html>
