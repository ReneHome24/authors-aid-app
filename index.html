<!DOCTYPE html>
<html lang="en" class="theme-default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Author's Aid | Your AI Co-author for Christian Literature</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
    <!-- Font Awesome for eye icon and loading spinner -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        html, body {
            height: 100%;
            /* FIX: Removed overflow: hidden; from the body to allow for the new flex layout */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #D1D5DB; /* Set a light default text color for the whole body */
        }
        .font-lora { font-family: 'Lora', serif; }

        /* --- THEME DEFINITIONS --- */
        .theme-default .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(59, 130, 246, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(139, 92, 246, 0.08), transparent 60%); }
        .theme-default .accent-bg { background-color: #2563eb; }
        .theme-default .accent-bg-hover:hover { background-color: #1d4ed8; }
        .theme-default .accent-text { color: #60a5fa; }
        .theme-default .accent-text-hover:hover { color: #3b82f6; }
        .theme-default .accent-ring:focus { ring-color: #3b82f6; }
        .theme-default .ui-bg { background-color: #1f2937; }

        .theme-red .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(220, 38, 38, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(159, 18, 57, 0.1), transparent 60%); }
        .theme-red .accent-bg { background-color: #dc2626; }
        .theme-red .accent-bg-hover:hover { background-color: #b91c1c; }
        .theme-red .accent-text { color: #f87171; }
        .theme-red .accent-text-hover:hover { color: #ef4444; }
        .theme-red .accent-ring:focus { ring-color: #ef4444; }
        .theme-red .ui-bg { background-color: #261717; }


        .theme-gold .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(252, 211, 77, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(245, 158, 11, 0.1), transparent 60%); }
        .theme-gold .accent-bg { background-color: #f59e0b; }
        .theme-gold .accent-bg-hover:hover { background-color: #d97706; }
        .theme-gold .accent-text { color: #fcd34d; }
        .theme-gold .accent-text-hover:hover { color: #fbbf24; }
        .theme-gold .accent-ring:focus { ring-color: #fbbf24; }
        .theme-gold .ui-bg { background-color: #292211; }

        .theme-green .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(16, 185, 129, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(5, 150, 105, 0.1), transparent 60%); }
        .theme-green .accent-bg { background-color: #059669; }
        .theme-green .accent-bg-hover:hover { background-color: #047857; }
        .theme-green .accent-text { color: #34d399; }
        .theme-green .accent-text-hover:hover { color: #10b981; }
        .theme-green .accent-ring:focus { ring-color: #10b981; }
        .theme-green .ui-bg { background-color: #132a23; }

        .theme-purple .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(139, 92, 246, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(124, 58, 237, 0.1), transparent 60%); }
        .theme-purple .accent-bg { background-color: #7c3aed; }
        .theme-purple .accent-bg-hover:hover { background-color: #6d28d9; }
        .theme-purple .accent-text { color: #a78bfa; }
        .theme-purple .accent-text-hover:hover { color: #8b5cf6; }
        .theme-purple .accent-ring:focus { ring-color: #8b5cf6; }
        .theme-purple .ui-bg { background-color: #241c33; }

        /* Quill Editor specific styles */
        .ql-container { border: none !important; display: flex; flex-direction: column; height: 100%; }
        .ql-editor {
            flex-grow: 1; /* Allow editor to take available height */
            font-family: 'Lora', serif;
            font-size: 1.125rem;
            line-height: 1.75;
            background-color: #111827;
            color: #D1D5DB !important; /* FIX: Added !important to ensure text is always light */
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto; /* Ensure Quill editor content scrolls */
            padding-top: 0 !important; 
            padding-bottom: 1rem; 
        }
        /* Adjust the first line of content within Quill to start immediately */
        .ql-editor p:first-child,
        .ql-editor h1:first-child,
        .ql-editor h2:first-child,
        .ql-editor h3:first-child,
        .ql-editor ol:first-child,
        .ql-editor ul:first-child {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        .ql-toolbar {
            background-color: #1F2937 !important;
            border-top-left-radius: 8px !important;
            border-top-right-radius: 8px !important;
            border: 1px solid #374151 !important;
            border-bottom: none !important;
        }
        .ql-snow .ql-stroke { stroke: #9CA3AF !important; }
        .ql-snow .ql-picker-label { color: #9CA3AF !important; }
        .ql-snow .ql-picker-options { background-color: #374151 !important; color: #D1D5DB !important; }

        /* Custom scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1F2937; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }

        /* Styles for password toggle */
        .password-input-container {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9CA3AF;
        }

        /* Book Cover Selection Styles */
        .cover-image-wrapper {
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden; /* Ensure border-radius clips content */
        }
        .cover-image-wrapper:hover {
            border-color: #60a5fa; /* Accent color on hover */
        }
        .cover-image-wrapper.selected {
            border-color: #3b82f6; /* Stronger accent color when selected */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); /* Glowing effect */
        }
        .cover-image-wrapper img {
            display: block; /* Remove extra space below image */
        }
        .cover-selection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .cover-image-wrapper.selected .cover-selection-overlay {
            opacity: 1;
        }

        /* Loading spinner for buttons */
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 1em;
            height: 1em;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5em;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom style for dashboard card border based on theme */
        .project-card.theme-border-default { border-color: #2563eb; }
        .project-card.theme-border-red { border-color: #dc2626; }
        .project-card.theme-border-gold { border-color: #f59e0b; }
        .project-card.theme-border-green { border-color: #059669; }
        .project-card.theme-border-purple { border-color: #7c3aed; }

        /* FIX: Style for placeholder text */
        textarea::placeholder, input::placeholder {
            color: #6B7280; /* A light gray */
        }
        
        /* Styles for interactive suggestions */
        .suggestion-item {
            background-color: #374151;
            border-left: 3px solid #60a5fa;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }
        .suggestion-original {
            text-decoration: line-through;
            color: #9CA3AF;
            font-size: 0.8rem;
        }
        .suggestion-replacement {
            cursor: pointer;
            color: #F3F4F6;
            font-weight: 500;
        }
        .suggestion-replacement:hover {
            background-color: #4B5563;
        }


    </style>
</head>
<body>
    
    <!-- Main Application Container -->
    <div id="app-container" class="h-screen flex flex-col"></div>

    <!-- Notification & Modal Containers -->
    <div id="notification-container" class="fixed bottom-20 right-5 z-50"></div>
    <div id="modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4"></div>

    <!-- Theme Switcher (Global) -->
    <div id="theme-switcher" class="fixed bottom-4 right-4 bg-gray-900/80 backdrop-blur-sm p-3 rounded-xl border border-gray-700 shadow-lg">
        <div class="flex space-x-2">
            <button data-theme="theme-default" class="theme-button w-6 h-6 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-offset-gray-900 ring-white" title="Default Blue"></button>
            <button data-theme="theme-red" class="theme-button w-6 h-6 rounded-full bg-red-500" title="Redeemer's Red"></button>
            <button data-theme="theme-gold" class="theme-button w-6 h-6 rounded-full bg-amber-400" title="Golden Light"></button>
            <button data-theme="theme-green" class="theme-button w-6 h-6 rounded-full bg-emerald-500" title="Graceful Green"></button>
            <button data-theme="theme-purple" class="theme-button w-6 h-6 rounded-full bg-violet-500" title="Royal Purple"></button>
        </div>
    </div>

    <!-- Global Footer for all views -->
    <footer id="app-global-footer" class="ui-bg p-4 border-t border-gray-700 flex-shrink-0 hidden">
        <div id="footer-content-landing-dashboard" class="container mx-auto text-center text-gray-500 hidden">
            <p>&copy; 2025 Author's Aid. All Rights Reserved.</p>
            <p class="mt-2 text-sm">Created with faith for Rene' Stanley.</p>
        </div>
        <div id="footer-content-editor" class="container mx-auto flex justify-between items-center hidden">
             <!-- Chapter Navigation -->
            <div class="flex items-center space-x-2">
                <button id="prev-chapter-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">&lt; Prev Chapter</button>
                <button id="add-chapter-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">+ New Chapter</button>
                <button id="next-chapter-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Next Chapter &gt;</button>
            </div>
            <button id="export-project-btn" class="accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Export Project</button>
        </div>
    </footer>

    <!-- ALL APPLICATION JAVASCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut as firebaseSignOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, linkWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, serverTimestamp, query, onSnapshot, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVsziM6I1QEU22YNPGTwLvN0EuW4k2SiY",
            authDomain: "christian-author-app-54c4d.firebaseapp.com",
            projectId: "christian-author-app-54c4d",
            // FIX: Corrected the storage bucket URL to match your project's actual address
            storageBucket: "christian-author-app-54c4d.firebasestorage.app",
            messagingSenderId: "386312831448",
            appId: "1:386312831448:web:80999eae638bbed28572ad"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        //======================================================================
        // --- CONSOLIDATED JAVASCRIPT MODULES ---
        //======================================================================

        // --- auth.js content ---
        let authInstance;
        function initializeAuth(config) { if (!authInstance) { const app = initializeApp(config); authInstance = getAuth(app); } return authInstance; }
        function onAuth(callback) { return onAuthStateChanged(authInstance, callback); }
        async function signInAnon() {
            try {
                const result = await signInAnonymously(authInstance);
                showNotification('Signed in as guest!', 'success');
                return result;
            } catch (e) {
                console.error("Anon sign-in failed:", e);
                showNotification(`Guest sign-in failed: ${e.message}`, 'error');
            }
        }
        async function signOut() {
            try {
                await firebaseSignOut(authInstance);
                showNotification('Signed out successfully.', 'info');
            } catch (e) {
                console.error("Sign-out failed:", e);
                showNotification(`Sign-out failed: ${e.message}`, 'error');
            }
        }

        // New authentication functions
        async function signUpWithEmail(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(authInstance, email, password);
                showNotification('Account created successfully!', 'success');
                return userCredential.user;
            } catch (e) {
                console.error("Sign-up failed:", e);
                showNotification(`Sign-up failed: ${e.message}`, 'error');
                return null;
            }
        }

        async function signInWithEmail(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(authInstance, email, password);
                showNotification('Logged in successfully!', 'success');
                return userCredential.user;
            } catch (e) {
                console.error("Login failed:", e);
                showNotification(`Login failed: ${e.message}`, 'error');
                return null;
            }
        }

        async function linkGuestAccount(email, password) {
            try {
                const credential = EmailAuthProvider.credential(authInstance.currentUser.email, password); // Use current user's email if available
                await linkWithCredential(authInstance.currentUser, credential);
                showNotification('Guest account linked successfully!', 'success');
                return true;
            } catch (e) {
                console.error("Linking guest account failed:", e);
                showNotification(`Linking account failed: ${e.message}`, 'error');
                return false;
            }
        }

        // --- firestore.js content ---
        let dbInstance;
        let storageInstance; // Declare storage instance globally for access
        function initializeDb(config) {
            if (!dbInstance) {
                const app = initializeApp(config);
                dbInstance = getFirestore(app);
                storageInstance = getStorage(app); // Initialize Storage
            }
            return dbInstance;
        }
        function getProjectsCollection(userId) { return collection(dbInstance, `artifacts/${appId}/users/${userId}/projects`); }
        async function createProject(userId, data) {
            try {
                const projectRef = await addDoc(getProjectsCollection(userId), { ...data, createdAt: serverTimestamp(), lastModified: serverTimestamp() });
                const sectionsCollection = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectRef.id}/sections`);
                const emptyContent = JSON.stringify({ ops: [{ insert: '\n' }] });
                
                const sectionsToAdd = [
                    { id: 'metadata', title: 'Project Metadata', content: JSON.stringify({ authorName: '', copyrightYear: '', publisher: '', isbn: '', seriesName: '', seriesNumber: '', lccn: '' }), order: 0 },
                    { id: 'brainstorming', title: 'Synopsis & Brainstorming', content: emptyContent, order: 1 },
                    { id: 'book_titles', title: 'Book Titles', content: emptyContent, order: 2 },
                    { id: 'character_development', title: 'Character Development', content: emptyContent, order: 3 },
                    { id: 'world_building', title: 'World-building', content: emptyContent, order: 4 },
                    { id: 'outline', title: 'Outline', content: emptyContent, order: 5 },
                    { id: 'book_cover', title: 'Book Cover', content: '', order: 6 },
                    { id: 'copyright', title: 'Copyright', content: emptyContent, order: 7 },
                    { id: 'dedication', title: 'Dedication', content: emptyContent, order: 8 },
                    { id: 'preface', title: 'Preface', content: emptyContent, order: 9 },
                    { id: 'acknowledgments', title: 'Acknowledgments', content: emptyContent, order: 10 },
                    { id: 'chapter_1', title: 'Chapter 1', content: emptyContent, order: 11 },
                    { id: 'about_the_author', title: 'About the Author', content: emptyContent, order: 100 },
                    { id: 'discussion_questions', title: 'Discussion Questions', content: emptyContent, order: 101 },
                ];

                for (const section of sectionsToAdd) {
                    await setDoc(doc(sectionsCollection, section.id), { title: section.title, content: section.content, order: section.order });
                }
                
                return projectRef.id;
            } catch (e) { console.error("Error creating project:", e); showNotification(`Error creating project: ${e.message}`, 'error'); }
        }
        async function addChapter(userId, projectId, chapterNumber) {
             try {
                const sectionsCollection = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`);
                const newChapterId = `chapter_${chapterNumber}`;
                const emptyContent = JSON.stringify({ ops: [{ insert: '\n' }] });
                // Base order for chapters starts after the initial front matter.
                const baseOrder = 11;
                await setDoc(doc(sectionsCollection, newChapterId), { title: `Chapter ${chapterNumber}`, content: emptyContent, order: baseOrder + chapterNumber - 1 });
                return true;
            } catch (e) { console.error("Error adding chapter:", e); showNotification(`Error adding chapter: ${e.message}`, 'error'); return false; }
        }
        async function getProjects(userId) { try { const qSnapshot = await getDocs(getProjectsCollection(userId)); const projects = []; qSnapshot.forEach(d => projects.push({ id: d.id, ...d.data() })); projects.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); return projects; } catch (e) { console.error("Error fetching projects:", e); showNotification(`Error fetching projects: ${e.message}`, 'error'); return []; } }
        async function getProject(userId, projectId) { try { const docRef = doc(getProjectsCollection(userId), projectId); const docSnap = await getDoc(docRef); return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null; } catch (e) { console.error("Error fetching project:", e); showNotification(`Error fetching project: ${e.message}`, 'error'); } }
        async function getProjectSections(userId, projectId) { try { const sectionsRef = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`); const q = query(sectionsRef, orderBy("order")); const qSnapshot = await getDocs(q); const sections = []; qSnapshot.forEach(d => sections.push({ id: d.id, ...d.data() })); return sections; } catch (e) { console.error("Error fetching sections:", e); showNotification(`Error fetching sections: ${e.message}`, 'error'); return []; } }
        async function getSection(userId, projectId, sectionId) { try { const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, sectionId); const docSnap = await getDoc(sectionRef); return docSnap.exists() ? docSnap.data() : null; } catch (e) { console.error("Error getting section:", e); showNotification(`Error getting section: ${e.message}`, 'error'); return null; } }
        async function updateSectionContent(userId, projectId, sectionId, content) { try { const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, sectionId); await updateDoc(sectionRef, { content }); const projectRef = doc(getProjectsCollection(userId), projectId); await updateDoc(projectRef, { lastModified: serverTimestamp() }); } catch (e) { console.error("Error updating section:", e); showNotification(`Error updating section: ${e.message}`, 'error'); } }
        async function updateProjectCover(userId, projectId, coverUrl) { // New function to update project cover
            try {
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { bookCoverUrl: coverUrl, lastModified: serverTimestamp() });
                showNotification('Book cover saved successfully!', 'success');
            } catch (e) {
                console.error("Error updating project cover:", e);
                showNotification(`Error saving cover: ${e.message}`, 'error');
            }
        }
        // New function to update project title
        async function updateProjectTitle(userId, projectId, newTitle) {
            try {
                const cleanedTitle = stripMarkdownAndHtml(newTitle); // Strip markdown before saving
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { title: cleanedTitle, lastModified: serverTimestamp() });
                showNotification('Project title updated!', 'success');
            } catch (e) {
                console.error("Error updating project title:", e);
                showNotification(`Error updating project title: ${e.message}`, 'error');
            }
        }
        
        // START: New function to auto-populate the copyright page
        async function populateCopyrightPage(userId, projectId, metadata) {
            if (!metadata.authorName || !metadata.copyrightYear) {
                return; // Don't run if essential data is missing
            }
            const copyrightText = `Copyright © ${metadata.copyrightYear} by ${metadata.authorName}\n\nAll rights reserved. No part of this publication may be reproduced, distributed, or transmitted in any form or by any means, including photocopying, recording, or other electronic or mechanical methods, without the prior written permission of the publisher, except in the case of brief quotations embodied in critical reviews and certain other noncommercial uses permitted by copyright law.\n\nISBN: ${metadata.isbn || 'Not available'}\nLibrary of Congress Control Number: ${metadata.lccn || 'Not available'}`;
            
            const quillContent = JSON.stringify({ ops: [{ insert: copyrightText + '\n' }] });
            await updateSectionContent(userId, projectId, 'copyright', quillContent);
            showNotification('Copyright page auto-updated!', 'info', 2000);
        }
        // END: New function

        // New function to update project metadata
        async function updateProjectMetadata(userId, projectId, metadata) {
            try {
                const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, 'metadata');
                await updateDoc(sectionRef, { content: JSON.stringify(metadata) });
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { lastModified: serverTimestamp() });
                
                // START: Call the new function to update copyright page
                await populateCopyrightPage(userId, projectId, metadata);
                // END: Call the new function
                
                showNotification('Project metadata saved!', 'success');
            } catch (e) {
                console.error("Error updating project metadata:", e);
                showNotification(`Error saving metadata: ${e.message}`, 'error');
            }
        }

        async function deleteProject(userId, projectId) {
            try {
                await deleteDoc(doc(getProjectsCollection(userId), projectId));
                showNotification('Project deleted.', 'success');
            } catch (e) {
                console.error("Error deleting project:", e);
                showNotification(`Error deleting project: ${e.message}`, 'error');
            }
        }

        // --- utils.js content ---
        function debounce(func, wait) { let timeout; return function(...args) { const later = () => { clearTimeout(timeout); func(...args); args = null; }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
        function showNotification(message, type = 'info', duration = 3000) { const container = document.getElementById('notification-container'); if (!container) return; const notification = document.createElement('div'); let bgColor; switch(type){ case 'success': bgColor='bg-green-500/90 border-green-400'; break; case 'error': bgColor='bg-red-500/90 border-red-400'; break; default: bgColor='bg-blue-500/90 border-blue-400'; break; } notification.className = `p-4 rounded-lg shadow-xl text-white ${bgColor} border mb-4 opacity-0 transition-all duration-500`; notification.innerHTML = message; container.appendChild(notification); setTimeout(() => notification.classList.remove('opacity-0'), 10); setTimeout(() => { notification.classList.add('opacity-0'); notification.addEventListener('transitionend', () => notification.remove()); }, duration); }
        function showModal(title, contentHtml, onConfirm, confirmText = 'Confirm', showCancel = true) {
            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) return;
            modalContainer.innerHTML = `<div class="bg-gray-800 text-gray-200 rounded-lg shadow-2xl w-full max-w-lg p-6 border border-gray-700"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-lora font-bold">${title}</h2><button id="modal-close-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button></div><div id="modal-content" class="max-h-[70vh] overflow-y-auto">${contentHtml}</div><div class="mt-6 flex justify-end space-x-4">${showCancel ? '<button id="modal-cancel-btn" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 transition-colors">Cancel</button>' : ''}<button id="modal-confirm-btn" type="submit" class="py-2 px-4 rounded-lg accent-bg accent-bg-hover transition-colors font-semibold">${confirmText}</button></div></div>`;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            const closeModal = () => { modalContainer.classList.add('hidden'); modalContainer.classList.remove('flex'); modalContainer.innerHTML = ''; };
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            if (showCancel) {
                document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
            }
            // Reverted: Attach onConfirm directly to the button click for simplicity,
            // as the form submit listener was causing issues.
            const confirmBtn = document.getElementById('modal-confirm-btn');
            if(onConfirm) {
                 confirmBtn.addEventListener('click', async () => {
                    const form = modalContainer.querySelector('form');
                    if (form && !form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    await onConfirm();
                    closeModal();
                });
            } else {
                confirmBtn.addEventListener('click', closeModal);
            }
            

            // Add password toggle functionality after modal content is rendered
            modalContainer.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const passwordInput = toggle.previousElementSibling; // The input field is the previous sibling
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    toggle.querySelector('i').classList.toggle('fa-eye');
                    toggle.querySelector('i').classList.toggle('fa-eye-slash');
                });
            });
        }

        // Helper function to strip common Markdown bold/italic markers, HTML tags, and leading numbers/hashes
        function stripMarkdownAndHtml(text) {
            if (!text) return '';
            let cleanedText = text;

            // FIX: More robustly remove Markdown bold/italic markers, including asterisks
            cleanedText = cleanedText.replace(/\*\*(.*?)\*\*/g, '$1'); // bold with **
            cleanedText = cleanedText.replace(/__(.*?)__/g, '$1');   // bold with __
            cleanedText = cleanedText.replace(/\*(.*?)\*/g, '$1');   // italic with *
            cleanedText = cleanedText.replace(/_(.*?)_/g, '$1');   // italic with _
            cleanedText = cleanedText.replace(/\*/g, ''); // Remove any remaining single asterisks

            // Remove Markdown headings (# at start of line)
            cleanedText = cleanedText.replace(/^#+\s*/gm, ''); // Remove # and leading space at start of line

            // Remove common HTML tags (basic approach, not for complex HTML)
            cleanedText = cleanedText.replace(/<[^>]*>/g, '');

            return cleanedText.trim();
        }

        // New helper to parse numbered lists from AI, removing intros and numbers
        function parseNumberedAiList(aiText, keepNumbers = false) {
            if (!aiText) return [];
            const results = [];

            // First, try to split by numbered list format (e.g., "1. Text")
            let lines = aiText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            // Remove any intro line that doesn't start with a number.
            if (lines.length > 0 && !lines[0].match(/^(\d+)\.\s*(.*)/) && !lines[0].toLowerCase().includes('name:')) {
                lines.shift();
            }

            let hasNumberedItems = false;
            for (const line of lines) {
                if (line.match(/^(\d+)\.\s*(.*)/)) {
                    hasNumberedItems = true;
                    break;
                }
            }

            if (hasNumberedItems) {
                let currentItem = '';
                for (const line of lines) {
                    const match = line.match(/^(\d+)\.\s*(.*)/);
                    if (match) {
                        if (currentItem) results.push(currentItem.trim());
                        const content = match[2];
                        currentItem = keepNumbers ? `${match[1]}. ${content}` : content;
                    } else {
                        currentItem += `\n${line}`;
                    }
                }
                if(currentItem) results.push(currentItem.trim());
            } else {
                // If no numbered list is found, assume it's paragraphs separated by double newlines or just newlines for characters
                const paragraphs = aiText.split(/\n\s*\n/).map(p => p.trim()).filter(p => p.length > 0);
                for (const paragraph of paragraphs) {
                    results.push(paragraph);
                }
            }
            return results;
        }

        function escapeHTML(unsafe) {
            // FIX: Handle non-string inputs by converting them to strings first
            const toStr = String(unsafe);
            return toStr
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }


        // --- aiService.js content ---
        const API_KEY = "AIzaSyCVsziM6I1QEU22YNPGTwLvN0EuW4k2SiY"; // User's provided API Key
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;

        // Global variable to store AI style preference
        let aiStylePreference = "";

        // Knowledge base for character types
        const characterTypesKnowledge = `
Characters are the lifeblood of fiction, driving the plot and engaging readers. While every character should feel unique and real, they often fall into certain categories or roles within a manuscript. Here's a breakdown of different types of characters, often considered in terms of their role, dynamism, and archetypal qualities:
I. By Role in the Narrative:
Protagonist: The central character of the story. The plot usually revolves around their journey, goals, and development. Readers are meant to invest in and care about them. There can be multiple protagonists in a story.
Examples: Katniss Everdeen (The Hunger Games), Harry Potter (Harry Potter series), Elizabeth Bennet (Pride and Prejudice).
Antagonist: The character or force that opposes the protagonist and creates conflict. They don't always have to be "evil"; sometimes they simply represent an opposing viewpoint or obstacle.
Examples: Lord Voldemort (Harry Potter series), President Coriolanus Snow (The Hunger Games), Mr. Darcy (initially, in Pride and Prejudice). An antagonist can also be an inanimate force like nature or society.
Deuteragonist: The second most important character, often serving as a close ally or companion to the protagonist. They might offer a different perspective or have their own subplot.
Examples: Dr. John Watson (Sherlock Holmes), Samwise Gamgee (Lord of the Rings).
Confidant(e): A character in whom the protagonist trusts and shares their thoughts and feelings. This allows the author to reveal the protagonist's inner world to the reader without relying solely on internal monologue.
Examples: Hermione Granger (Harry Potter series), Albus Dumbledore (Harry Potter series).
Love Interest: The romantic counterpart to the protagonist. Their relationship often impacts the protagonist's development and the overall plot.
Examples: Peeta Mellark (The Hunger Games), Mr. Darcy (later, in Pride and Prejudice).
Mentor: A wise and experienced character who guides, advises, and supports the protagonist. They often provide knowledge, training, or a moral compass.
Examples: Obi-Wan Kenobi (Star Wars), Albus Dumbledore (Harry Potter series).
Foil: A character who highlights the qualities (often contrasting ones) of another character, usually the protagonist, through comparison. They aren't necessarily antagonists.
Examples: Draco Malfoy to Harry Potter (highlighting Harry's inherent goodness), Effie Trinket to Katniss Everdeen (highlighting Katniss's grounded nature).
Sidekick: A character who supports the protagonist, often offering comic relief, practical assistance, or a loyal friendship.
Examples: Ron Weasley (Harry Potter series), Samwise Gamgee (Lord of Lord of the Rings).
Tertiary/Minor Characters (or Extras): Background characters who populate the story's world and add realism. They may have brief appearances and serve specific, often limited, functions.
II. By Dynamism and Complexity:
Dynamic Character: A character who undergoes significant internal change, growth, or transformation throughout the story due to the events they experience.
Examples: Ebenezer Scrooge (A Christmas Carol), Harry Potter (as he matures throughout the series).
Static Character: A character who remains largely the same throughout the story, without significant internal change. They often serve to highlight the changes in dynamic characters or maintain consistency in the narrative.
Examples: Many side characters or minor antagonists who have a fixed role.
Round Character: A complex and well-developed character with multiple personality traits, motivations, and sometimes contradictions, making them feel realistic and multifaceted. Dynamic characters are usually round.
Flat Character: A less developed character, often defined by one or two dominant traits. They typically serve a specific purpose in the plot or to represent a stereotype, rather than undergoing deep personal change. Stock characters (see below) are often flat.
Stock Character: A stereotypical character that is instantly recognizable due to recurring traits in various stories and genres (e.g., the "mad scientist," the "tough detective," the "damsel in distress"). While they can be clichés if not handled well, they can also be useful for quickly establishing a type of character.
Symbolic Character: A character who represents a larger idea, theme, or concept within the story, often beyond their literal role.
Example: Boo Radley in To Kill a Mockingbird can symbolize the hidden goodness in society or the innocence destroyed by prejudice.
III. By Archetype (based on Jungian psychology and recurring patterns in storytelling):
Archetypes are universally recognizable character types that resonate across cultures and time periods. While a character's role might be "protagonist," their archetype might be "The Hero."
Some common archetypes include:
The Hero: Embarks on a journey, faces challenges, and undergoes transformation to achieve a goal. (Often the protagonist).
The Innocent: Pure, optimistic, and seeks happiness. Vulnerable but can inspire others.
The Sage/Mentor: Possesses wisdom, knowledge, and guides others.
The Explorer: Driven by curiosity and a desire to push boundaries, seeking discovery and self-improvement.
The Ruler: Seeks control and power, often responsible for order or chaos.
The Creator: A visionary who brings new things into existence (art, ideas, structures).
The Caregiver: Nurturing, selfless, and protective of others.
The Everyman/Everywoman: Relatable and ordinary, representing the common person.
The Lover: Guided by the heart, valuing connection, passion, and sensuality.
The Jester/Trickster: Provides comic relief, challenges the status quo, and can be mischievous or insightful.
The Rebel/Outlaw: Defies societal norms and seeks revolution or freedom.
The Magician: Possesses special knowledge or abilities, often transforming things.
The Shadow: Represents the dark side of human nature, often the antagonist or an internal struggle within the protagonist.
Understanding these different types of characters can help authors create a diverse and compelling cast, ensuring that each character serves a purpose in advancing the plot, exploring themes, and engaging the reader.
`;
        // Function to call Imagen API for image generation
        async function generateImage(prompt) {
            console.log("generateImage: Starting image generation for prompt:", prompt);
            try {
                // Show loading spinner for image generation
                // Moved loading spinner to coverDisplayContainer
                document.getElementById('cover-display-container').innerHTML = `<div class="flex items-center justify-center py-4"><div class="loading-spinner"></div><span class="ml-2">Generating images...</span></div>`;

                const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 3 } }; // Request 3 images
                console.log("generateImage: Sending payload to Imagen API:", payload);
                const response = await fetch(IMAGEN_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Imagen API Error Response:", errorData);
                    let errorMessage = `Image generation failed with status ${response.status}.`;
                    if (errorData && errorData.error && errorData.error.message) {
                        errorMessage += ` Details: ${errorData.error.message}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log("generateImage: Received Imagen API response:", result);
                if (result.predictions && result.predictions.length > 0) {
                    const imageUrls = result.predictions.map(p => `data:image/png;base64,${p.bytesBase64Encoded}`);
                    console.log("generateImage: Generated image URLs:", imageUrls);
                    return imageUrls;
                } else {
                    console.error("Imagen Error: Unexpected response structure or no predictions:", result);
                    return [];
                }
            } catch (e) {
                console.error("Error calling Imagen API:", e);
                showNotification(`Image generation failed: ${e.message}`, 'error');
                return [];
            } finally {
                // The outputDiv will be managed by the calling function (ai-cover-concept-btn handler)
                // coverDisplayContainer will be updated by the calling function
            }
        }


        async function callGemini(contents, generationConfig = {}) {
            console.log("callGemini: Starting Gemini call with contents:", contents);
            try {
                // Show loading spinner for Gemini calls
                document.getElementById('ai-output').innerHTML = `<div class="flex items-center justify-center py-4"><div class="loading-spinner"></div><span class="ml-2">Generating...</span></div>`;

                // Prepend style preference to the prompt
                const finalContents = contents.map(item => {
                    if (item.parts && item.parts.length > 0 && item.parts[0].text) {
                        return {
                            ...item,
                            parts: [{ text: `AI Style Preference: ${aiStylePreference}\n\n${item.parts[0].text}` }]
                        };
                    }
                    return item;
                });
                console.log("callGemini: Final contents sent to Gemini:", finalContents);

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: finalContents, generationConfig })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("AI API Error Response:", errorData);
                    let errorMessage = `API request failed with status ${response.status}.`;
                    if (response.status === 403) {
                        errorMessage += " This usually means the API is not enabled for your Google Cloud project or your API key has insufficient permissions.";
                    } else if (response.status === 429) {
                        errorMessage += " You've exceeded your API quota. Please try again later.";
                    } else if (errorData && errorData.error && errorData.error.message) {
                        errorMessage += ` Details: ${errorData.error.message}`;
                    } else {
                        errorMessage += ` Details: ${JSON.stringify(errorData.error || errorData)}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log("callGemini: Received Gemini API response:", result);
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    const textResult = result.candidates[0].content.parts[0].text;
                    console.log("callGemini: Extracted text result:", textResult);
                    return textResult;
                } else {
                    console.error("AI Error: Unexpected response structure or no content in Gemini response:", result);
                    return "Error: Could not generate content (unexpected AI response).";
                }
            } catch (e) {
                console.error("Error calling Gemini API:", e);
                showNotification(`AI call failed: ${e.message}`, 'error');
                return `Error: API call failed: ${e.message}`;
            } finally {
                // The outputDiv will be managed by the calling function
            }
        }


        async function generateSynopsisIdeas(idea) {
            // Updated prompt to be more specific about Christian literature and explicitly exclude titles.
            const prompt = `You are an AI story consultant for Christian literature. Based on the user's basic idea, generate a numbered list of 5 distinct core concept ideas for a new Christian book. Each concept should be a single, concise paragraph describing the core idea, without suggesting a title. The tone should be encouraging and creative.\n\nBasic Idea: "${idea}"`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateOutlineBeats(context, bookTitle) { // Added bookTitle parameter
            // Ensure outline generation uses all relevant context
            const prompt = `You are an AI outliner for a Christian author. Based on the provided project details (synopsis, characters, world-building, and desired book title), generate a detailed chapter-by-chapter outline with key beats for each chapter. Ensure the outline aligns with Christian themes and values established in the context.
            **IMPORTANT:** When referring to characters in the outline beats, ALWAYS use their specific character names (e.g., "Amara," "Nana Elena") instead of their roles (e.g., "protagonist," "mentor"). This is especially crucial for the protagonist.

            Start the outline with the book title:
            ${bookTitle}

            For each chapter, list the chapter title (without asterisks or bold formatting), and then provide a numbered list of key beats for that chapter. For example:
            Chapter 1: The Beginning
            1. Beat 1 of Chapter 1: Introduce protagonist and their core conflict.
            2. Beat 2 of Chapter 1: Character meets mentor.
            3. Beat 3 of Chapter 1: Call to adventure.

            Project Details:
            ---
            ${context}
            ---

            Generate the chapter-by-chapter outline:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateCharacterProfiles(context) {
            // Ensure character generation uses synopsis and title context
            const prompt = `You are an AI character developer for Christian fiction. Based on the provided project details (synopsis, book title), generate a numbered list of 5 distinct character profile ideas. Each profile should include a name, a brief backstory, core motivations, personality quirks, and **explicitly identify what type of character they are based on the following taxonomy (By Role, By Dynamism and Complexity, and By Archetype).** Ensure characters are suitable for a Christian narrative, exploring themes of faith, redemption, struggle, or virtue. Do not include any introductory text before the first character.

${characterTypesKnowledge}

Project Details:
---
${context}
---

Generate 5 character profiles:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateWorldPrompts(context) {
            // FIX: Updated prompt to explicitly exclude titles and focus only on world-building elements.
            const prompt = `You are an AI world-builder for Christian narratives. Based on the provided project details (synopsis, book title, characters), generate a numbered list of 5 distinct world-building element ideas. These could include unique faith-based societal structures, spiritual challenges, miraculous phenomena, or historical events relevant to a Christian story. Provide ONLY the descriptive world-building idea, without suggesting a title for the idea itself.
            \n\nProject Details:\n---\n${context}\n---\n\nGenerate 5 world-building prompts:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function suggestAlternatives(selectedText, context) { 
            const prompt = `You are an AI thesaurus and editor for Christian literature. The user has selected a sentence and wants alternative phrasing for its key ideas. Analyze the following sentence and provide a list of alternative phrases for the most significant parts. Do not suggest alternatives for the entire sentence, but for its core components.
            \n\nContext:\n---\n${context}\n---\n\nSelected Text: "${selectedText}"
            \n\nProvide alternatives as a JSON array of objects, where each object has "original" and "suggestion" keys. For example: [{"original": "a generation to guard their hearts", "suggestion": "a generation to shield their hearts"}].`; 
            const config = {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            original: { type: "STRING" },
                            suggestion: { type: "STRING" }
                        },
                        required: ["original", "suggestion"]
                    }
                }
            };
            return callGemini([{ role: "user", parts: [{ text: prompt }] }], config); 
        }
        async function suggestScripture(selectedText, context) { 
            const prompt = `You are a theological assistant specializing in the NIV Bible. Based on the following selected text, suggest a list of 3 relevant NIV Bible scriptures.
            \n\nSelected Text for Context:\n---\n${context}\n---\n\nProvide the response as a JSON array of objects, where each object has "reference" and "text" keys.`; 
            const config = {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            reference: { type: "STRING" },
                            text: { type: "STRING" }
                        },
                        required: ["reference", "text"]
                    }
                }
            };
            return callGemini([{ role: "user", parts: [{ text: prompt }] }], config); 
        }
        async function suggestPOVs(context) { const prompt = `You are an AI writing coach for Christian authors. Based on the story's synopsis, generate a numbered list of 3 potential Point of View (POV) & Voice choices (e.g., First Person, Third Person Limited). For each, briefly explain how that choice would shape the narration and affect the reader's experience, particularly in a Christian context.\n\nSynopsis:\n---\n${context}\n-\n\nGenerate 3 POV & Voice options:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function suggestStructures(context) { const prompt = `You are an AI writing coach for Christian authors. Based on the story's synopsis, suggest a numbered list of 3 potential structural templates (e.g., Three-Act Structure, Hero's Journey, Fichtean Curve). For each, briefly explain why that structure would be a good fit for the story, considering its Christian themes.\n\nSynopsis:\n---\n${context}\n---\n\nSuggest 3 structural templates:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function analyzeChapter(chapterText, context) {
            // Ensure chapter analysis uses full project context
            const prompt = `You are an AI developmental editor for Christian manuscripts. Review the following book chapter in the context of the provided project details (synopsis, characters, world-building, outline, and book title). Provide high-level feedback on Pacing, Plot Progression, and Character Consistency, specifically noting how well it integrates Christian themes or moral lessons. The feedback should be constructive and encouraging.\n\nProject Details:\n---\n${context}\n---\n\nChapter Text to Analyze:\n---\n${chapterText}\n---\n\nProvide your analysis:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function proofreadChapter(chapterText) { 
            const prompt = `You are an AI proofreader. Review the following text for grammatical errors, spelling mistakes, or punctuation issues. For each suggestion, provide the original text, the proposed change, and a brief reasoning.\n\nText to Proofread:\n---\n${chapterText}\n---\n\nProvide suggestions as a JSON array of objects with keys "original", "suggestion", and "reasoning".`; 
            const config = {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            original: { type: "STRING" },
                            suggestion: { type: "STRING" },
                            reasoning: { type: "STRING" }
                        },
                        required: ["original", "suggestion", "reasoning"]
                    }
                }
            };
            return callGemini([{ role: "user", parts: [{ text: prompt }] }], config);
        }
        async function suggestYouthPhrases(selectedText, context) { const prompt = `You are an AI dialogue coach. Given the following selected text (likely dialogue) and its surrounding context, provide a numbered list of 5 alternative phrases that sound more contemporary or like common youth slang. Ensure suggestions are appropriate and fit a Christian context if possible.\n\nContext:\n---\n${context}\n---\n\nSelected Text: "${selectedText}"\n\nProvide 5 youth phrase alternatives:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); } // New AI function
        async function generateCoverConcepts(context) {
            // CORRECTED PROMPT: Explicitly tell AI to generate ONLY the descriptive prompt, no "Concept: " prefix.
            // Emphasize Christian themes for cover concepts
            const prompt = `You are an AI art director for Christian book covers. Based on the provided book synopsis, generate 3 distinct and compelling visual concepts for a book cover. Each concept should be a short, descriptive paragraph that could be used as a prompt for an AI image generator. Focus on imagery that reflects Christian themes, symbolism, or the spiritual journey of the characters. Provide ONLY the descriptive image prompt text. Do NOT include any "Concept X:" prefixes or introductory sentences like "Here are 3 distinct and compelling visual concepts...".\n\nSynopsis:\n---\n${context}\n---\n\nGenerate 3 book cover concepts:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateNext(currentText, projectTitle, outlineContent) { // Simplified context parameters
            const prompt = `You are a Christian ghostwriter. Your task is to continue the narrative for a book titled "${projectTitle}".
            Based on the following outline and the current text, write the next logical section of the story, focusing on advancing the plot according to the next relevant beat in the outline.
            Ensure the tone, style, and Christian themes are consistent with the overall manuscript.

            Overall Outline:
            ---
            ${outlineContent}
            ---

            Current Chapter Content:
            ---
            ${currentText}
            ---

            Continue the story, adhering to the outline's progression:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        // New AI function to generate titles
        async function generateTitles(context) {
            // Ensure title generation uses synopsis context and asks for Christian titles
            const prompt = `You are an AI creative assistant for Christian authors. Based on the following synopsis or brainstorming content, generate 5 distinct and compelling title suggestions for a Christian book. Provide ONLY the title and optional subtitle. Do NOT include any descriptive sentences or explanations after the title.\n\nContent:\n---\n${context}\n---\n\nGenerate 5 title suggestions:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        // New AI functions for Front and Back Matter
        async function generateFrontMatter(context, topic) {
            const prompt = `You are an AI publishing assistant for Christian authors. For a book with the following details, generate a template or example content for the "${topic}" section of the front matter.
            \n\nProject Details:\n---\n${context}\n---\n\nGenerate content for the ${topic}:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }

        async function generateBackMatter(context, topic) {
            const prompt = `You are an AI publishing assistant for Christian authors. For a book with the following details, generate a template or example content for the "${topic}" section of the back matter.
            \n\nProject Details:\n---\n${context}\n---\n\nGenerate content for the ${topic}:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }


        // --- views.js content ---
        const appContainer = document.getElementById('app-container');
        let currentUserId = null;
        // This variable will store the current selection range for 'Alternative Words' and 'Suggested Youth Phrases'
        let currentSelectionRange = null;
        let currentTheme = 'theme-default'; // Track current theme for dynamic borders

        // Function to render the Help modal
        function renderHelpModal() {
            const helpContent = `
                <div class="space-y-4 text-gray-300 overflow-y-auto max-h-[70vh] pr-4">
                    <p class="text-lg font-semibold text-white">Welcome to Author's Aid!</p>
                    <p>Your AI Co-author is here to assist you through every step of your manuscript writing journey, grounded in Christian values.</p>

                    <h4 class="text-md font-semibold text-white mt-4">Getting Started:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Sign Up/Login:</strong> Create an account to save your projects permanently across sessions. You can also continue as a guest, but guest data may not persist.</li>
                        <li><strong>New Project:</strong> From the Dashboard, click "+ New Project" to start a new book. Provide a title and select its type, genre, and target audience.</li>
                        <li><strong>Dashboard:</strong> View all your existing projects, open them, or delete them.</li>
                    </ul>

                    <h4 class="text-md font-semibold text-white mt-4">Using the Editor:</h4>
                    <p>The main editor screen is where your writing and AI tools come together. It's divided into three main panels:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Left Sidebar:</strong> Navigate between different sections of your project (Synopsis & Brainstorming, Book Titles, Character Development, Outline, Chapters, Book Cover, etc.).</li>
                        <li><strong>Center Panel:</strong> This is your primary writing area, powered by Quill.js. Type directly here, and your progress is automatically saved.</li>
                        <li><strong>Right Sidebar (AI Co-Author):</strong> This is where you interact with the AI tools.</li>
                    </ul>

                    <h4 class="text-md font-semibold text-white mt-4">AI Co-Author Features:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>AI Style Preference:</strong> Use the text area at the top to describe the writing style or tone you'd like the AI to adopt (e.g., "Write in a formal, encouraging tone," "Use concise, impactful language"). This preference is applied to all AI-generated content.</li>
                        <li><strong>Generate Synopsis Ideas (Synopsis & Brainstorming):</strong> Provide a basic idea in the editor, and the AI will generate core concept ideas for your book.</li>
                        <li><strong>POV & Voice (Synopsis & Brainstorming):</strong> Based on your synopsis, the AI can suggest different points of view and narrative voices.</li>
                        <li><strong>Structural Template (Synopsis & Brainstorming):</strong> Get AI-generated structural ideas (e.g., Three-Act Structure) for your story.</li>
                        <li><strong>Generate Character Profiles (Character Development):</strong> The AI helps you create detailed character ideas based on your story's concept.</li>
                        <li><strong>Generate Chapter Beats (Outline):</strong> Get a detailed chapter-by-chapter outline based on your project's synopsis, characters, and world-building.</li>
                        <li><strong>Continue Writing (Chapters):</strong> Overcome writer's block! Click this button in any chapter to have the AI generate the next section of text, using your existing content and project context.</li>
                        <li><strong>Analyze Chapter (Chapters):</strong> Get high-level feedback on pacing, plot progression, and character consistency for your chapter.</li>
                        <li><strong>Proofread Chapter (Chapters):</strong> Receive suggested corrections for grammar, spelling, and punctuation. Click on a suggestion to apply the fix directly to your text.</li>
                        <li><strong>Suggest Youth Phrases (Chapters):</strong> Select text (e.g., dialogue) and get contemporary youth slang suggestions, suitable for a Christian context.</li>
                        <li><strong>Generate Image Prompts (Book Cover):</strong> Get descriptive prompts for an AI image generator based on your book's synopsis. Click a concept to generate a visual book cover.</li>
                        <li><strong>Select Book Cover (Book Cover):</strong> After generating images, click on your preferred cover to highlight it and save its URL to your project.</li>
                    </ul>

                    <h4 class="text-md font-semibold text-white mt-4">Exporting Your Work:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Export Project:</strong> Use the "Export Project" button in the footer to download your entire manuscript as a clean HTML file. This file is suitable for importing into professional book formatting software for eBook and print preparation.</li>
                    </ul>

                    <p class="text-sm text-gray-400 mt-4">Remember that AI generation relies on external services. If you encounter "API call failed" errors, please check your Google Cloud Project settings for API enablement and quotas.</p>
                </div>
            `;
            showModal('How to Use Author\'s Aid', helpContent, null, 'Close', false); // No confirm button, just close
        }


        function renderHeader(isLoggedIn, inEditor = false, userId = '') {
            let navLinksHtml = '';
            let userDisplay = '';
            if (isLoggedIn) {
                // FIX: Changed text color for better visibility
                userDisplay = `<span class="text-gray-300 text-sm">${userId.substring(0, 8)}...</span>`; 
                navLinksHtml = `
                    <a href="#" id="help-link" class="text-gray-300 hover:text-white transition-colors text-sm">Help</a>
                    ${userDisplay}
                    <button id="sign-out-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md text-sm transition-colors">Logout</button>
                `;
            }
             // FIX: Changed text color for better visibility
             const dashboardLink = inEditor ? `<a href="#" data-route="dashboard" class="nav-button text-sm text-gray-300 hover:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Dashboard</a>` : '';

            const headerHtml = `
                <header class="ui-bg p-4 border-b border-gray-700 flex-shrink-0">
                    <div class="container mx-auto flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            ${dashboardLink}
                            <h1 class="text-xl font-bold text-white">Author's Aid</h1>
                        </div>
                        <nav class="flex space-x-4 items-center">
                            ${navLinksHtml}
                        </nav>
                    </div>
                </header>`;

            const headerElement = document.createElement('div');
            headerElement.innerHTML = headerHtml;

            const signOutBtn = headerElement.querySelector('#sign-out-btn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await signOut();
                    navigateTo('landing');
                });
            }
            // Add event listener for the Help link
            const helpLink = headerElement.querySelector('#help-link');
            if (helpLink) {
                helpLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderHelpModal();
                });
            }

            return headerElement;
        }

        async function handleSignUpClick(e) {
            e.preventDefault();
            const content = `
                <form id="signup-form">
                    <p class="text-gray-400 mb-4">Create an account to save your work permanently.</p>
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="email" name="email" required autocomplete="email" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                    </div>
                    <div class="password-input-container">
                        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="password" name="password" required minlength="6" autocomplete="new-password" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        <span class="password-toggle" data-target="password"><i class="fas fa-eye"></i></span>
                        <p class="text-xs text-gray-400 mt-1">Minimum 6 characters.</p>
                    </div>
                </form>
            `;
            showModal('Sign Up for Free', content, async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                if (email && password) {
                    const user = authInstance.currentUser;
                    if (user && user.isAnonymous) {
                        // Link anonymous account
                        const success = await linkGuestAccount(email, password);
                        if (success) {
                            navigateTo('dashboard');
                        }
                    } else {
                        // Create new account
                        const newUser = await signUpWithEmail(email, password);
                        if (newUser) {
                            navigateTo('dashboard');
                        }
                    }
                }
            }, 'Sign Up');
        }

        async function handleLoginClick(e) {
            e.preventDefault();
            const content = `
                <form id="login-form">
                    <p class="text-gray-400 mb-4">Log in to access your saved projects.</p>
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="login-email" name="email" required autocomplete="email" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                    </div>
                    <div class="password-input-container">
                        <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="login-password" name="password" required autocomplete="current-password" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        <span class="password-toggle" data-target="login-password"><i class="fas fa-eye"></i></span>
                    </div>
                </form>
            `;
            showModal('Log In', content, async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (email && password) {
                    const user = await signInWithEmail(email, password);
                    if (user) {
                        navigateTo('dashboard');
                    }
                }
            }, 'Login');
        }

        function renderLandingPage() {
            document.body.style.overflow = 'auto';
            document.getElementById('theme-switcher').style.display = 'block';
            // The appContainer.innerHTML is now responsible for the entire content of the view,
            // so we remove the footer HTML from here to avoid duplication.
            appContainer.innerHTML = `
                <div class="gradient-bg">
                    <header class="absolute top-0 left-0 w-full z-10 p-4">
                        <div class="container mx-auto flex justify-between items-center">
                            <h1 class="text-2xl font-bold font-lora text-white">Author's Aid</h1>
                            <nav class="hidden md:flex space-x-6 items-center">
                                <a href="#features" class="accent-text-hover transition-colors">Features</a>
                                <a href="#" id="sign-up-link" class="accent-text-hover transition-colors">Sign Up</a>
                                <a href="#" id="login-link" class="accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg transition-colors">Login</a>
                            </nav>
                        </div>
                    </header>
                    <main class="relative pt-32 pb-20 md:pt-48 md:pb-32">
                        <div class="container mx-auto text-center px-4">
                            <h2 class="text-4xl md:text-6xl font-bold font-lora text-white leading-tight mb-4">Your AI Co-Author, Guided by Faith</h2>
                            <p class="text-lg md:text-xl text-gray-400 max-w-3xl mx-auto mb-8">
                                Welcome, Rene' Stanley. Author's Aid is your personalized writing partner, trained on your unique style and grounded in Christian values. From manuscript to cover, let's bring your next masterpiece to life.
                            </p>
                            <button id="guest-btn" class="accent-bg accent-bg-hover text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 inline-block">Continue as Guest</button>
                        </div>
                    </main>
                    <section id="features" class="py-20 bg-black/30">
                        <div class="container mx-auto px-4"><div class="text-center mb-12"><h3 class="text-3xl md:text-4xl font-bold font-lora">A Tool for Every Step of Your Journey</h3></div>
                        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">AI Co-Author & Ghostwriter</h4><p class="text-gray-400">Trained on your works, the AI learns your voice to help write, edit, and offer suggestions that sound authentically like you.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Multi-Format Support</h4><p class="text-gray-400">Get a tailored roadmap for fiction, non-fiction, devotionals, or Bible studies.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Faith-Based Assistance</h4><p class="text-gray-400">Get suggestions for relevant NIV Bible scriptures and theological insights.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Book Cover Generation</h4><p class="text-gray-400">Generate professional front, spine, and back covers using AI image prompts.
</p></div>
                        </div>
                    </section>
                    <section id="cta" class="py-20 bg-black/30">
                        <div class="container mx-auto text-center px-4">
                            <h3 class="text-3xl md:text-4xl font-bold font-lora text-white mb-4">Ready to Write Your Next Chapter?</h3>
                            <p class="text-lg text-gray-400 max-w-2xl mx-auto mb-8">Sign up today to begin your journey with an AI partner that understands your faith, your voice, and your vision.</p>
                            <div class="max-w-md mx-auto">
                                <form class="flex flex-col sm:flex-row gap-4">
                                    <input type="email" placeholder="Enter your email" class="w-full px-4 py-3 rounded-lg bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 accent-ring" required>
                                    <button type="submit" id="signup-free-btn" class="accent-bg accent-bg-hover text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">Sign Up for Free</button>
                                </form>
                            </div>
                        </div>
                    </section>
                </div>
            `;
            document.getElementById('guest-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                showNotification('Signing in as guest...');
                await signInAnon();
            });
            document.getElementById('signup-free-btn').addEventListener('click', handleSignUpClick);
            document.getElementById('login-link').addEventListener('click', handleLoginClick); // Changed to call handleLoginClick
            document.getElementById('sign-up-link').addEventListener('click', handleSignUpClick);
        }

        async function renderDashboard(userId) {
            currentUserId = userId;
            document.body.style.overflow = 'auto';
            document.getElementById('theme-switcher').style.display = 'block';
            appContainer.innerHTML = '';
            appContainer.appendChild(renderHeader(true, false, userId)); // Pass userId to header
            const mainContent = document.createElement('main');
            mainContent.className = "container mx-auto p-8 flex-grow";
            mainContent.innerHTML = `<div class="text-center text-gray-400">Loading projects...</div>`;
            appContainer.appendChild(mainContent);

            const projects = await getProjects(userId);
            let listHtml = projects.map(p => {
                // Determine the border color class based on the current theme
                const themeBorderClass = `theme-border-${currentTheme.replace('theme-', '')}`;

                return `
                <div class="project-card bg-gray-800 p-4 rounded-lg border-2 ${themeBorderClass} flex flex-col items-center text-center">
                    <div class="mb-2">
                        ${p.bookCoverUrl ? `<img src="${p.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/150x225/1F2937/D1D5DB?text=Image+Load+Error';" class="w-[150px] h-[225px] object-cover rounded-md shadow-md" alt="Book Cover Thumbnail"/>` : `<img src="https://placehold.co/150x225/1F2937/D1D5DB?text=No+Cover" class="w-[150px] h-[225px] object-cover rounded-md shadow-md" alt="Placeholder Cover"/>`}
                    </div>
                    <div class="flex-grow flex flex-col justify-between w-full">
                        <div>
                            <h3 class="text-xl font-lora font-semibold text-white leading-tight mb-1">${stripMarkdownAndHtml(p.title || 'Untitled Project')}</h3>
                            ${p.authorName ? `<p class="text-sm text-gray-400">by ${escapeHTML(p.authorName)}</p>` : ''}
                        </div>
                        <p class="text-xs text-gray-500 mt-auto">Edited: ${p.lastModified ? new Date(p.lastModified.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                    </div>
                    <div class="flex mt-4 space-x-2 w-full">
                        <button data-route="editor" data-id="${p.id}" class="nav-button flex-grow accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Open</button>
                        <button data-action="delete" data-id="${p.id}" class="bg-gray-600 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">🗑️</button>
                    </div>
                </div>`;
            }).join('');

            if (projects.length === 0) {
                listHtml = `<p class="col-span-full text-center text-gray-400">You have no projects yet. Start your first one!</p>`;
            }

            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-lora font-bold text-white">Your Projects</h2>
                    <button id="new-project-btn" class="accent-bg accent-bg-hover text-white font-bold py-2 px-6 rounded-lg text-lg">+ New Project</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    ${listHtml}
                </div>`;

            document.getElementById('new-project-btn').addEventListener('click', handleNewProject);
            mainContent.addEventListener('click', (event) => {
                const deleteBtn = event.target.closest('[data-action="delete"]');
                if (deleteBtn) {
                    const projectId = deleteBtn.dataset.id;
                    handleDeleteProject(projectId);
                }
            });
        }

        function handleNewProject() {
            const content = `
                <form id="new-project-form">
                    <div class="space-y-4">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Enter your book title (optional)</label>
                            <input type="text" id="title" name="title" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        </div>
                        <div>
                            <label for="bookType" class="block text-sm font-medium text-gray-300 mb-1">Book Type</label>
                            <select id="bookType" name="bookType" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>Fiction</option>
                                <option>Non-Fiction</option>
                                <option>Low Content</option>
                            </select>
                        </div>
                        <div>
                            <label for="genre" class="block text-sm font-medium text-gray-300 mb-1">Genre</label>
                            <select id="genre" name="genre" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>Christian Romance</option>
                                <option>Christian Fantasy</option>
                                <option>Christian Thriller</option>
                                <option>Children's Storybook</option>
                                <option>Devotional</option>
                                <option>Bible Study</option>
                                <option>Memoir</option>
                                <option>Christian Living</option>
                                <option>Theology</option>
                                <option>History</option>
                                <option>Prayer Journal</option>
                                <option>Gratitude Journal</option>
                                <option>Planner</option>
                            </select>
                        </div>
                        <div>
                            <label for="targetAudience" class="block text-sm font-medium text-gray-300 mb-1">Target Audience</label>
                            <select id="targetAudience" name="targetAudience" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>African American Adult</option>
                                <option>African American Young Adult</option>
                                <option>African American Children</option>
                                <option>Adult</option>
                                <option>Young Adult</option>
                                <option>Middle Grade</option>
                                <option>Children</option>
                                <option>All Ages</option>
                            </select>
                        </div>
                    </div>
                </form>
            `;
            showModal('Create a New Project', content, async () => {
                const title = document.getElementById('title').value || 'Untitled Project';
                const bookType = document.getElementById('bookType').value;
                const genre = document.getElementById('genre').value;
                const targetAudience = document.getElementById('targetAudience').value;
                const projectData = { title, bookType, genre, targetAudience };
                const newId = await createProject(currentUserId, projectData);
                if (newId) {
                    navigateTo('editor', { projectId: newId });
                }
            }, 'Create Project');
        }

        function handleDeleteProject(projectId) {
            showModal('Confirm Deletion', '<p>Are you sure you want to permanently delete this project and all its content?</p>', async () => {
                await deleteProject(currentUserId, projectId);
                renderDashboard(currentUserId);
            }, 'Delete');
        }

        async function renderEditor(userId, projectId) {
            console.log("renderEditor: Rendering editor for projectId:", projectId);
            currentUserId = userId;
            document.body.style.overflow = 'hidden'; /* Prevent global scrollbar on editor page */
            document.getElementById('theme-switcher').style.display = 'none'; /* Hide global switcher */
            appContainer.innerHTML = ''; // Clear existing content

            appContainer.appendChild(renderHeader(true, true, userId)); // Pass userId to header
            const mainContent = document.createElement('main');
            mainContent.className = "flex flex-grow flex-col h-full min-h-0"; /* Added min-h-0 */
            mainContent.innerHTML = `<div class="text-center text-gray-400">Loading project...</div>`;
            appContainer.appendChild(mainContent);

            const project = await getProject(userId, projectId);
            if (!project) {
                console.error("renderEditor: Project not found for projectId:", projectId);
                mainContent.innerHTML = `<div class="text-center text-red-400 p-8">Error: Project not found.</div>`;
                return;
            }
            console.log("renderEditor: Project data loaded:", project);

            mainContent.innerHTML = `
                <div class="flex flex-grow overflow-hidden"> <!-- Changed to overflow-hidden to contain internal scrolling -->
                    <div id="left-sidebar" class="w-2/12 bg-gray-800 p-4 border-r border-gray-700 flex flex-col overflow-y-auto"></div>
                    <div id="center-panel" class="w-7/12 p-8 flex flex-col overflow-y-auto bg-[#111827]">
                        <!-- Project title is outside editor-container and above the toolbar -->
                        <h3 id="project-main-title" class="text-3xl font-lora font-bold mb-4 text-white">${stripMarkdownAndHtml(project.title || 'Untitled Page')}</h3>
                        <div id="editor-container" class="flex-grow relative flex flex-col">
                           <div id="editor-toolbar"></div>
                           <div id="editor" class="flex-grow"></div>
                        </div>
                         <div id="cover-display-container" class="hidden flex-grow relative items-center justify-center"></div>
                         <div id="metadata-form-container" class="hidden flex-grow relative items-center justify-center p-4"></div>
                    </div>
                    <div id="right-sidebar" class="w-3/12 bg-gray-800 p-4 border-l border-gray-700 flex flex-col overflow-y-auto"></div>
                </div>
            `;

            // Make the editor footer visible
            const editorFooter = document.getElementById('app-global-footer'); // Reference the global footer
            if (editorFooter) {
                editorFooter.classList.remove('hidden');
                document.getElementById('footer-content-editor').classList.remove('hidden'); // Show editor specific content
                document.getElementById('footer-content-landing-dashboard').classList.add('hidden'); // Hide other content
            }
            
            await setupEditorFunctionality(userId, projectId, project);
        }

        async function setupEditorFunctionality(userId, projectId, project) {
            console.log("setupEditorFunctionality: Setting up editor for project:", projectId);
            const projectMainTitle = document.getElementById('project-main-title');
            const leftSidebar = document.getElementById('left-sidebar');
            const rightSidebar = document.getElementById('right-sidebar');
            const editorContainer = document.getElementById('editor-container');
            const coverDisplayContainer = document.getElementById('cover-display-container');
            const metadataFormContainer = document.getElementById('metadata-form-container');

            let activeSectionId = 'brainstorming'; // Default to brainstorming
            let editor;
            let sections = [];

            const renderSidebar = () => {
                console.log("renderSidebar: Updating sidebar with project data.");
                getProject(userId, projectId).then(updatedProject => {
                    if (updatedProject) {
                        project.bookCoverUrl = updatedProject.bookCoverUrl;
                        project.title = updatedProject.title;
                        projectMainTitle.textContent = stripMarkdownAndHtml(project.title || 'Untitled Page');
                        console.log("renderSidebar: Updated project data for sidebar:", project);
                    }

                    const sidebarHeader = `
                        <div class="flex flex-col items-center mb-4">
                            ${project.bookCoverUrl ? `<img src="${project.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/120x180/1F2937/D1D5DB?text=Cover';" class="w-30 h-45 object-cover rounded-md shadow-md mb-2" alt="Book Cover Thumbnail"/>` : `<img src="https://placehold.co/120x180/1F2937/D1D5DB?text=No+Cover" class="w-30 h-45 object-cover rounded-md shadow-md mb-2" alt="Placeholder Cover"/>`}
                        </div>`;
                    
                    // START: Logic to group sections under headings
                    const sectionGroups = {
                        project: [],
                        frontMatter: [],
                        chapters: [],
                        backMatter: []
                    };

                    sections.forEach(s => {
                        if (s.order < 7) sectionGroups.project.push(s);
                        else if (s.order >= 7 && s.order < 11) sectionGroups.frontMatter.push(s);
                        else if (s.order >= 11 && s.order < 100) sectionGroups.chapters.push(s);
                        else sectionGroups.backMatter.push(s);
                    });

                    const createSectionLinks = (group) => group.map(s => `<a href="#" data-section-id="${s.id}" class="section-link p-2 rounded-md text-gray-300 hover:bg-gray-700 transition-colors ${s.id === activeSectionId ? 'bg-blue-600 text-white' : ''}">${s.title}</a>`).join('');

                    const sidebarNav = `
                        <nav id="project-sections" class="flex flex-col space-y-2 flex-grow overflow-y-auto">
                            ${createSectionLinks(sectionGroups.project)}
                            
                            ${sectionGroups.frontMatter.length > 0 ? `<div class="pt-4 mt-2 border-t border-gray-700"><h4 class="text-xs font-bold uppercase text-gray-500 px-2 mb-2">Front Matter</h4></div>` : ''}
                            ${createSectionLinks(sectionGroups.frontMatter)}

                            ${sectionGroups.chapters.length > 0 ? `<div class="pt-4 mt-2 border-t border-gray-700"><h4 class="text-xs font-bold uppercase text-gray-500 px-2 mb-2">Chapters</h4></div>` : ''}
                            ${createSectionLinks(sectionGroups.chapters)}
                            
                            ${sectionGroups.backMatter.length > 0 ? `<div class="pt-4 mt-2 border-t border-gray-700"><h4 class="text-xs font-bold uppercase text-gray-500 px-2 mb-2">Back Matter</h4></div>` : ''}
                            ${createSectionLinks(sectionGroups.backMatter)}
                        </nav>
                    `;
                    // END: Logic to group sections

                    leftSidebar.innerHTML = sidebarHeader + sidebarNav;

                    leftSidebar.querySelectorAll('.section-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            activeSectionId = e.target.dataset.sectionId;
                            loadSection(activeSectionId);
                        });
                    });
                });
            };
            
            // Chapter Navigation Logic
            const updateChapterNavButtons = () => {
                const chapterSections = sections.filter(s => s.id.startsWith('chapter_'));
                const currentIndex = chapterSections.findIndex(s => s.id === activeSectionId);
                const prevBtn = document.getElementById('prev-chapter-btn');
                const nextBtn = document.getElementById('next-chapter-btn');

                if (prevBtn && nextBtn) {
                    prevBtn.disabled = currentIndex <= 0;
                    nextBtn.disabled = currentIndex < 0 || currentIndex >= chapterSections.length - 1;
                }
            };
            
            document.getElementById('prev-chapter-btn').addEventListener('click', () => {
                const chapterSections = sections.filter(s => s.id.startsWith('chapter_'));
                const currentIndex = chapterSections.findIndex(s => s.id === activeSectionId);
                if (currentIndex > 0) {
                    loadSection(chapterSections[currentIndex - 1].id);
                }
            });

            document.getElementById('next-chapter-btn').addEventListener('click', () => {
                const chapterSections = sections.filter(s => s.id.startsWith('chapter_'));
                const currentIndex = chapterSections.findIndex(s => s.id === activeSectionId);
                if (currentIndex >= 0 && currentIndex < chapterSections.length - 1) {
                    loadSection(chapterSections[currentIndex + 1].id);
                }
            });


            document.getElementById('add-chapter-btn').addEventListener('click', async () => {
                console.log("Add Chapter button clicked.");
                const chapterCount = sections.filter(s => s.id.startsWith('chapter_')).length;
                const success = await addChapter(userId, projectId, chapterCount + 1);
                if(success) {
                    sections = await getProjectSections(userId, projectId);
                    renderSidebar();
                    showNotification(`Chapter ${chapterCount + 1} added!`, 'success');
                }
            });

            document.getElementById('export-project-btn').addEventListener('click', async () => {
                console.log("Export Project button clicked.");
                showNotification('Preparing manuscript for export...', 'info');
                try {
                    const allSections = await getProjectSections(userId, projectId);
                    let fullHtmlContent = '<html><head><meta charset="UTF-8"><title>'+escapeHTML(project.title || 'Untitled Manuscript')+'</title></head><body>';
                    fullHtmlContent += `<h1>${stripMarkdownAndHtml(project.title || 'Untitled Manuscript')}</h1>\n\n`;

                    for (const section of allSections) {
                        if (section.id === 'book_cover' || section.id === 'metadata' || section.id === 'book_titles') continue;
                        fullHtmlContent += `<h2>${section.title}</h2>\n`;
                        const tempDiv = document.createElement('div');
                        const tempQuill = new Quill(tempDiv, { readOnly: true });
                        try {
                            tempQuill.setContents(JSON.parse(section.content));
                        } catch (e) {
                            tempQuill.setText(section.content || '');
                        }
                        fullHtmlContent += tempDiv.querySelector('.ql-editor').innerHTML + '\n\n';
                    }
                    fullHtmlContent += '</body></html>';

                    const blob = new Blob([fullHtmlContent], { type: 'text/html;charset=utf-8' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `${stripMarkdownAndHtml(project.title).replace(/\s+/g, '-') || 'untitled-manuscript'}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showNotification('Manuscript exported as HTML!', 'success');

                } catch (e) {
                    console.error("Export failed:", e);
                    showNotification(`Export failed: ${e.message}`, 'error');
                }
            });

            // FIX: Refactored this function to be more reliable
            const renderAiPanel = (sectionId) => {
                console.log("renderAiPanel: Rendering AI panel for section:", sectionId);
                
                let contextualButtonsHtml = '';
                let pageGeneratorButtonsHtml = '';

                // This block defines buttons that are ALWAYS available, unless on a special page.
                const commonPageGenerators = `
                    <div class="pt-4 mt-4 border-t border-gray-700">
                        <p class="text-sm font-semibold mb-2 text-gray-200">Page Generators</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button data-topic="Copyright" data-matter-type="front" class="generate-matter-btn w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Copyright</button>
                            <button data-topic="Dedication" data-matter-type="front" class="generate-matter-btn w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Dedication</button>
                            <button data-topic="Preface" data-matter-type="front" class="generate-matter-btn w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Preface</button>
                            <button data-topic="Acknowledgments" data-matter-type="front" class="generate-matter-btn w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Acknowledgments</button>
                            <button data-topic="About the Author" data-matter-type="back" class="generate-matter-btn w-full col-span-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">About the Author</button>
                        </div>
                    </div>`;

                if (sectionId === 'brainstorming') {
                    contextualButtonsHtml = `
                        <div>
                            <p class="text-sm font-semibold mb-2 text-gray-200">Generate Synopsis Ideas</p>
                            <textarea id="ai-idea-input" class="w-full h-24 p-2 bg-gray-700 border border-gray-600 rounded-md text-sm" placeholder="e.g., A story about a family..."></textarea>
                            <button id="generate-synopsis-concepts-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate</button>
                        </div>
                        <div class="pt-4 border-t border-gray-700">
                            <p class="text-sm font-semibold mb-2 text-gray-200">Brainstorming Tools</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="generate-pov-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">POV & Voice</button>
                                <button id="generate-structure-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Structural Template</button>
                            </div>
                        </div>`;
                    pageGeneratorButtonsHtml = commonPageGenerators;
                } else if (sectionId === 'book_titles') {
                     contextualButtonsHtml = `
                        <div>
                            <p class="text-sm font-semibold mb-2 text-gray-200">Generate Book Titles</p>
                            <p class="text-xs text-gray-300 mb-2">Generate title suggestions based on your synopsis.</p>
                            <button id="generate-titles-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Titles</button>
                        </div>`;
                     pageGeneratorButtonsHtml = commonPageGenerators;
                }
                else if (sectionId === 'character_development') {
                     contextualButtonsHtml = `
                        <div>
                            <p class="text-sm font-semibold mb-2 text-gray-200">Generate Character Profiles</p>
                            <p class="text-xs text-gray-300 mb-2">Let the AI create character ideas based on your story's concept.</p>
                            <button id="generate-characters-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Characters</button>
                        </div>`;
                     pageGeneratorButtonsHtml = commonPageGenerators;
                } else if (sectionId === 'world_building') {
                     contextualButtonsHtml = `
                        <div>
                            <p class="text-sm font-semibold mb-2 text-gray-200">Generate World Prompts</p>
                            <p class="text-xs text-gray-300 mb-2">Brainstorm elements for your story's universe.</p>
                            <button id="generate-world-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate World Ideas</button>
                        </div>`;
                     pageGeneratorButtonsHtml = commonPageGenerators;
                }
                else if (sectionId === 'outline') {
                    contextualButtonsHtml = `
                        <div>
                            <p class="text-sm font-semibold mb-2 text-gray-200">Generate Chapter Beats</p>
                            <p class="text-xs text-gray-300 mb-2">Let the AI create a detailed outline based on your project's foundation.</p>
                            <button id="generate-outline-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Outline</button>
                        </div>`;
                    pageGeneratorButtonsHtml = commonPageGenerators;
                } else if (sectionId.startsWith('chapter_')) {
                    contextualButtonsHtml = `
                        <div>
                            <p class="text-sm font-semibold mb-2 text-gray-200">Drafting & Revising</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="continue-writing-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Continue Writing</button>
                                <button id="analyze-chapter-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Analyze Chapter</button>
                                <button id="proofread-chapter-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Proofread Chapter</button>
                            </div>
                        </div>`;
                    pageGeneratorButtonsHtml = commonPageGenerators;
                } else if (sectionId === 'book_cover') {
                    contextualButtonsHtml = `
                        <div>
                            <p class="text-sm font-semibold mb-2 text-gray-200">Generate Image Prompts</p>
                            <p class="text-xs text-gray-300 mb-2">Generate descriptive prompts for an AI image generator based on your synopsis.</p>
                            <button id="generate-image-prompts-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Image Prompts</button>
                        </div>`;
                } else {
                    // For pages like Dedication, Preface, etc., show the page generators
                    pageGeneratorButtonsHtml = commonPageGenerators;
                }

                const aiPanelHtml = `
                    <h3 class="text-lg font-bold mb-4">AI Co-Author</h3>
                    <div class="space-y-4 flex-grow flex flex-col">
                        <div class="pb-4 border-b border-gray-700">
                            <p class="text-sm font-semibold mb-2 text-gray-200">AI Style Preference</p>
                            <textarea id="ai-style-preference-input" class="w-full h-20 p-2 bg-gray-700 border border-gray-600 rounded-md text-sm" placeholder="e.g., Write in a formal, encouraging tone."></textarea>
                            <p class="text-xs text-gray-300 mt-1">Describe the tone or style you'd like the AI to use.</p>
                        </div>
                        
                        ${contextualButtonsHtml}

                        <div class="pt-4 border-t border-gray-700 flex-shrink-0">
                            <p class="text-sm font-semibold mb-2 text-gray-200">Editing & Faith Tools</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="suggest-alternatives-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Alternative Words</button>
                                <button id="suggest-scripture-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Suggest Scripture</button>
                                <button id="suggest-youth-phrases-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Suggest Youth Phrases</button>
                            </div>
                        </div>

                        ${pageGeneratorButtonsHtml}

                        <div id="ai-output" class="mt-4 text-sm text-gray-300 space-y-2 flex-grow overflow-y-auto"></div>
                    </div>`;

                rightSidebar.innerHTML = aiPanelHtml;
                setupAiPanelListeners(userId, projectId, editor);
            };

            const setupAiPanelListeners = (userId, projectId, editor) => {
                const outputDiv = document.getElementById('ai-output');

                const showContentInModal = (title, content, onAcceptCallback) => {
                    showModal(title, `<div class="whitespace-pre-wrap text-gray-300 text-sm">${escapeHTML(content)}</div>`, async () => {
                        await onAcceptCallback(content);
                    }, 'Accept & Add to Editor');
                };

                const aiStyleInput = document.getElementById('ai-style-preference-input');
                if (aiStyleInput) {
                    aiStyleInput.value = aiStylePreference;
                    aiStyleInput.addEventListener('input', debounce(() => {
                        aiStylePreference = aiStyleInput.value;
                        showNotification('AI style preference updated!', 'info', 1000);
                    }, 500));
                }
                
                // Helper to get full project context for AI prompts
                const getFullProjectContext = async () => {
                    const projectData = await getProject(userId, projectId);
                    const allSections = await getProjectSections(userId, projectId);
                    
                    const tempDiv = document.createElement('div');
                    const tempQuill = new Quill(tempDiv);

                    const getQuillText = (sectionId) => {
                        const section = allSections.find(s => s.id === sectionId);
                        if (!section || !section.content) return '';
                        try {
                            tempQuill.setContents(JSON.parse(section.content));
                            return tempQuill.getText().trim();
                        } catch (e) {
                            return section.content; // Fallback for plain text
                        }
                    };

                    const synopsisText = getQuillText('brainstorming');
                    const charactersText = getQuillText('character_development');
                    const worldText = getQuillText('world_building');
                    const outlineText = getQuillText('outline');

                    return {
                        fullContext: `
                            Book Title: ${projectData.title || 'Untitled'}
                            Synopsis: ${synopsisText}
                            Characters: ${charactersText}
                            World-building: ${worldText}
                            Outline: ${outlineText}
                        `.trim(),
                        synopsis: synopsisText,
                        outline: outlineText,
                        title: projectData.title || 'Untitled'
                    };
                };

                // Delegated event listener for dynamically generated buttons
                outputDiv.addEventListener('click', async (e) => {
                    const suggestionBtn = e.target.closest('.suggestion-replacement');
                    if (suggestionBtn) {
                        const newText = suggestionBtn.dataset.suggestion;
                        const originalText = suggestionBtn.dataset.original;

                        if (editor && currentSelectionRange) {
                            const selectedText = editor.getText(currentSelectionRange.index, currentSelectionRange.length);
                            const startIndexInSelection = selectedText.indexOf(originalText);

                            if (startIndexInSelection !== -1) {
                                const absoluteStartIndex = currentSelectionRange.index + startIndexInSelection;
                                editor.deleteText(absoluteStartIndex, originalText.length);
                                editor.insertText(absoluteStartIndex, newText);
                                // After applying one, clear the suggestions to avoid confusion
                                outputDiv.innerHTML = ''; 
                            } else {
                                // Fallback for when the original text isn't found (e.g., single word replacement)
                                editor.deleteText(currentSelectionRange.index, currentSelectionRange.length);
                                editor.insertText(currentSelectionRange.index, newText);
                                outputDiv.innerHTML = '';
                            }
                        }
                        return;
                    }
                    
                    const titleBtn = e.target.closest('.title-suggestion-btn');
                    if (titleBtn) {
                        const newTitle = titleBtn.dataset.title;
                        await updateProjectTitle(userId, projectId, newTitle);
                        projectMainTitle.textContent = newTitle;
                        outputDiv.innerHTML = ''; // Clear suggestions
                        return;
                    }
                });

                // Individual listeners for each button
                const addClickListener = (id, handler) => {
                    const btn = document.getElementById(id);
                    if (btn) btn.addEventListener('click', handler);
                };

                addClickListener('generate-synopsis-concepts-btn', async () => {
                    const idea = document.getElementById('ai-idea-input').value.trim();
                    if (!idea) { showNotification("Please enter a basic idea in the text box.", "error"); return; }
                    const conceptsText = await generateSynopsisIdeas(idea);
                    const concepts = parseNumberedAiList(conceptsText, false).map(c => stripMarkdownAndHtml(c.trim()));
                    outputDiv.innerHTML = concepts.map((concept, index) => `<button data-content="${escapeHTML(concept)}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Concept ${index + 1}:</strong> ${escapeHTML(concept.substring(0, 80))}...</button>`).join('');
                });

                addClickListener('generate-world-btn', async () => {
                    const { synopsis } = await getFullProjectContext();
                    if (!synopsis) { showNotification("Please write a synopsis first.", "error"); return; }
                    const worldText = await generateWorldPrompts(synopsis);
                    const prompts = parseNumberedAiList(worldText, false).map(p => stripMarkdownAndHtml(p.trim()));
                    outputDiv.innerHTML = prompts.map((prompt, index) => `<button data-content="${escapeHTML(prompt)}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Idea ${index + 1}:</strong> ${escapeHTML(prompt.substring(0, 80))}...</button>`).join('');
                });

                addClickListener('generate-image-prompts-btn', async () => {
                    const { synopsis } = await getFullProjectContext();
                    if (!synopsis) { showNotification("Please write a synopsis in the 'Synopsis & Brainstorming' section first.", "error"); return; }
                    const conceptsText = await generateCoverConcepts(synopsis);
                    const concepts = parseNumberedAiList(conceptsText, false).map(c => stripMarkdownAndHtml(c.trim()));
                    let modalContent = concepts.map((concept, index) => `
                        <div class="p-2 bg-gray-700 rounded-md mb-2">
                            <textarea class="w-full h-24 p-2 bg-gray-800 border border-gray-600 rounded-md text-sm mb-2">${escapeHTML(concept)}</textarea>
                            <button data-prompt-index="${index}" class="ai-image-prompt-btn accent-bg accent-bg-hover text-white font-semibold py-1 px-3 rounded-lg">Generate Images</button>
                        </div>`
                    ).join('');
                    showModal('Generated Cover Prompts', modalContent, null, 'Close', false);
                    
                    document.getElementById('modal-container').addEventListener('click', e => {
                        if (e.target.classList.contains('ai-image-prompt-btn')) {
                            const promptIndex = e.target.dataset.promptIndex;
                            const prompt = e.target.previousElementSibling.value;
                            document.getElementById('modal-close-btn').click(); // Close the modal
                            generateImage(prompt).then(imageUrls => {
                                if (imageUrls.length > 0) {
                                    coverDisplayContainer.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 p-4">${imageUrls.map(url => `
                                        <div class="cover-image-wrapper" data-image-url="${url}">
                                            <img src="${url}" class="w-full h-auto rounded-lg shadow-lg" alt="Generated Book Cover"/>
                                            <div class="cover-selection-overlay"><i class="fas fa-check-circle"></i></div>
                                        </div>
                                    `).join('')}</div>`;
                                    
                                    coverDisplayContainer.querySelectorAll('.cover-image-wrapper').forEach(wrapper => {
                                        wrapper.addEventListener('click', async (e) => {
                                            const selectedWrapper = e.currentTarget;
                                            const base64Url = selectedWrapper.dataset.imageUrl;
                                            showNotification('Saving cover... please wait.', 'info');
                                            try {
                                                const storagePath = `artifacts/${appId}/users/${userId}/projects/${projectId}/project_covers/${Date.now()}.png`;
                                                const storageRef = ref(storageInstance, storagePath);
                                                const uploadResult = await uploadString(storageRef, base64Url, 'data_url');
                                                const downloadUrl = await getDownloadURL(uploadResult.ref);
                                                
                                                await updateProjectCover(userId, projectId, downloadUrl);
                                                
                                                coverDisplayContainer.querySelectorAll('.cover-image-wrapper').forEach(w => w.classList.remove('selected'));
                                                selectedWrapper.classList.add('selected');
                                                renderSidebar(); // Refresh sidebar to show new cover
                                            } catch (error) {
                                                console.error("Error uploading image and updating cover:", error);
                                                showNotification(`Error saving cover: ${error.message}`, 'error');
                                            }
                                        });
                                    });
                                }
                            });
                        }
                    });
                });
                
                // Brainstorming Tools
                addClickListener('generate-pov-btn', async () => {
                    const { synopsis } = await getFullProjectContext();
                    if (!synopsis) { showNotification("Please write a synopsis first.", "error"); return; }
                    const resultsText = await suggestPOVs(synopsis);
                    const results = parseNumberedAiList(resultsText, false).map(c => c.trim());
                    outputDiv.innerHTML = results.map((result, index) => `<button data-content="${escapeHTML(result)}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Option ${index + 1}:</strong> ${escapeHTML(result.substring(0, 80))}...</button>`).join('');
                });

                addClickListener('generate-structure-btn', async () => {
                    const { synopsis } = await getFullProjectContext();
                    if (!synopsis) { showNotification("Please write a synopsis first.", "error"); return; }
                    const resultsText = await suggestStructures(synopsis);
                    const results = parseNumberedAiList(resultsText, false).map(c => c.trim());
                    outputDiv.innerHTML = results.map((result, index) => `<button data-content="${escapeHTML(result)}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Template ${index + 1}:</strong> ${escapeHTML(result.substring(0, 80))}...</button>`).join('');
                });
                
                // Book Titles
                addClickListener('generate-titles-btn', async () => {
                    const { synopsis } = await getFullProjectContext();
                    if (!synopsis) { showNotification("Please write a synopsis or some brainstorming notes first.", "error"); return; }
                    const titlesText = await generateTitles(synopsis);
                    const titles = parseNumberedAiList(titlesText, false).map(c => stripMarkdownAndHtml(c.trim()));
                    outputDiv.innerHTML = titles.map((title) => `<button data-title="${escapeHTML(title)}" class="title-suggestion-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2">${escapeHTML(title)}</button>`).join('');
                });

                // Character Development
                addClickListener('generate-characters-btn', async () => {
                    const { fullContext } = await getFullProjectContext();
                    if (!fullContext.trim()) { showNotification("Please write a synopsis first.", "error"); return; }
                    const charactersText = await generateCharacterProfiles(fullContext);
                    const profiles = parseNumberedAiList(charactersText, false).map(c => c.trim());

                    // Sort profiles based on role
                    const roleOrder = ['Protagonist', 'Antagonist', 'Mentor', 'Deuteragonist', 'Love Interest', 'Confidant', 'Foil', 'Sidekick'];
                    const getRole = (profileText) => {
                        const match = profileText.match(/By Role:\s*([^\n,]+)/i);
                        return match ? match[1].trim() : 'zzzz'; // 'zzzz' to push unknown to the end
                    };

                    profiles.sort((a, b) => {
                        const roleA = getRole(a);
                        const roleB = getRole(b);
                        const indexA = roleOrder.indexOf(roleA);
                        const indexB = roleOrder.indexOf(roleB);
                        if (indexA === -1 && indexB === -1) return 0;
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                    
                    let modalContent = profiles.map(profile => `
                        <div class="p-2 bg-gray-700 rounded-md mb-2">
                            <p class="whitespace-pre-wrap">${escapeHTML(profile)}</p>
                        </div>`
                    ).join('');
                    
                    showModal('Generated Character Profiles', modalContent, () => {
                        const fullText = profiles.join('\n\n---\n\n');
                        if (editor) {
                            editor.insertText(editor.getLength(), '\n\n' + fullText);
                            showNotification("Characters added to editor!", "success");
                        }
                    }, 'Add All to Editor');
                });

                // Outline
                addClickListener('generate-outline-btn', async () => {
                    const { fullContext, title } = await getFullProjectContext();
                    if (!fullContext.trim()) { showNotification("Please fill out your synopsis, characters, and world-building sections first.", "error"); return; }
                    const outlineText = await generateOutlineBeats(fullContext, title);
                     showContentInModal('Generated Outline', outlineText, (content) => {
                        if (editor) {
                            editor.setText(content);
                            showNotification("Outline added to editor!", "success");
                        }
                    });
                });

                // Chapter Tools
                addClickListener('continue-writing-btn', async () => {
                    const currentText = editor.getText();
                    const { title, outline } = await getFullProjectContext();
                    if (!outline.trim()) { showNotification("Please ensure you have a generated outline.", "error"); return; }
                    const nextText = await generateNext(currentText, title, outline);
                    showContentInModal('Suggested Continuation', nextText, (content) => {
                        if (editor) {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Content added to editor!", "success");
                        }
                    });
                });

                addClickListener('analyze-chapter-btn', async () => {
                    const chapterText = editor.getText();
                    if (!chapterText.trim()) { showNotification("Please write something in the chapter to analyze.", "error"); return; }
                    const { fullContext } = await getFullProjectContext();
                    const analysis = await analyzeChapter(chapterText, fullContext);
                    outputDiv.innerHTML = `<div class="whitespace-pre-wrap p-2 bg-gray-900 rounded-md">${escapeHTML(analysis)}</div>`;
                });

                addClickListener('proofread-chapter-btn', async () => {
                    currentSelectionRange = editor.getSelection();
                    if (!currentSelectionRange || currentSelectionRange.length === 0) {
                        showNotification("Please select the text you want to proofread.", "error");
                        return;
                    }
                    const chapterText = editor.getText(currentSelectionRange.index, currentSelectionRange.length);
                    const suggestionsJson = await proofreadChapter(chapterText);
                    try {
                        const suggestions = JSON.parse(suggestionsJson);
                        outputDiv.innerHTML = suggestions.map(s => `
                            <div class="suggestion-item">
                                <div class="suggestion-original">${escapeHTML(s.original)}</div>
                                <div class="suggestion-replacement" data-original="${escapeHTML(s.original)}" data-suggestion="${escapeHTML(s.suggestion)}">
                                    ${escapeHTML(s.suggestion)}
                                </div>
                                <div class="text-xs text-gray-400 mt-1">${escapeHTML(s.reasoning)}</div>
                            </div>
                        `).join('');
                    } catch (e) {
                        console.error("Failed to parse proofreading suggestions:", e);
                        outputDiv.innerHTML = `<div class="text-red-400">Could not get suggestions.</div>`;
                    }
                });

                // Front & Back Matter
                document.querySelectorAll('.generate-matter-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const topic = e.target.dataset.topic;
                        const matterType = e.target.dataset.matterType;
                        const { fullContext } = await getFullProjectContext();
                        const matterText = matterType === 'front'
                            ? await generateFrontMatter(fullContext, topic)
                            : await generateBackMatter(fullContext, topic);
                        showContentInModal(`${topic} Ideas`, matterText, (content) => {
                            if (editor) {
                                editor.insertText(editor.getLength(), `\n\n--- ${topic.toUpperCase()} ---\n\n` + content);
                                showNotification("Content added to editor!", "success");
                            }
                        });
                    });
                });


                const handleSelectionTools = async (e) => {
                    if (!editor) return;
                    currentSelectionRange = editor.getSelection();
                    if (!currentSelectionRange || currentSelectionRange.length === 0) {
                        showNotification("Please select some text in the editor first.", "error");
                        return;
                    }
                    const selectedText = editor.getText(currentSelectionRange.index, currentSelectionRange.length);
                    const fullTextContext = editor.getText();
                    
                    if (e.target.id === 'suggest-alternatives-btn') {
                        const resultsJson = await suggestAlternatives(selectedText, fullTextContext);
                        try {
                            const results = JSON.parse(resultsJson);
                            outputDiv.innerHTML = results.map(s => `
                                <div class="suggestion-item">
                                     <div class="suggestion-original">${escapeHTML(s.original)}</div>
                                     <div class="suggestion-replacement" data-original="${escapeHTML(s.original)}" data-suggestion="${escapeHTML(s.suggestion)}">${escapeHTML(s.suggestion)}</div>
                                </div>
                            `).join('');
                        } catch (e) {
                             outputDiv.innerHTML = `<div class="text-red-400">Could not get suggestions.</div>`;
                        }
                    } else if (e.target.id === 'suggest-scripture-btn') {
                        const resultsJson = await suggestScripture(selectedText, fullTextContext);
                        try {
                            const results = JSON.parse(resultsJson);
                            let modalContent = results.map(s => `
                                <div class="p-2 bg-gray-700 rounded-md mb-2">
                                    <p class="font-bold">${escapeHTML(s.reference)}</p>
                                    <p class="mb-2">${escapeHTML(s.text)}</p>
                                    <button data-scripture="${escapeHTML(s.reference + ': ' + s.text)}" class="add-scripture-btn accent-bg accent-bg-hover text-white font-semibold py-1 px-3 rounded-lg text-sm">Add</button>
                                </div>
                            `).join('');
                            showModal('Suggested Scriptures', modalContent, null, 'Close', false);

                            document.getElementById('modal-container').addEventListener('click', e => {
                                if (e.target.classList.contains('add-scripture-btn')) {
                                    const scripture = e.target.dataset.scripture;
                                    editor.insertText(editor.getLength(), '\n\n' + scripture);
                                    showNotification("Scripture added!", "success");
                                }
                            });

                        } catch (e) {
                             showNotification("Could not parse scripture suggestions.", "error");
                        }
                    } else { // Youth Phrases
                        const resultsText = await suggestYouthPhrases(selectedText, fullTextContext);
                        const results = parseNumberedAiList(resultsText, false);
                         outputDiv.innerHTML = results.map(s => `
                            <div class="suggestion-item">
                                 <div class="suggestion-replacement" data-original="${escapeHTML(selectedText)}" data-suggestion="${escapeHTML(s)}">${escapeHTML(s)}</div>
                            </div>
                        `).join('');
                    }
                };

                addClickListener('suggest-alternatives-btn', handleSelectionTools);
                addClickListener('suggest-scripture-btn', handleSelectionTools);
                addClickListener('suggest-youth-phrases-btn', handleSelectionTools);
            };
            
            const loadSection = async (sectionId) => {
                console.log("loadSection: Loading section:", sectionId);
                const sectionData = await getSection(userId, projectId, sectionId);
                const projectData = await getProject(userId, projectId);
                if (projectMainTitle) {
                    projectMainTitle.textContent = stripMarkdownAndHtml(projectData.title || 'Untitled Page');
                }

                activeSectionId = sectionId;

                editorContainer.classList.add('hidden');
                coverDisplayContainer.classList.add('hidden');
                metadataFormContainer.classList.add('hidden');

                if (sectionId === 'book_cover') {
                    coverDisplayContainer.classList.remove('hidden');
                    if (projectData && projectData.bookCoverUrl) {
                        coverDisplayContainer.innerHTML = `
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 p-4">
                                <div class="cover-image-wrapper selected" data-image-url="${escapeHTML(projectData.bookCoverUrl)}">
                                    <img src="${projectData.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/400x600/FF0000/FFFFFF?text=Image+Load+Error';" class="w-full h-auto rounded-lg shadow-lg" alt="Selected Book Cover"/>
                                    <div class="cover-selection-overlay"><i class="fas fa-check-circle"></i> Selected</div>
                                </div>
                            </div>`;
                    } else {
                        coverDisplayContainer.innerHTML = `<div class="text-center text-gray-400">Your generated book cover will appear here.</div>`;
                    }
                } else if (sectionId === 'metadata') {
                    metadataFormContainer.classList.remove('hidden');
                    let metadata = {};
                    try {
                        metadata = JSON.parse(sectionData.content);
                    } catch(e) { /* Ignore parsing errors */ }
                    
                    metadataFormContainer.innerHTML = `
                        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 w-full max-w-md">
                            <h3 class="text-xl font-lora font-bold mb-4 text-white">Project Metadata</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="meta-author-name" class="block text-sm font-medium text-gray-300 mb-1">Author Name</label>
                                    <input type="text" id="meta-author-name" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.authorName || '')}">
                                </div>
                                <div>
                                    <label for="meta-copyright-year" class="block text-sm font-medium text-gray-300 mb-1">Copyright Year</label>
                                    <input type="number" id="meta-copyright-year" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.copyrightYear || new Date().getFullYear())}">
                                </div>
                                <div>
                                    <label for="meta-publisher" class="block text-sm font-medium text-gray-300 mb-1">Publisher</label>
                                    <input type="text" id="meta-publisher" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.publisher || '')}">
                                </div>
                                <div>
                                    <label for="meta-isbn" class="block text-sm font-medium text-gray-300 mb-1">ISBN (Optional)</label>
                                    <input type="text" id="meta-isbn" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.isbn || '')}">
                                </div>
                                <div>
                                    <label for="meta-series-name" class="block text-sm font-medium text-gray-300 mb-1">Series Name (Optional)</label>
                                    <input type="text" id="meta-series-name" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.seriesName || '')}">
                                </div>
                                <div>
                                    <label for="meta-series-number" class="block text-sm font-medium text-gray-300 mb-1">Series Number (Optional)</label>
                                    <input type="number" id="meta-series-number" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.seriesNumber || '')}">
                                </div>
                                <div>
                                    <label for="meta-lccn" class="block text-sm font-medium text-gray-300 mb-1">Library of Congress Control Number (LCCN)</label>
                                    <input type="text" id="meta-lccn" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.lccn || '')}">
                                </div>
                                <button id="save-metadata-btn" class="w-full mt-4 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Save Metadata</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('save-metadata-btn').addEventListener('click', async () => {
                        const newMetadata = {
                            authorName: document.getElementById('meta-author-name').value,
                            copyrightYear: document.getElementById('meta-copyright-year').value,
                            publisher: document.getElementById('meta-publisher').value,
                            isbn: document.getElementById('meta-isbn').value,
                            seriesName: document.getElementById('meta-series-name').value,
                            seriesNumber: document.getElementById('meta-series-number').value,
                            lccn: document.getElementById('meta-lccn').value,
                        };
                        await updateProjectMetadata(userId, projectId, newMetadata);
                    });
                } else {
                    editorContainer.classList.remove('hidden');
                    if (!editor) {
                        const toolbarOptions = {
                            container: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                ['clean'],
                                ['undo', 'redo']
                            ],
                            handlers: {
                                'undo': () => editor.history.undo(),
                                'redo': () => editor.history.redo()
                            }
                        };
                        editor = new Quill('#editor', {
                            modules: { 
                                toolbar: toolbarOptions,
                                history: {
                                    delay: 2000,
                                    maxStack: 500,
                                    userOnly: true
                                }
                            },
                            theme: 'snow'
                        });

                        // Custom Undo/Redo button icons
                        document.querySelector('.ql-undo').innerHTML = '<i class="fas fa-undo"></i>';
                        document.querySelector('.ql-redo').innerHTML = '<i class="fas fa-redo"></i>';

                        editor.on('text-change', debounce(async () => {
                            const content = JSON.stringify(editor.getContents());
                            await updateSectionContent(userId, projectId, activeSectionId, content);
                            showNotification('Progress Saved', 'success', 1500);
                        }, 1500));
                    }
                    try {
                        editor.setContents(JSON.parse(sectionData.content));
                    } catch(e) {
                        editor.setText(sectionData.content || '');
                    }
                }

                renderSidebar();
                renderAiPanel(sectionId);
                updateChapterNavButtons();
            };

            sections = await getProjectSections(userId, projectId);
            await loadSection(activeSectionId);
        }

        //======================================================================
        // --- MAIN APPLICATION LOGIC ---
        //======================================================================

        let mainCurrentUserId = null;

        function navigateTo(viewName, data = {}) {
            console.log("navigateTo: Navigating to view:", viewName, "with data:", data);
            appContainer.innerHTML = ''; // Clear existing content
            
            // FIX: Added logic to manage body and app-container classes for proper layout
            if (viewName === 'editor') {
                document.body.classList.add('flex', 'flex-col', 'h-screen');
                appContainer.classList.add('flex-grow', 'min-h-0');
                appContainer.classList.remove('h-screen');
            } else {
                document.body.classList.remove('flex', 'flex-col', 'h-screen');
                appContainer.classList.remove('flex-grow', 'min-h-0');
                appContainer.classList.add('h-screen');
            }
            
            document.body.style.overflow = (viewName === 'landing' || viewName === 'dashboard') ? 'auto' : 'hidden';

            const themeSwitcher = document.getElementById('theme-switcher');
            if (themeSwitcher) {
                themeSwitcher.style.display = (viewName === 'landing' || viewName === 'dashboard') ? 'block' : 'none';
            }

            const globalFooter = document.getElementById('app-global-footer');
            const footerContentLandingDashboard = document.getElementById('footer-content-landing-dashboard');
            const footerContentEditor = document.getElementById('footer-content-editor');

            if (globalFooter && footerContentLandingDashboard && footerContentEditor) {
                if (viewName === 'editor' && data.projectId) {
                    globalFooter.classList.remove('hidden');
                    footerContentEditor.classList.remove('hidden');
                    footerContentLandingDashboard.classList.add('hidden');
                } else if (viewName === 'landing' || viewName === 'dashboard') {
                    globalFooter.classList.remove('hidden');
                    footerContentLandingDashboard.classList.remove('hidden');
                    footerContentEditor.classList.add('hidden');
                } else {
                    globalFooter.classList.add('hidden');
                }
            }


            if (viewName === 'editor' && data.projectId) {
                document.location.hash = `editor/${data.projectId}`;
            } else if (viewName === 'dashboard') {
                document.location.hash = 'dashboard';
            } else {
                document.location.hash = '';
            }

            switch (viewName) {
                case 'landing': renderLandingPage(); break;
                case 'dashboard': if (mainCurrentUserId) renderDashboard(mainCurrentUserId); break;
                case 'editor': if (mainCurrentUserId && data.projectId) renderEditor(mainCurrentUserId, data.projectId); break;
                default: if(mainCurrentUserId) renderDashboard(mainCurrentUserId); else renderLandingPage();
            }
        }

        // --- App Startup ---
        document.addEventListener('DOMContentLoaded', () => {
            const auth = initializeAuth(firebaseConfig);
            initializeDb(firebaseConfig);

            function handleThemeSwitching() {
                function applyTheme(themeName) {
                    document.documentElement.className = '';
                    document.documentElement.classList.add(themeName);
                    document.querySelectorAll('.theme-button').forEach(btn => {
                        btn.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-gray-900', 'ring-white');
                        if (btn.dataset.theme === themeName) btn.classList.add('ring-2', 'ring-offset-2', 'ring-offset-gray-900', 'ring-white');
                    });
                    currentTheme = themeName;
                    if (document.location.hash.startsWith('#dashboard') && mainCurrentUserId) {
                        renderDashboard(mainCurrentUserId);
                    }
                }
                document.body.addEventListener('click', (event) => {
                    if (event.target.matches('.theme-button')) {
                        applyTheme(event.target.dataset.theme);
                    }
                });
            }
            handleThemeSwitching();

            onAuth(async (user) => {
                if (user) {
                    mainCurrentUserId = user.uid;
                    currentUserId = user.uid;
                    if (user.isAnonymous) {
                        showNotification('You are signed in as a guest. Your data may be lost. Sign up to save your work!', 'info', 7000);
                    }
                    const hash = document.location.hash;
                    if (hash.startsWith('#editor/')) {
                        const projectId = hash.split('/')[1];
                        navigateTo('editor', { projectId });
                    } else {
                        navigateTo('dashboard');
                    }
                } else {
                    mainCurrentUserId = null;
                    currentUserId = null;
                    navigateTo('landing');
                }
            });

            document.body.addEventListener('click', (event) => {
                const target = event.target.closest('.nav-button, [data-route]');
                if (target) {
                    event.preventDefault();
                    const view = target.dataset.route;
                    const projectId = target.dataset.id;
                    navigateTo(view, { projectId });
                }
            });
        });
    </script>
</body>
</html>
