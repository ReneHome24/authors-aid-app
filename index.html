<!DOCTYPE html>
<html lang="en" class="theme-default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Author's Aid | Your AI Co-author for Christian Literature</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
    <!-- Font Awesome for eye icon and loading spinner -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent global scrollbar on editor pages */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
        }
        .font-lora { font-family: 'Lora', serif; }

        /* --- THEME DEFINITIONS --- */
        .theme-default .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(59, 130, 246, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(139, 92, 246, 0.08), transparent 60%); }
        .theme-default .accent-bg { background-color: #2563eb; }
        .theme-default .accent-bg-hover:hover { background-color: #1d4ed8; }
        .theme-default .accent-text { color: #60a5fa; }
        .theme-default .accent-text-hover:hover { color: #3b82f6; }
        .theme-default .accent-ring:focus { ring-color: #3b82f6; }
        .theme-default .ui-bg { background-color: #1f2937; }

        .theme-red .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(220, 38, 38, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(159, 18, 57, 0.1), transparent 60%); }
        .theme-red .accent-bg { background-color: #dc2626; }
        .theme-red .accent-bg-hover:hover { background-color: #b91c1c; }
        .theme-red .accent-text { color: #f87171; }
        .theme-red .accent-text-hover:hover { color: #ef4444; }
        .theme-red .accent-ring:focus { ring-color: #ef4444; }
        .theme-red .ui-bg { background-color: #261717; }


        .theme-gold .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(252, 211, 77, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(245, 158, 11, 0.1), transparent 60%); }
        .theme-gold .accent-bg { background-color: #f59e0b; }
        .theme-gold .accent-bg-hover:hover { background-color: #d97706; }
        .theme-gold .accent-text { color: #fcd34d; }
        .theme-gold .accent-text-hover:hover { color: #fbbf24; }
        .theme-gold .accent-ring:focus { ring-color: #fbbf24; }
        .theme-gold .ui-bg { background-color: #292211; }

        .theme-green .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(16, 185, 129, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(5, 150, 105, 0.1), transparent 60%); }
        .theme-green .accent-bg { background-color: #059669; }
        .theme-green .accent-bg-hover:hover { background-color: #047857; }
        .theme-green .accent-text { color: #34d399; }
        .theme-green .accent-text-hover:hover { color: #10b981; }
        .theme-green .accent-ring:focus { ring-color: #10b981; }
        .theme-green .ui-bg { background-color: #132a23; }

        .theme-purple .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(139, 92, 246, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(124, 58, 237, 0.1), transparent 60%); }
        .theme-purple .accent-bg { background-color: #7c3aed; }
        .theme-purple .accent-bg-hover:hover { background-color: #6d28d9; }
        .theme-purple .accent-text { color: #a78bfa; }
        .theme-purple .accent-text-hover:hover { color: #8b5cf6; }
        .theme-purple .accent-ring:focus { ring-color: #8b5cf6; }
        .theme-purple .ui-bg { background-color: #241c33; }

        /* Quill Editor specific styles */
        .ql-container { border: none !important; display: flex; flex-direction: column; height: 100%; }
        .ql-editor {
            flex-grow: 1; /* Allow editor to take available height */
            font-family: 'Lora', serif;
            font-size: 1.125rem;
            line-height: 1.75;
            background-color: #111827;
            color: #D1D5DB;
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto; /* Ensure Quill editor content scrolls */
            /* FIX: Ensure text starts at the top */
            padding-top: 0 !important; /* Set to 0 and use !important to override Quill's default */
            padding-bottom: 1rem; /* Keep existing bottom padding */
        }
        /* Adjust the first line of content within Quill to start immediately */
        .ql-editor p:first-child,
        .ql-editor h1:first-child,
        .ql-editor h2:first-child,
        .ql-editor h3:first-child,
        .ql-editor ol:first-child,
        .ql-editor ul:first-child {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        .ql-toolbar {
            background-color: #1F2937 !important;
            border-top-left-radius: 8px !important;
            border-top-right-radius: 8px !important;
            border: 1px solid #374151 !important;
            border-bottom: none !important;
        }
        .ql-snow .ql-stroke { stroke: #9CA3AF !important; }
        .ql-snow .ql-picker-label { color: #9CA3AF !important; }
        .ql-snow .ql-picker-options { background-color: #374151 !important; color: #D1D5DB !important; }

        /* Custom scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1F2937; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }

        /* Styles for password toggle */
        .password-input-container {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9CA3AF;
        }

        /* Book Cover Selection Styles */
        .cover-image-wrapper {
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden; /* Ensure border-radius clips content */
        }
        .cover-image-wrapper:hover {
            border-color: #60a5fa; /* Accent color on hover */
        }
        .cover-image-wrapper.selected {
            border-color: #3b82f6; /* Stronger accent color when selected */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); /* Glowing effect */
        }
        .cover-image-wrapper img {
            display: block; /* Remove extra space below image */
        }
        .cover-selection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .cover-image-wrapper.selected .cover-selection-overlay {
            opacity: 1;
        }

        /* Loading spinner for buttons */
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 1em;
            height: 1em;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5em;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom style for dashboard card border based on theme */
        .project-card.theme-border-default { border-color: #2563eb; }
        .project-card.theme-border-red { border-color: #dc2626; }
        .project-card.theme-border-gold { border-color: #f59e0b; }
        .project-card.theme-border-green { border-color: #059669; }
        .project-card.theme-border-purple { border-color: #7c3aed; }

        /* FIX: [v2] New class for the footer on the dashboard/landing page to prevent duplication */
        .main-footer {
             position: relative;
             z-index: 10;
        }

    </style>
</head>
<body>
    
    <!-- Main Application Container -->
    <div id="app-container" class="h-screen flex flex-col"></div>

    <!-- Notification & Modal Containers -->
    <div id="notification-container" class="fixed bottom-20 right-5 z-50"></div>
    <div id="modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4"></div>

    <!-- Theme Switcher (Global) -->
    <div id="theme-switcher" class="fixed bottom-4 right-4 bg-gray-900/80 backdrop-blur-sm p-3 rounded-xl border border-gray-700 shadow-lg">
        <div class="flex space-x-2">
            <button data-theme="theme-default" class="theme-button w-6 h-6 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-offset-gray-900 ring-white" title="Default Blue"></button>
            <button data-theme="theme-red" class="theme-button w-6 h-6 rounded-full bg-red-500" title="Redeemer's Red"></button>
            <button data-theme="theme-gold" class="theme-button w-6 h-6 rounded-full bg-amber-400" title="Golden Light"></button>
            <button data-theme="theme-green" class="theme-button w-6 h-6 rounded-full bg-emerald-500" title="Graceful Green"></button>
            <button data-theme="theme-purple" class="theme-button w-6 h-6 rounded-full bg-violet-500" title="Royal Purple"></button>
        </div>
    </div>

    <!-- The original global footer is now unused and will be recreated dynamically per view -->
    <footer id="app-global-footer" class="ui-bg p-4 border-t border-gray-700 flex-shrink-0 hidden">
        <div id="footer-content-landing-dashboard" class="container mx-auto text-center text-gray-500 hidden">
            <p>&copy; 2025 Author's Aid. All Rights Reserved.</p>
            <p class="mt-2 text-sm">Created with faith for Rene' Stanley.</p>
        </div>
        <div id="footer-content-editor" class="container mx-auto flex justify-between items-center hidden">
            <button id="add-chapter-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">+ New Chapter</button>
            <button id="export-project-btn" class="accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Export Project</button>
            <div class="flex space-x-2 items-center">
                <!-- Theme buttons are removed from here in editor view -->
            </div>
        </div>
    </footer>

    <!-- ALL APPLICATION JAVASCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut as firebaseSignOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, linkWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, serverTimestamp, query, onSnapshot, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVsziM6I1QEU22YNPGTwLvN0EuW4k2SiY",
            authDomain: "christian-author-app-54c4d.firebaseapp.com",
            projectId: "christian-author-app-54c4d",
            storageBucket: "christian-author-app-54c4d.firebasestorage.app",
            messagingSenderId: "386312831448",
            appId: "1:386312831448:web:80999eae638bbed28572ad"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        //======================================================================
        // --- CONSOLIDATED JAVASCRIPT MODULES ---
        //======================================================================

        // --- auth.js content ---
        let authInstance;
        function initializeAuth(config) { if (!authInstance) { const app = initializeApp(config); authInstance = getAuth(app); } return authInstance; }
        function onAuth(callback) { return onAuthStateChanged(authInstance, callback); }
        async function signInAnon() {
            try {
                const result = await signInAnonymously(authInstance);
                showNotification('Signed in as guest!', 'success');
                return result;
            } catch (e) {
                console.error("Anon sign-in failed:", e);
                showNotification(`Guest sign-in failed: ${e.message}`, 'error');
            }
        }
        async function signOut() {
            try {
                await firebaseSignOut(authInstance);
                showNotification('Signed out successfully.', 'info');
            } catch (e) {
                console.error("Sign-out failed:", e);
                showNotification(`Sign-out failed: ${e.message}`, 'error');
            }
        }
        
        // FIX: [v2] Moved handleSignUpClick and handleLoginClick to the global scope to fix ReferenceError on landing page.
        async function handleSignUpClick(e) {
            e.preventDefault();
            const content = `
                <form id="signup-form">
                    <p class="text-gray-400 mb-4">Create an account to save your work permanently.</p>
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="email" name="email" required autocomplete="email" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                    </div>
                    <div class="password-input-container">
                        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="password" name="password" required minlength="6" autocomplete="new-password" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        <span class="password-toggle" data-target="password"><i class="fas fa-eye"></i></span>
                        <p class="text-xs text-gray-400 mt-1">Minimum 6 characters.</p>
                    </div>
                </form>
            `;
            showModal('Sign Up for Free', content, async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                if (email && password) {
                    const user = authInstance.currentUser;
                    if (user && user.isAnonymous) {
                        // Link anonymous account
                        const success = await linkGuestAccount(email, password);
                        if (success) {
                            navigateTo('dashboard');
                        }
                    } else {
                        // Create new account
                        const newUser = await signUpWithEmail(email, password);
                        if (newUser) {
                            navigateTo('dashboard');
                        }
                    }
                }
            }, 'Sign Up');
        }
        
        // FIX: [v2] Moved handleSignUpClick and handleLoginClick to the global scope to fix ReferenceError on landing page.
        async function handleLoginClick(e) {
            e.preventDefault();
            const content = `
                <form id="login-form">
                    <p class="text-gray-400 mb-4">Log in to access your saved projects.</p>
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="login-email" name="email" required autocomplete="email" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                    </div>
                    <div class="password-input-container">
                        <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="login-password" name="password" required autocomplete="current-password" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        <span class="password-toggle" data-target="login-password"><i class="fas fa-eye"></i></span>
                    </div>
                </form>
            `;
            showModal('Log In', content, async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (email && password) {
                    const user = await signInWithEmail(email, password);
                    if (user) {
                        navigateTo('dashboard');
                    }
                }
            }, 'Login');
        }


        // --- firestore.js content ---
        let dbInstance;
        let storageInstance; // Declare storage instance globally for access
        function initializeDb(config) {
            if (!dbInstance) {
                const app = initializeApp(config);
                dbInstance = getFirestore(app);
                storageInstance = getStorage(app); // Initialize Storage
            }
            return dbInstance;
        }
        function getProjectsCollection(userId) { return collection(dbInstance, `artifacts/${appId}/users/${userId}/projects`); }
        async function createProject(userId, data) {
            try {
                const projectRef = await addDoc(getProjectsCollection(userId), { ...data, createdAt: serverTimestamp(), lastModified: serverTimestamp() });
                const sectionsCollection = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectRef.id}/sections`);
                const emptyContent = JSON.stringify({ ops: [{ insert: '\n' }] });
                // Added new 'metadata' section at order 0
                await setDoc(doc(sectionsCollection, 'metadata'), { title: 'Project Metadata', content: JSON.stringify({ authorName: '', copyrightYear: '', publisher: '', isbn: '', seriesName: '', seriesNumber: '', lccn: '' }), order: 0 }); // Added LCCN
                await setDoc(doc(sectionsCollection, 'brainstorming'), { title: 'Synopsis & Brainstorming', content: emptyContent, order: 1 });
                // NEW: Add 'book_titles' section after brainstorming, before character_development
                await setDoc(doc(sectionsCollection, 'book_titles'), { title: 'Book Titles', content: emptyContent, order: 2 });
                await setDoc(doc(sectionsCollection, 'character_development'), { title: 'Character Development', content: emptyContent, order: 3 });
                await setDoc(doc(sectionsCollection, 'world_building'), { title: 'World-building', content: emptyContent, order: 4 });
                await setDoc(doc(sectionsCollection, 'outline'), { title: 'Outline', content: emptyContent, order: 5 });
                await setDoc(doc(sectionsCollection, 'book_cover'), { title: 'Book Cover', content: '', order: 6 });
                // Add new sections for Front and Back Matter
                await setDoc(doc(sectionsCollection, 'front_matter'), { title: 'Front Matter', content: emptyContent, order: 7 });
                await setDoc(doc(sectionsCollection, 'back_matter'), { title: 'Back Matter', content: emptyContent, order: 8 });
                await setDoc(doc(sectionsCollection, 'chapter_1'), { title: 'Chapter 1', content: emptyContent, order: 9 }); // Adjust order for chapters
                return projectRef.id;
            } catch (e) { console.error("Error creating project:", e); showNotification(`Error creating project: ${e.message}`, 'error'); }
        }
        async function addChapter(userId, projectId, chapterNumber) {
             try {
                const sectionsCollection = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`);
                const newChapterId = `chapter_${chapterNumber}`;
                const emptyContent = JSON.stringify({ ops: [{ insert: '\n' }] });
                // Adjust order to be after existing fixed sections (metadata, brainstorming, book_titles, char_dev, world_building, outline, book_cover, front_matter, back_matter)
                // The order for chapter_1 is 9, so subsequent chapters should follow that.
                await setDoc(doc(sectionsCollection, newChapterId), { title: `Chapter ${chapterNumber}`, content: emptyContent, order: 8 + chapterNumber });
                return true;
            } catch (e) { console.error("Error adding chapter:", e); showNotification(`Error adding chapter: ${e.message}`, 'error'); return false; }
        }
        async function getProjects(userId) { try { const qSnapshot = await getDocs(getProjectsCollection(userId)); const projects = []; qSnapshot.forEach(d => projects.push({ id: d.id, ...d.data() })); projects.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); return projects; } catch (e) { console.error("Error fetching projects:", e); showNotification(`Error fetching projects: ${e.message}`, 'error'); return []; } }
        async function getProject(userId, projectId) { try { const docRef = doc(getProjectsCollection(userId), projectId); const docSnap = await getDoc(docRef); return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null; } catch (e) { console.error("Error fetching project:", e); showNotification(`Error fetching project: ${e.message}`, 'error'); } }
        async function getProjectSections(userId, projectId) { try { const sectionsRef = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`); const q = query(sectionsRef, orderBy("order")); const qSnapshot = await getDocs(q); const sections = []; qSnapshot.forEach(d => sections.push({ id: d.id, ...d.data() })); return sections; } catch (e) { console.error("Error fetching sections:", e); showNotification(`Error fetching sections: ${e.message}`, 'error'); return []; } }
        async function getSection(userId, projectId, sectionId) { try { const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, sectionId); const docSnap = await getDoc(sectionRef); return docSnap.exists() ? docSnap.data() : null; } catch (e) { console.error("Error getting section:", e); showNotification(`Error getting section: ${e.message}`, 'error'); return null; } }
        async function updateSectionContent(userId, projectId, sectionId, content) { try { const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, sectionId); await updateDoc(sectionRef, { content }); const projectRef = doc(getProjectsCollection(userId), projectId); await updateDoc(projectRef, { lastModified: serverTimestamp() }); } catch (e) { console.error("Error updating section:", e); showNotification(`Error updating section: ${e.message}`, 'error'); } }
        async function updateProjectCover(userId, projectId, coverUrl) { // New function to update project cover
            try {
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { bookCoverUrl: coverUrl, lastModified: serverTimestamp() });
                showNotification('Book cover saved successfully!', 'success');
            } catch (e) {
                console.error("Error updating project cover:", e);
                showNotification(`Error saving cover: ${e.message}`, 'error');
            }
        }
        // New function to update project title
        async function updateProjectTitle(userId, projectId, newTitle) {
            try {
                const cleanedTitle = stripMarkdownAndHtml(newTitle); // Strip markdown before saving
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { title: cleanedTitle, lastModified: serverTimestamp() });
                showNotification('Project title updated!', 'success');
            } catch (e) {
                console.error("Error updating project title:", e);
                showNotification(`Error updating project title: ${e.message}`, 'error');
            }
        }
        // New function to update project metadata
        async function updateProjectMetadata(userId, projectId, metadata) {
            try {
                const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, 'metadata');
                await updateDoc(sectionRef, { content: JSON.stringify(metadata) });
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { lastModified: serverTimestamp() });
                showNotification('Project metadata saved!', 'success');
            } catch (e) {
                console.error("Error updating project metadata:", e);
                showNotification(`Error saving metadata: ${e.message}`, 'error');
            }
        }

        async function deleteProject(userId, projectId) {
            try {
                await deleteDoc(doc(getProjectsCollection(userId), projectId));
                showNotification('Project deleted.', 'success');
            } catch (e) {
                console.error("Error deleting project:", e);
                showNotification(`Error deleting project: ${e.message}`, 'error');
            }
        }

        // --- utils.js content ---
        function debounce(func, wait) { let timeout; return function(...args) { const later = () => { clearTimeout(timeout); func(...args); args = null; }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
        function showNotification(message, type = 'info', duration = 3000) { const container = document.getElementById('notification-container'); if (!container) return; const notification = document.createElement('div'); let bgColor; switch(type){ case 'success': bgColor='bg-green-500/90 border-green-400'; break; case 'error': bgColor='bg-red-500/90 border-red-400'; break; default: bgColor='bg-blue-500/90 border-blue-400'; break; } notification.className = `p-4 rounded-lg shadow-xl text-white ${bgColor} border mb-4 opacity-0 transition-all duration-500`; container.appendChild(notification); setTimeout(() => notification.classList.remove('opacity-0'), 10); setTimeout(() => { notification.classList.add('opacity-0'); notification.addEventListener('transitionend', () => notification.remove()); }, duration); }
        function showModal(title, contentHtml, onConfirm, confirmText = 'Confirm', showCancel = true) {
            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) return;
            modalContainer.innerHTML = `<div class="bg-gray-800 text-gray-200 rounded-lg shadow-2xl w-full max-w-lg p-6 border border-gray-700"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-lora font-bold">${title}</h2><button id="modal-close-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button></div><div id="modal-content" class="max-h-[70vh] overflow-y-auto">${contentHtml}</div><div class="mt-6 flex justify-end space-x-4">${showCancel ? '<button id="modal-cancel-btn" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 transition-colors">Cancel</button>' : ''}<button id="modal-confirm-btn" type="submit" class="py-2 px-4 rounded-lg accent-bg accent-bg-hover transition-colors font-semibold">${confirmText}</button></div></div>`;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            const closeModal = () => { modalContainer.classList.add('hidden'); modalContainer.classList.remove('flex'); modalContainer.innerHTML = ''; };
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            if (showCancel) {
                document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
            }
            // Reverted: Attach onConfirm directly to the button click for simplicity,
            // as the form submit listener was causing issues.
            document.getElementById('modal-confirm-btn').addEventListener('click', async () => {
                const form = modalContainer.querySelector('form');
                if (form && !form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await onConfirm();
                closeModal();
            });

            // Add password toggle functionality after modal content is rendered
            modalContainer.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const passwordInput = toggle.previousElementSibling; // The input field is the previous sibling
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    toggle.querySelector('i').classList.toggle('fa-eye');
                    toggle.querySelector('i').classList.toggle('fa-eye-slash');
                });
            });
        }

        // Helper function to escape HTML for display in data attributes, moved to global scope
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Helper function to strip common Markdown bold/italic markers, HTML tags, and leading numbers/hashes
        function stripMarkdownAndHtml(text) {
            if (!text) return '';
            let cleanedText = text;

            // Remove Markdown bold (**) and italic (* or _)
            cleanedText = cleanedText.replace(/\*\*(.*?)\*\*/g, '$1'); // bold
            cleanedText = cleanedText.replace(/\*(.*?)\*/g, '$1');   // italic (single asterisk)
            cleanedText = cleanedText.replace(/_(.*?)_/g, '$1');   // italic (underscore)

            // Remove Markdown headings (# at start of line)
            cleanedText = cleanedText.replace(/^#+\s*/gm, ''); // Remove # and leading space at start of line

            // Remove common HTML tags (basic approach, not for complex HTML)
            cleanedText = cleanedText.replace(/<[^>]*>/g, '');

            return cleanedText.trim();
        }

        // New helper to parse numbered lists from AI, removing intros and numbers
        function parseNumberedAiList(aiText, keepNumbers = false) {
            if (!aiText) return [];
            const results = [];

            // First, try to split by numbered list format (e.g., "1. Text")
            let lines = aiText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            let hasNumberedItems = false;
            for (const line of lines) {
                if (line.match(/^(\d+)\.\s*(.*)/)) {
                    hasNumberedItems = true;
                    break;
                }
            }

            if (hasNumberedItems) {
                let isFirstNumberedItemFound = false;
                for (const line of lines) {
                    const match = line.match(/^(\d+)\.\s*(.*)/);
                    if (match) {
                        isFirstNumberedItemFound = true;
                        const number = match[1];
                        const content = match[2];
                        if (keepNumbers) {
                            results.push(`${number}. ${content}`);
                        } else {
                            results.push(content);
                        }
                    } else if (isFirstNumberedItemFound) {
                        // If we've already found numbered items, and this line is not numbered, it's part of the previous item
                        if (results.length > 0) {
                            results[results.length - 1] += `\n${line}`;
                        }
                    }
                }
            } else {
                // If no numbered list is found, assume it's paragraphs separated by double newlines
                const paragraphs = aiText.split(/\n\s*\n/).map(p => p.trim()).filter(p => p.length > 0);
                for (const paragraph of paragraphs) {
                    results.push(paragraph);
                }
            }
            return results;
        }


        // --- aiService.js content ---
        // FIX: [v2] Hardcoded API key changed to an empty string to allow the Canvas environment to inject it.
        const API_KEY = "AIzaSyCVsziM6I1QEU22YNPGTwLvN0EuW4k2SiY";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
        const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;

        // Global variable to store AI style preference
        let aiStylePreference = "";

        // Knowledge base for character types
        const characterTypesKnowledge = `
Characters are the lifeblood of fiction, driving the plot and engaging readers. While every character should feel unique and real, they often fall into certain categories or roles within a manuscript. Here's a breakdown of different types of characters, often considered in terms of their role, dynamism, and archetypal qualities:
I. By Role in the Narrative:
Protagonist: The central character of the story. The plot usually revolves around their journey, goals, and development. Readers are meant to invest in and care about them. There can be multiple protagonists in a story.
Examples: Katniss Everdeen (The Hunger Games), Harry Potter (Harry Potter series), Elizabeth Bennet (Pride and Prejudice).
Antagonist: The character or force that opposes the protagonist and creates conflict. They don't always have to be "evil"; sometimes they simply represent an opposing viewpoint or obstacle.
Examples: Lord Voldemort (Harry Potter series), President Coriolanus Snow (The Hunger Games), Mr. Darcy (initially, in Pride and Prejudice). An antagonist can also be an inanimate force like nature or society.
Deuteragonist: The second most important character, often serving as a close ally or companion to the protagonist. They might offer a different perspective or have their own subplot.
Examples: Dr. John Watson (Sherlock Holmes), Samwise Gamgee (Lord of the Rings).
Confidant(e): A character in whom the protagonist trusts and shares their thoughts and feelings. This allows the author to reveal the protagonist's inner world to the reader without relying solely on internal monologue.
Examples: Hermione Granger (Harry Potter series), Albus Dumbledore (Harry Potter series).
Love Interest: The romantic counterpart to the protagonist. Their relationship often impacts the protagonist's development and the overall plot.
Examples: Peeta Mellark (The Hunger Games), Mr. Darcy (later, in Pride and Prejudice).
Mentor: A wise and experienced character who guides, advises, and supports the protagonist. They often provide knowledge, training, or a moral compass.
Examples: Obi-Wan Kenobi (Star Wars), Albus Dumbledore (Harry Potter series).
Foil: A character who highlights the qualities (often contrasting ones) of another character, usually the protagonist, through comparison. They aren't necessarily antagonists.
Examples: Draco Malfoy to Harry Potter (highlighting Harry's inherent goodness), Effie Trinket to Katniss Everdeen (highlighting Katniss's grounded nature).
Sidekick: A character who supports the protagonist, often offering comic relief, practical assistance, or a loyal friendship.
Examples: Ron Weasley (Harry Potter series), Samwise Gamgee (Lord of Lord of the Rings).
Tertiary/Minor Characters (or Extras): Background characters who populate the story's world and add realism. They may have brief appearances and serve specific, often limited, functions.
II. By Dynamism and Complexity:
Dynamic Character: A character who undergoes significant internal change, growth, or transformation throughout the story due to the events they experience.
Examples: Ebenezer Scrooge (A Christmas Carol), Harry Potter (as he matures throughout the series).
Static Character: A character who remains largely the same throughout the story, without significant internal change. They often serve to highlight the changes in dynamic characters or maintain consistency in the narrative.
Examples: Many side characters or minor antagonists who have a fixed role.
Round Character: A complex and well-developed character with multiple personality traits, motivations, and sometimes contradictions, making them feel realistic and multifaceted. Dynamic characters are usually round.
Flat Character: A less developed character, often defined by one or two dominant traits. They typically serve a specific purpose in the plot or to represent a stereotype, rather than undergoing deep personal change. Stock characters (see below) are often flat.
Stock Character: A stereotypical character that is instantly recognizable due to recurring traits in various stories and genres (e.g., the "mad scientist," the "tough detective," the "damsel in distress"). While they can be clichés if not handled well, they can also be useful for quickly establishing a type of character.
Symbolic Character: A character who represents a larger idea, theme, or concept within the story, often beyond their literal role.
Example: Boo Radley in To Kill a Mockingbird can symbolize the hidden goodness in society or the innocence destroyed by prejudice.
III. By Archetype (based on Jungian psychology and recurring patterns in storytelling):
Archetypes are universally recognizable character types that resonate across cultures and time periods. While a character's role might be "protagonist," their archetype might be "The Hero."
Some common archetypes include:
The Hero: Embarks on a journey, faces challenges, and undergoes transformation to achieve a goal. (Often the protagonist).
The Innocent: Pure, optimistic, and seeks happiness. Vulnerable but can inspire others.
The Sage/Mentor: Possesses wisdom, knowledge, and guides others.
The Explorer: Driven by curiosity and a desire to push boundaries, seeking discovery and self-improvement.
The Ruler: Seeks control and power, often responsible for order or chaos.
The Creator: A visionary who brings new things into existence (art, ideas, structures).
The Caregiver: Nurturing, selfless, and protective of others.
The Everyman/Everywoman: Relatable and ordinary, representing the common person.
The Lover: Guided by the heart, valuing connection, passion, and sensuality.
The Jester/Trickster: Provides comic relief, challenges the status quo, and can be mischievous or insightful.
The Rebel/Outlaw: Defies societal norms and seeks revolution or freedom.
The Magician: Possesses special knowledge or abilities, often transforming things.
The Shadow: Represents the dark side of human nature, often the antagonist or an internal struggle within the protagonist.
Understanding these different types of characters can help authors create a diverse and compelling cast, ensuring that each character serves a purpose in advancing the plot, exploring themes, and engaging the reader.
`;
        // Function to call Imagen API for image generation
        async function generateImage(prompt) {
            console.log("generateImage: Starting image generation for prompt:", prompt);
            try {
                // FIX: [v2] Clear the container before showing the loading spinner
                const coverDisplayContainer = document.getElementById('cover-display-container');
                coverDisplayContainer.innerHTML = `<div class="flex items-center justify-center py-4"><div class="loading-spinner"></div><span class="ml-2">Generating images...</span></div>`;

                const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 3 } }; // Request 3 images
                console.log("generateImage: Sending payload to Imagen API:", payload);
                const response = await fetch(IMAGEN_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Imagen API Error Response:", errorData);
                    let errorMessage = `Image generation failed with status ${response.status}.`;
                    if (errorData && errorData.error && errorData.error.message) {
                        errorMessage += ` Details: ${errorData.error.message}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log("generateImage: Received Imagen API response:", result);
                if (result.predictions && result.predictions.length > 0) {
                    const imageUrls = result.predictions.map(p => `data:image/png;base64,${p.bytesBase64Encoded}`);
                    console.log("generateImage: Generated image URLs:", imageUrls);
                    return imageUrls;
                } else {
                    console.error("Imagen Error: Unexpected response structure or no predictions:", result);
                    return [];
                }
            } catch (e) {
                console.error("Error calling Imagen API:", e);
                showNotification(`Image generation failed: ${e.message}`, 'error');
                return [];
            } finally {
                // The outputDiv will be managed by the calling function (ai-cover-concept-btn handler)
                // coverDisplayContainer will be updated by the calling function
            }
        }


        async function callGemini(contents) {
            console.log("callGemini: Starting Gemini call with contents:", contents);
            try {
                // FIX: [v2] Clear the AI output div before showing the loading spinner
                const outputDiv = document.getElementById('ai-output');
                if (outputDiv) {
                     outputDiv.innerHTML = `<div class="flex items-center justify-center py-4"><div class="loading-spinner"></div><span class="ml-2">Generating...</span></div>`;
                }

                // Prepend style preference to the prompt
                const finalContents = contents.map(item => {
                    if (item.parts && item.parts.length > 0 && item.parts[0].text) {
                        return {
                            ...item,
                            parts: [{ text: `AI Style Preference: ${aiStylePreference}\n\n${item.parts[0].text}` }]
                        };
                    }
                    return item;
                });
                console.log("callGemini: Final contents sent to Gemini:", finalContents);

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: finalContents })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("AI API Error Response:", errorData);
                    let errorMessage = `API request failed with status ${response.status}.`;
                    if (response.status === 403) {
                        errorMessage += " This usually means the API is not enabled for your Google Cloud project or your API key has insufficient permissions.";
                    } else if (response.status === 429) {
                        errorMessage += " You've exceeded your API quota. Please try again later.";
                    } else if (errorData && errorData.error && errorData.error.message) {
                        errorMessage += ` Details: ${errorData.error.message}`;
                    } else {
                        errorMessage += ` Details: ${JSON.stringify(errorData.error || errorData)}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log("callGemini: Received Gemini API response:", result);
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    const textResult = result.candidates[0].content.parts[0].text;
                    console.log("callGemini: Extracted text result:", textResult);
                    return textResult;
                } else {
                    console.error("AI Error: Unexpected response structure or no content in Gemini response:", result);
                    return "Error: Could not generate content (unexpected AI response).";
                }
            } catch (e) {
                console.error("Error calling Gemini API:", e);
                showNotification(`AI call failed: ${e.message}`, 'error');
                return `Error: API call failed: ${e.message}`;
            } finally {
                // The outputDiv will be managed by the calling function (e.g., generate-synopsis-concepts-btn handler)
            }
        }


        async function generateSynopsisIdeas(idea) {
            // Updated prompt to be more specific about Christian literature and explicitly exclude titles.
            const prompt = `You are an AI story consultant for Christian literature. Based on the user's basic idea, generate a numbered list of 5 distinct core concept ideas for a new Christian book. Each concept should be a single, concise paragraph describing the core idea, without suggesting a title. The tone should be encouraging and creative.\n\nBasic Idea: "${idea}"`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateOutlineBeats(context, bookTitle) { // Added bookTitle parameter
            // Ensure outline generation uses all relevant context
            const prompt = `You are an AI outliner for a Christian author. Based on the provided project details (synopsis, characters, world-building, and desired book title), generate a detailed chapter-by-chapter outline with key beats for each chapter. Ensure the outline aligns with Christian themes and values established in the context.
            **IMPORTANT:** When referring to characters in the outline beats, ALWAYS use their specific character names (e.g., "Amara," "Nana Elena") instead of their roles (e.g., "protagonist," "mentor"). This is especially crucial for the protagonist.

            Start the outline with the book title:
            ${bookTitle}

            For each chapter, list the chapter title (without asterisks or bold formatting), and then provide a numbered list of key beats for that chapter. For example:
            Chapter 1: The Beginning
            1. Beat 1 of Chapter 1: Introduce protagonist and their core conflict.
            2. Beat 2 of Chapter 1: Character meets mentor.
            3. Beat 3 of Chapter 1: Call to adventure.

            Project Details:
            ---
            ${context}
            ---

            Generate the chapter-by-chapter outline:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateCharacterProfiles(context) {
            // Ensure character generation uses synopsis and title context
            const prompt = `You are an AI character developer for Christian fiction. Based on the provided project details (synopsis, book title), generate a numbered list of 5 distinct character profile ideas. Each profile should include a name, a brief backstory, core motivations, personality quirks, and **explicitly identify what type of character they are based on the following taxonomy (By Role, By Dynamism and Complexity, and By Archetype).** Ensure characters are suitable for a Christian narrative, exploring themes of faith, redemption, struggle, or virtue.

${characterTypesKnowledge}

Project Details:
---
${context}
---

Generate 5 character profiles:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateWorldPrompts(context) {
            // FIX: Updated prompt to explicitly exclude titles and focus only on world-building elements.
            const prompt = `You are an AI world-builder for Christian narratives. Based on the provided project details (synopsis, book title, characters), generate a numbered list of 5 distinct world-building element ideas. These could include unique faith-based societal structures, spiritual challenges, miraculous phenomena, or historical events relevant to a Christian story. Provide ONLY the descriptive world-building idea, without suggesting a title for the idea itself.
            \n\nProject Details:\n---\n${context}\n---\n\nGenerate 5 world-building prompts:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function suggestAlternatives(selectedText, context) { const prompt = `You are an AI thesaurus and editor for Christian literature. Given the following selected word/phrase and its surrounding context, provide a numbered list of 5 alternative words or short phrases that would fit well within a Christian-themed manuscript, considering tone and theological appropriateness.\n\nContext:\n---\n${context}\n---\n\nSelected Text: "${selectedText}"\n\nProvide 5 alternatives:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function suggestScripture(selectedText, context) { const prompt = `You are a theological assistant specializing in the NIV Bible. Based on the following selected text, suggest a numbered list of 3 relevant NIV Bible scriptures. For each, provide the reference and the full verse text.\n\nSelected Text for Context:\n---\n${context}\n---\n\nSuggest 3 relevant NIV scriptures:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function suggestPOVs(context) { const prompt = `You are an AI writing coach for Christian authors. Based on the story's synopsis, generate a numbered list of 3 potential Point of View (POV) & Voice choices (e.g., First Person, Third Person Limited). For each, briefly explain how that choice would shape the narration and affect the reader's experience, particularly in a Christian context.\n\nSynopsis:\n---\n${context}\n-\n\nGenerate 3 POV & Voice options:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function suggestStructures(context) { const prompt = `You are an AI writing coach for Christian authors. Based on the story's synopsis, suggest a numbered list of 3 potential structural templates (e.g., Three-Act Structure, Hero's Journey, Fichtean Curve). For each, briefly explain why that structure would be a good fit for the story, considering its Christian themes.\n\nSynopsis:\n---\n${context}\n---\n\nSuggest 3 structural templates:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function analyzeChapter(chapterText, context) {
            // Ensure chapter analysis uses full project context
            const prompt = `You are an AI developmental editor for Christian manuscripts. Review the following book chapter in the context of the provided project details (synopsis, characters, world-building, outline, and book title). Provide high-level feedback on Pacing, Plot Progression, and Character Consistency, specifically noting how well it integrates Christian themes or moral lessons. The feedback should be constructive and encouraging.\n\nProject Details:\n---\n${context}\n---\n\nChapter Text to Analyze:\n---\n${chapterText}\n---\n\nProvide your analysis:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function proofreadChapter(chapterText) { const prompt = `You are an AI proofreader. Review the following text and provide a numbered list of suggested corrections for any grammatical errors, spelling mistakes, or punctuation issues. For each suggestion, clearly state the original text and the proposed change.\n\nText to Proofread:\n---\n${chapterText}\n---\n\nSuggestions:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function suggestYouthPhrases(selectedText, context) { const prompt = `You are an AI dialogue coach. Given the following selected text (likely dialogue) and its surrounding context, provide a numbered list of 5 alternative phrases that sound more contemporary or like common youth slang. Ensure suggestions are appropriate and fit a Christian context if possible.\n\nContext:\n---\n${context}\n---\n\nSelected Text: "${selectedText}"\n\nProvide 5 youth phrase alternatives:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); } // New AI function
        async function generateCoverConcepts(context) {
            // CORRECTED PROMPT: Explicitly tell AI to generate ONLY the descriptive prompt, no "Concept: " prefix.
            // Emphasize Christian themes for cover concepts
            const prompt = `You are an AI art director for Christian book covers. Based on the provided book synopsis, generate 3 distinct and compelling visual concepts for a book cover. Each concept should be a short, descriptive paragraph that could be used as a prompt for an AI image generator. Focus on imagery that reflects Christian themes, symbolism, or the spiritual journey of the characters. Provide ONLY the descriptive image prompt text. Do NOT include any "Concept X:" prefixes or introductory sentences like "Here are 3 distinct and compelling visual concepts...".\n\nSynopsis:\n---\n${context}\n---\n\nGenerate 3 book cover concepts:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        
        // FIX: [v2] The AI's prompt has been updated to be more specific and aware of the current chapter and its beats.
        async function generateNext(currentText, projectTitle, outlineContent, currentChapterTitle) { // New parameter for current chapter title
            
            // FIX: [v2] Parse the outline to find the next beat.
            const parsedOutline = parseOutline(outlineContent);
            const currentChapterNumber = parseInt(currentChapterTitle.match(/Chapter (\d+)/)?.[1]);
            const currentChapterBeats = parsedOutline.find(c => c.number === currentChapterNumber)?.beats;
            
            if (!currentChapterBeats) {
                console.warn("Could not find beats for the current chapter.");
                // Fallback to a general prompt if no beats are found
                const prompt = `You are a Christian ghostwriter. Your task is to continue the narrative for a book titled "${projectTitle}".
                
                Current Chapter: "${currentChapterTitle}".
                
                Current Chapter Content:
                ---
                ${currentText}
                ---

                Continue the story, ensuring the tone, style, and Christian themes are consistent. Do not generate a new chapter title.`;
                return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
            }
            
            // FIX: [v2] Determine the next beat to write based on the current content.
            let nextBeat = null;
            const currentParagraphs = currentText.split(/\n\s*\n/).filter(p => p.trim() !== '');
            const lastParagraph = currentParagraphs.length > 0 ? currentParagraphs.pop() : '';
            
            // A simple way to check if a beat has been addressed by checking for a substring match.
            // This can be improved with more complex logic.
            let lastBeatIndex = -1;
            for (let i = 0; i < currentChapterBeats.length; i++) {
                if (currentText.includes(currentChapterBeats[i])) {
                    lastBeatIndex = i;
                }
            }
            
            if (lastBeatIndex < currentChapterBeats.length - 1) {
                nextBeat = currentChapterBeats[lastBeatIndex + 1];
            } else {
                nextBeat = "Conclude this chapter based on the final beat and prepare for the next chapter's transition.";
            }

            const prompt = `You are a Christian ghostwriter. Your task is to continue the narrative for a book titled "${projectTitle}".
            
            Current Chapter: "${currentChapterTitle}".
            
            The next key beat to address in the outline is: "${nextBeat}".
            
            Current Chapter Content:
            ---
            ${currentText}
            ---

            Continue the story, focusing on the next key beat. Ensure the tone, style, and Christian themes are consistent. Do not generate a new chapter title; simply continue the narrative.`;
            
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        
        // New AI function to generate titles
        async function generateTitles(context) {
            // Ensure title generation uses synopsis context and asks for Christian titles
            const prompt = `You are an AI creative assistant for Christian authors. Based on the following synopsis or brainstorming content, generate 5 distinct and compelling title suggestions for a Christian book. Provide ONLY the title and optional subtitle. Do NOT include any descriptive sentences or explanations after the title.\n\nContent:\n---\n${context}\n---\n\nGenerate 5 title suggestions:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }


        // --- views.js content ---
        const appContainer = document.getElementById('app-container');
        // FIX: [v2] Consolidated two user ID variables into one for consistency
        let currentUserId = null;
        // This variable will store the current selection range for 'Alternative Words' and 'Suggested Youth Phrases'
        let currentSelectionRange = null;
        let currentTheme = 'theme-default'; // Track current theme for dynamic borders

        // FIX: [v2] Utility function to parse the outline into a structured object for easier AI prompting
        function parseOutline(outlineText) {
            const chapters = [];
            let currentChapter = null;
            const lines = outlineText.split('\n').filter(line => line.trim().length > 0);

            for (const line of lines) {
                const chapterMatch = line.match(/^Chapter (\d+): (.*)/);
                const beatMatch = line.match(/^\d+\. (.*)/);

                if (chapterMatch) {
                    const number = parseInt(chapterMatch[1]);
                    const title = chapterMatch[2].trim();
                    currentChapter = { number, title, beats: [] };
                    chapters.push(currentChapter);
                } else if (beatMatch && currentChapter) {
                    currentChapter.beats.push(beatMatch[1].trim());
                }
            }
            return chapters;
        }


        // Function to render the Help modal
        function renderHelpModal() {
            const helpContent = `
                <div class="space-y-4 text-gray-300 overflow-y-auto max-h-[70vh] pr-4">
                    <p class="text-lg font-semibold text-white">Welcome to Author's Aid!</p>
                    <p>Your AI Co-author is here to assist you through every step of your manuscript writing journey, grounded in Christian values.</p>

                    <h4 class="text-md font-semibold text-white mt-4">Getting Started:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Sign Up/Login:</strong> Create an account to save your projects permanently across sessions. You can also continue as a guest, but guest data may not persist.</li>
                        <li><strong>New Project:</strong> From the Dashboard, click "+ New Project" to start a new book. Provide a title and select its type, genre, and target audience.</li>
                        <li><strong>Dashboard:</strong> View all your existing projects, open them, or delete them.</li>
                    </ul>

                    <h4 class="text-md font-semibold text-white mt-4">Using the Editor:</h4>
                    <p>The main editor screen is where your writing and AI tools come together. It's divided into three main panels:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Left Sidebar:</strong> Navigate between different sections of your project (Synopsis & Brainstorming, Book Titles, Character Development, Outline, Chapters, Book Cover, etc.).</li>
                        <li><strong>Center Panel:</strong> This is your primary writing area, powered by Quill.js. Type directly here, and your progress is automatically saved.</li>
                        <li><strong>Right Sidebar (AI Co-Author):</strong> This is where you interact with the AI tools.</li>
                    </ul>

                    <h4 class="text-md font-semibold text-white mt-4">AI Co-Author Features:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>AI Style Preference:</strong> Use the text area at the top to describe the writing style or tone you'd like the AI to adopt (e.g., "Write in a formal, encouraging tone," "Use concise, impactful language"). This preference is applied to all AI-generated content.</li>
                        <li><strong>Generate Synopsis Ideas (Synopsis & Brainstorming):</strong> Provide a basic idea in the editor, and the AI will generate core concept ideas for your book.</li>
                        <li><strong>Generate Titles (Book Titles):</strong> Based on your synopsis, the AI can suggest compelling book titles.</li>
                        <li><strong>POV & Voice (Synopsis & Brainstorming):</strong> Based on your synopsis, the AI can suggest different points of view and narrative voices.</li>
                        <li><strong>Structural Template (Synopsis & Brainstorming):</strong> Get AI-generated structural ideas (e.g., Three-Act Structure) for your story.</li>
                        <li><strong>Generate Character Profiles (Character Development):</strong> The AI helps you create detailed character ideas based on your story's concept.</li>
                        <li><strong>Generate Chapter Beats (Outline):</strong> Get a detailed chapter-by-chapter outline based on your project's foundation.</li>
                        <li><strong>Continue Writing (Chapters):</strong> Overcome writer's block! Click this button in any chapter to have the AI generate the next section of text, using your existing content and project context.</li>
                        <li><strong>Analyze Chapter (Chapters):</strong> Get high-level feedback on pacing, plot progression, and character consistency for your chapter.</li>
                        <li><strong>Proofread Chapter (Chapters):</strong> Receive suggested corrections for grammar, spelling, and punctuation. Click on a suggestion to apply the fix directly to your text.</li>
                        <li><strong>Suggest Youth Phrases (Chapters):</strong> Select text (e.g., dialogue) and get contemporary youth slang suggestions, suitable for a Christian context.</li>
                        <li><strong>Generate Image Prompts (Book Cover):</strong> Get descriptive prompts for an AI image generator based on your book's synopsis. Click a concept to generate a visual book cover.</li>
                        <li><strong>Select Book Cover (Book Cover):</strong> After generating images, click on your preferred cover to highlight it and save its URL to your project.</li>
                    </ul>

                    <h4 class="text-md font-semibold text-white mt-4">Exporting Your Work:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Export Project:</strong> Use the "Export Project" button in the footer to download your entire manuscript as a clean HTML file. This file is suitable for importing into professional book formatting software for eBook and print preparation.</li>
                    </ul>

                    <p class="text-sm text-gray-400 mt-4">Remember that AI generation relies on external services. If you encounter "API call failed" errors, please check your Google Cloud Project settings for API enablement and quotas.</p>
                </div>
            `;
            showModal('How to Use Author\'s Aid', helpContent, () => {}, 'Close', false); // No confirm button, just close
        }

        // FIX: [v2] Moved the footer generation into each render function to prevent duplication
        function renderLandingPage() {
            document.body.style.overflow = 'auto';
            document.getElementById('theme-switcher').style.display = 'block';
            appContainer.innerHTML = `
                <div class="gradient-bg flex flex-col min-h-full">
                    <header class="w-full z-10 p-4">
                        <div class="container mx-auto flex justify-between items-center">
                            <h1 class="text-2xl font-bold font-lora text-white">Author's Aid</h1>
                            <nav class="hidden md:flex space-x-6 items-center">
                                <a href="#features" class="accent-text-hover transition-colors">Features</a>
                                <a href="#" id="sign-up-link" class="accent-text-hover transition-colors">Sign Up</a>
                                <a href="#" id="login-link" class="accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg transition-colors">Login</a>
                            </nav>
                        </div>
                    </header>
                    <main class="relative pt-32 pb-20 md:pt-48 md:pb-32 flex-grow">
                        <div class="container mx-auto text-center px-4">
                            <h2 class="text-4xl md:text-6xl font-bold font-lora text-white leading-tight mb-4">Your AI Co-Author, Guided by Faith</h2>
                            <p class="text-lg md:text-xl text-gray-400 max-w-3xl mx-auto mb-8">
                                Welcome, Rene' Stanley. Author's Aid is your personalized writing partner, trained on your unique style and grounded in Christian values. From manuscript to cover, let's bring your next masterpiece to life.
                            </p>
                            <button id="guest-btn" class="accent-bg accent-bg-hover text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 inline-block">Continue as Guest</button>
                        </div>
                    </main>
                    <section id="features" class="py-20 bg-black/30">
                        <div class="container mx-auto px-4"><div class="text-center mb-12"><h3 class="text-3xl md:text-4xl font-bold font-lora">A Tool for Every Step of Your Journey</h3></div>
                        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">AI Co-Author & Ghostwriter</h4><p class="text-gray-400">Trained on your works, the AI learns your voice to help write, edit, and offer suggestions that sound authentically like you.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Multi-Format Support</h4><p class="text-gray-400">Get a tailored roadmap for fiction, non-fiction, devotionals, or Bible studies.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Faith-Based Assistance</h4><p class="text-gray-400">Get suggestions for relevant NIV Bible scriptures and theological insights.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Book Cover Generation</h4><p class="text-gray-400">Generate professional front, spine, and back covers using AI image prompts.
</p></div>
                        </div>
                    </section>
                    <section id="cta" class="py-20 bg-black/30">
                        <div class="container mx-auto text-center px-4">
                            <h3 class="text-3xl md:text-4xl font-bold font-lora text-white mb-4">Ready to Write Your Next Chapter?</h3>
                            <p class="text-lg text-gray-400 max-w-2xl mx-auto mb-8">Sign up today to begin your journey with an AI partner that understands your faith, your voice, and your vision.</p>
                            <div class="max-w-md mx-auto">
                                <form class="flex flex-col sm:flex-row gap-4">
                                    <input type="email" placeholder="Enter your email" class="w-full px-4 py-3 rounded-lg bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 accent-ring" required>
                                    <button type="submit" id="signup-free-btn" class="accent-bg accent-bg-hover text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">Sign Up for Free</button>
                                </form>
                            </div>
                        </div>
                    </section>
                     <!-- This footer is now local to this view -->
                    <footer class="ui-bg p-4 border-t border-gray-700 flex-shrink-0 main-footer">
                        <div class="container mx-auto text-center text-gray-500">
                            <p>&copy; 2025 Author's Aid. All Rights Reserved.</p>
                            <p class="mt-2 text-sm">Created with faith for Rene' Stanley.</p>
                        </div>
                    </footer>
                </div>
            `;
            document.getElementById('guest-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                showNotification('Signing in as guest...');
                await signInAnon();
            });
            document.getElementById('signup-free-btn').addEventListener('click', handleSignUpClick);
            document.getElementById('login-link').addEventListener('click', handleLoginClick); // Changed to call handleLoginClick
            document.getElementById('sign-up-link').addEventListener('click', handleSignUpClick);
        }

        async function renderDashboard(userId) {
            currentUserId = userId;
            document.body.style.overflow = 'auto';
            document.getElementById('theme-switcher').style.display = 'block';
            appContainer.innerHTML = '';
            appContainer.appendChild(renderHeader(true, false, userId)); // Pass userId to header
            const mainContent = document.createElement('main');
            mainContent.className = "container mx-auto p-8 flex-grow";
            mainContent.innerHTML = `<div class="text-center text-gray-400">Loading projects...</div>`;
            appContainer.appendChild(mainContent);

            const projects = await getProjects(userId);
            let listHtml = projects.map(p => {
                // Determine the border color class based on the current theme
                const themeBorderClass = `theme-border-${currentTheme.replace('theme-', '')}`;

                return `
                <div class="project-card bg-gray-800 p-4 rounded-lg border-2 ${themeBorderClass} flex flex-col items-center text-center">
                    <div class="mb-2">
                        ${p.bookCoverUrl ? `<img src="${p.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/150x225/1F2937/D1D5DB?text=Image+Load+Error';" class="w-[150px] h-[225px] object-cover rounded-md shadow-md" alt="Book Cover Thumbnail"/>` : `<img src="https://placehold.co/150x225/1F2937/D1D5DB?text=No+Cover" class="w-[150px] h-[225px] object-cover rounded-md shadow-md" alt="Placeholder Cover"/>`}
                    </div>
                    <div class="flex-grow flex flex-col justify-between w-full">
                        <div>
                            <h3 class="text-xl font-lora font-semibold text-white leading-tight mb-1">${stripMarkdownAndHtml(p.title || 'Untitled Project')}</h3>
                            ${p.authorName ? `<p class="text-sm text-gray-400">by ${escapeHtml(p.authorName)}</p>` : ''}
                        </div>
                        <p class="text-xs text-gray-500 mt-auto">Edited: ${p.lastModified ? new Date(p.lastModified.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                    </div>
                    <div class="flex mt-4 space-x-2 w-full">
                        <button data-route="editor" data-id="${p.id}" class="nav-button flex-grow accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Open</button>
                        <button data-action="delete" data-id="${p.id}" class="bg-gray-600 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">🗑️</button>
                    </div>
                </div>`;
            }).join('');

            if (projects.length === 0) {
                listHtml = `<p class="col-span-full text-center text-gray-400">You have no projects yet. Start your first one!</p>`;
            }

            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-lora font-bold text-white">Your Projects</h2>
                    <button id="new-project-btn" class="accent-bg accent-bg-hover text-white font-bold py-2 px-6 rounded-lg text-lg">+ New Project</button>
                </div>
                <div id="dashboard-gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    ${listHtml}
                </div>
                 <!-- This footer is now local to this view -->
                <footer class="ui-bg p-4 border-t border-gray-700 flex-shrink-0 main-footer">
                    <div class="container mx-auto text-center text-gray-500">
                        <p>&copy; 2025 Author's Aid. All Rights Reserved.</p>
                        <p class="mt-2 text-sm">Created with faith for Rene' Stanley.</p>
                    </div>
                </footer>
                `;

            document.getElementById('new-project-btn').addEventListener('click', handleNewProject);
            // FIX: Replaced `dom.dashboard.gallery` with the correct ID of the parent element
            document.getElementById('dashboard-gallery').addEventListener('click', (event) => {
                const deleteBtn = event.target.closest('[data-action="delete"]');
                if (deleteBtn) {
                    const projectId = deleteBtn.dataset.id;
                    // FIX: Removed unnecessary `bookTitle` parameter from the call
                    handleDeleteProject(projectId);
                }
                const selectProjectBtn = event.target.closest('[data-action="select-project"]');
                if (selectProjectBtn) {
                    const projectId = selectProjectBtn.dataset.projectId;
                    selectProject(projectId);
                }
            });
        }

        function handleNewProject() {
            const content = `
                <form id="new-project-form">
                    <div class="space-y-4">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Enter your book title (optional)</label>
                            <input type="text" id="title" name="title" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        </div>
                        <div>
                            <label for="bookType" class="block text-sm font-medium text-gray-300 mb-1">Book Type</label>
                            <select id="bookType" name="bookType" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>Fiction</option>
                                <option>Non-Fiction</option>
                                <option>Low Content</option>
                            </select>
                        </div>
                        <div>
                            <label for="genre" class="block text-sm font-medium text-gray-300 mb-1">Genre</label>
                            <select id="genre" name="genre" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>Christian Romance</option>
                                <option>Christian Fantasy</option>
                                <option>Christian Thriller</option>
                                <option>Children's Storybook</option>
                                <option>Devotional</option>
                                <option>Bible Study</option>
                                <option>Memoir</option>
                                <option>Christian Living</option>
                                <option>Theology</option>
                                <option>History</option>
                                <option>Prayer Journal</option>
                                <option>Gratitude Journal</option>
                                <option>Planner</option>
                            </select>
                        </div>
                        <div>
                            <label for="targetAudience" class="block text-sm font-medium text-gray-300 mb-1">Target Audience</label>
                            <select id="targetAudience" name="targetAudience" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>African American Adult</option>
                                <option>African American Young Adult</option>
                                <option>African American Children</option>
                                <option>Adult</option>
                                <option>Young Adult</option>
                                <option>Middle Grade</option>
                                <option>Children</option>
                                <option>All Ages</option>
                            </select>
                        </div>
                    </div>
                </form>
            `;
            showModal('Create a New Project', content, async () => {
                const title = document.getElementById('title').value || 'Untitled Project';
                const bookType = document.getElementById('bookType').value;
                const genre = document.getElementById('genre').value;
                const targetAudience = document.getElementById('targetAudience').value;
                const projectData = { title, bookType, genre, targetAudience };
                const newId = await createProject(currentUserId, projectData);
                if (newId) {
                    navigateTo('editor', { projectId: newId });
                }
            }, 'Create Project');
        }

        function handleDeleteProject(projectId) {
            showModal('Confirm Deletion', '<p>Are you sure you want to permanently delete this project and all its content?</p>', async () => {
                await deleteProject(currentUserId, projectId);
                renderDashboard(currentUserId);
            }, 'Delete');
        }

        async function renderEditor(userId, projectId) {
            console.log("renderEditor: Rendering editor for projectId:", projectId);
            currentUserId = userId;
            document.body.style.overflow = 'hidden'; /* Prevent global scrollbar on editor page */
            document.getElementById('theme-switcher').style.display = 'none'; /* Hide global switcher */
            appContainer.innerHTML = ''; // Clear existing content

            appContainer.appendChild(renderHeader(true, true, userId)); // Pass userId to header
            const mainContent = document.createElement('main');
            mainContent.className = "flex flex-grow flex-col h-full min-h-0"; /* Added min-h-0 */
            mainContent.innerHTML = `<div class="text-center text-gray-400">Loading project...</div>`;
            appContainer.appendChild(mainContent);

            const project = await getProject(userId, projectId);
            if (!project) {
                console.error("renderEditor: Project not found for projectId:", projectId);
                mainContent.innerHTML = `<div class="text-center text-red-400 p-8">Error: Project not found.</div>`;
                return;
            }
            console.log("renderEditor: Project data loaded:", project);

            mainContent.innerHTML = `
                <div class="flex flex-grow overflow-hidden"> <!-- Changed to overflow-hidden to contain internal scrolling -->
                    <div id="left-sidebar" class="w-2/12 bg-gray-800 p-4 border-r border-gray-700 flex flex-col overflow-y-auto"></div>
                    <div id="center-panel" class="w-7/12 p-8 flex flex-col overflow-y-auto bg-[#111827]">
                        <!-- Project title is outside editor-container and above the toolbar -->
                        <h3 id="project-main-title" class="text-3xl font-lora font-bold mb-4 text-white">${stripMarkdownAndHtml(project.title || 'Untitled Page')}</h3>
                        <div id="editor-container" class="flex-grow relative flex flex-col">
                           <div id="editor-toolbar"></div>
                           <div id="editor" class="flex-grow"></div>
                        </div>
                         <div id="cover-display-container" class="hidden flex-grow relative items-center justify-center"></div>
                         <div id="metadata-form-container" class="hidden flex-grow relative items-center justify-center p-4"></div>
                    </div>
                    <div id="right-sidebar" class="w-3/12 bg-gray-800 p-4 border-l border-gray-700 flex flex-col overflow-y-auto"></div>
                </div>
                 <!-- This footer is now local to this view -->
                <footer class="ui-bg p-4 border-t border-gray-700 flex-shrink-0 main-footer">
                    <div class="container mx-auto flex justify-between items-center">
                        <button id="add-chapter-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">+ New Chapter</button>
                        <button id="export-project-btn" class="accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Export Project</button>
                    </div>
                </footer>
            `;
            
            await setupEditorFunctionality(userId, projectId, project);
        }

        async function setupEditorFunctionality(userId, projectId, project) {
            console.log("setupEditorFunctionality: Setting up editor for project:", projectId);
            const projectMainTitle = document.getElementById('project-main-title');
            const leftSidebar = document.getElementById('left-sidebar');
            const rightSidebar = document.getElementById('right-sidebar');
            const editorContainer = document.getElementById('editor-container');
            const coverDisplayContainer = document.getElementById('cover-display-container');
            const metadataFormContainer = document.getElementById('metadata-form-container');

            let activeSectionId = 'brainstorming'; // Default to brainstorming
            let editor;
            let sections = [];

            // Helper to extract a clean title from HTML content (e.g., "<h1>Chapter 1. Title</h1>")
            function extractCleanTitle(htmlContent) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                const h1 = tempDiv.querySelector('h1');
                const h2 = tempDiv.querySelector('h2');
                const h3 = tempDiv.querySelector('h3');
                let title = '';

                if (h1 && h1.textContent.trim().length > 0) {
                    title = h1.textContent.trim();
                } else if (h2 && h2.textContent.trim().length > 0) {
                    title = h2.textContent.trim();
                } else if (h3 && h3.textContent.trim().length > 0) {
                    title = h3.textContent.trim();
                }

                // Remove common markdown prefixes and leading numbers for display
                title = title.replace(/^#+\s*/, ''); // Remove markdown H1, H2, H3
                title = title.replace(/^\d+\.\s*/, ''); // Remove "1. " or "2. "
                title = title.replace(/\*\*(.*?)\*\*/g, '$1'); // Remove bold markdown
                title = title.replace(/__(.*?)__/g, '$1'); // Remove bold markdown (underscore)
                title = title.replace(/\*(.*?)\*/g, '$1'); // Remove italic markdown
                title = title.replace(/_(.*?)_/g, '$1'); // Remove italic markdown (underscore)
                
                return title.trim() || 'Untitled';
            }


            const renderSidebar = () => {
                console.log("renderSidebar: Updating sidebar with project data.");
                getProject(userId, projectId).then(updatedProject => {
                    if (updatedProject) {
                        project.bookCoverUrl = updatedProject.bookCoverUrl;
                        project.title = updatedProject.title;
                        console.log("renderSidebar: Updated project data for sidebar:", project);
                    }

                    leftSidebar.innerHTML = `
                        <div class="flex flex-col items-center mb-4">
                            ${project.bookCoverUrl ? `<img src="${project.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/120x180/1F2937/D1D5DB?text=Cover';" class="w-30 h-45 object-cover rounded-md shadow-md mb-2" alt="Book Cover Thumbnail"/>` : `<img src="https://placehold.co/120x180/1F2937/D1D5DB?text=No+Cover" class="w-30 h-45 object-cover rounded-md shadow-md mb-2" alt="Placeholder Cover"/>`}
                        </div>
                        <nav id="project-sections" class="flex flex-col space-y-2 flex-grow overflow-y-auto">
                            ${sections.map(s => {
                                // Use the actual document title from Firestore, stripped of markdown
                                const displayTitle = extractCleanTitle(s.title); // Use new helper for display
                                return `<a href="#" data-section-id="${s.id}" class="section-link p-2 rounded-md hover:bg-gray-700 transition-colors ${s.id === activeSectionId ? 'bg-blue-600 text-white' : ''}">${displayTitle}</a>`;
                            }).join('')}
                        </nav>
                    `;
                    leftSidebar.querySelectorAll('.section-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            activeSectionId = e.target.dataset.sectionId;
                            loadSection(activeSectionId);
                        });
                    });
                });
            };

            // FIX: Event listener for footer buttons is now inside setupEditorFunctionality
            document.getElementById('add-chapter-btn').addEventListener('click', async () => {
                console.log("Add Chapter button clicked.");
                const chapterCount = sections.filter(s => s.id.startsWith('chapter_')).length;
                const success = await addChapter(userId, projectId, chapterCount + 1);
                if(success) {
                    sections = await getProjectSections(userId, projectId);
                    renderSidebar();
                    showNotification(`Chapter ${chapterCount + 1} added!`, 'success');
                }
            });

            // Export Project Functionality
            document.getElementById('export-project-btn').addEventListener('click', async () => {
                console.log("Export Project button clicked.");
                showNotification('Preparing manuscript for export...', 'info');
                try {
                    const allSections = await getProjectSections(userId, projectId);
                    let fullHtmlContent = '';

                    // Add a title to the exported document
                    fullHtmlContent += `<h1>${stripMarkdownAndHtml(project.title || 'Untitled Manuscript')}</h1>\n\n`;

                    for (const section of allSections) {
                        // Skip book_cover and metadata as they are not text content for export
                        if (section.id === 'book_cover' || section.id === 'metadata' || section.id === 'book_titles') continue; // Skip book_titles as it's for suggestions
                        console.log("Exporting section:", section.title);
                        // Handle front_matter and back_matter with page breaks
                        if (section.id === 'front_matter' || section.id === 'back_matter') {
                            fullHtmlContent += `<h2>${section.title}</h2>\n`;
                            const tempDiv = document.createElement('div');
                            const tempQuill = new Quill(tempDiv, { readOnly: true });
                            try {
                                tempQuill.setContents(JSON.parse(section.content));
                            } catch (e) {
                                tempQuill.setText(section.content || '');
                            }
                            fullHtmlContent += tempDiv.querySelector('.ql-editor').innerHTML + '\n\n';
                            fullHtmlContent += '<div style="page-break-after: always;">--- PAGE BREAK ---</div>\n\n'; // Add page break
                            continue;
                        }

                        // For other sections (chapters, etc.)
                        fullHtmlContent += `<h2>${section.title}</h2>\n`;
                        const tempDiv = document.createElement('div');
                        const tempQuill = new Quill(tempDiv, { readOnly: true });
                        try {
                            tempQuill.setContents(JSON.parse(section.content));
                            // Ensure the content starts at the top for export as well
                            tempDiv.querySelector('.ql-editor').style.paddingTop = '0';
                            tempDiv.querySelector('.ql-editor').style.marginTop = '0';
                        } catch (e) {
                            tempQuill.setText(section.content || '');
                        }
                        fullHtmlContent += tempDiv.querySelector('.ql-editor').innerHTML + '\n\n';
                    }

                    const blob = new Blob([fullHtmlContent], { type: 'text/html;charset=utf-8' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `${stripMarkdownAndHtml(project.title).replace(/\s+/g, '-') || 'untitled-manuscript'}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showNotification('Manuscript exported as HTML!', 'success');

                } catch (e) {
                    console.error("Export failed:", e);
                    showNotification(`Export failed: ${e.message}`, 'error');
                }
            });


            const renderAiPanel = (sectionId) => {
                console.log("renderAiPanel: Rendering AI panel for section:", sectionId);
                let aiPanelHtml = `
                    <h3 class="text-lg font-bold mb-4">AI Co-Author</h3>
                    <div class="space-y-4 flex-grow flex flex-col">
                        <div class="pb-4 border-b border-gray-700">
                            <p class="text-sm font-semibold mb-2">AI Style Preference</p>
                            <textarea id="ai-style-preference-input" class="w-full h-20 p-2 bg-gray-700 border border-gray-600 rounded-md text-sm" placeholder="e.g., Write in a formal, encouraging tone."></textarea>
                            <p class="text-xs text-gray-400 mt-1">Describe the tone or style you'd like the AI to use. For deeper style mimicry from your books, more advanced features are needed.</p>
                        </div>
                `;

                if (sectionId === 'brainstorming') {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Synopsis Ideas</p>
                            <textarea id="ai-idea-input" class="w-full h-24 p-2 bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" placeholder="e.g., A story about a family..."></textarea>
                            <button id="generate-synopsis-concepts-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate</button>
                        </div>
                        <div class="pt-4 border-t border-gray-700">
                            <p class="text-sm font-semibold mb-2">Brainstorming Tools</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="generate-pov-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">POV & Voice</button>
                                <button id="generate-structure-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Structural Template</button>
                            </div>
                        </div>`;
                } else if (sectionId === 'book_titles') { // NEW SECTION for book titles
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Book Titles</p>
                            <p class="text-xs text-gray-400 mb-2">Generate title suggestions based on your synopsis.</p>
                            <button id="generate-titles-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Titles</button>
                        </div>`;
                }
                else if (sectionId === 'character_development') {
                     aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Character Profiles</p>
                            <p class="text-xs text-gray-400 mb-2">Let the AI create character ideas based on your story's concept and title.</p>
                            <button id="generate-characters-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Characters</button>
                        </div>`;
                } else if (sectionId === 'world_building') {
                     aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate World Prompts</p>
                            <p class="text-xs text-gray-400 mb-2">Brainstorm elements for your story's universe.</p>
                            <button id="generate-world-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate World Ideas</button>
                        </div>`;
                }
                else if (sectionId === 'outline') {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Chapter Beats</p>
                            <p class="text-xs text-gray-400 mb-2">Let the AI create a detailed outline based on your project's foundation.</p>
                            <button id="generate-outline-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Outline</button>
                        </div>`;
                } else if (sectionId.startsWith('chapter_')) {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Drafting & Revising</p>
                            <div class="grid grid-cols-2 gap-2"> <!-- Two columns for drafting buttons -->
                                <button id="continue-writing-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Continue Writing</button> <!-- Renamed button -->
                                <button id="analyze-chapter-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Analyze Chapter</button>
                                <button id="proofread-chapter-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Proofread Chapter</button>
                            </div>
                        </div>`;
                } else if (sectionId === 'book_cover') {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Image Prompts</p> <!-- Renamed from Generate Cover Concepts -->
                            <p class="text-xs text-gray-400 mb-2">Generate descriptive prompts for an AI image generator based on your synopsis.</p>
                            <button id="generate-image-prompts-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Image Prompts</button>
                        </div>`;
                } else if (sectionId === 'front_matter') {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Front Matter</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="generate-dedication-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Dedication</button>
                                <button id="generate-acknowledgments-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Acknowledge</button>
                                <button id="generate-preface-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Preface</button>
                            </div>
                        </div>`;
                } else if (sectionId === 'back_matter') {
                    aiPanelHtml += `
                        <div>
                            <p class="text-sm font-semibold mb-2">Generate Back Matter</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="generate-blurb-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Blurb</button>
                                <button id="generate-author-bio-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Author Bio</button>
                                <button id="generate-discussion-questions-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Discussion Questions</button>
                            </div>
                        </div>`;
                } else if (sectionId === 'metadata') {
                    // No AI generation for metadata section, but still show style preference
                    aiPanelHtml += `<div class="p-4 text-gray-400 text-sm">No AI generation tools for Project Metadata. This section is for manual input.</div>`;
                }


                aiPanelHtml += `
                    <div class="pt-4 border-t border-gray-700 flex-shrink-0">
                        <p class="text-sm font-semibold mb-2">Editing & Faith Tools</p>
                        <div class="grid grid-cols-2 gap-2"> <!-- Two columns for editing buttons -->
                            <button id="suggest-alternatives-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Alternative Words</button> <!-- Renamed button -->
                            <button id="suggest-scripture-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Suggest Scripture</button>
                            <button id="suggest-youth-phrases-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Suggest Youth Phrases</button> <!-- Enabled and ready for logic -->
                        </div>
                    </div>
                    <div id="ai-output" class="mt-4 text-sm text-gray-300 space-y-2 flex-grow overflow-y-auto"></div>
                    </div>`;

                rightSidebar.innerHTML = aiPanelHtml;
                setupAiPanelListeners(sectionId);
            };
            
            // FIX: [v2] The header rendering function is now defined in the global scope
            function renderHeader(isLoggedIn, inEditor = false, userId = '') {
                let navLinksHtml = '';
                let userDisplay = '';
                if (isLoggedIn) {
                    userDisplay = `<span class="text-gray-400 text-sm">${userId.substring(0, 8)}...</span>`; // Display truncated user ID
                    navLinksHtml = `
                        <a href="#" id="help-link" class="accent-text-hover transition-colors text-sm">Help</a>
                        ${userDisplay}
                        <button id="sign-out-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md text-sm transition-colors">Logout</button>
                    `;
                }
                const dashboardLink = inEditor ? `<a href="#" data-route="dashboard" class="nav-button text-sm accent-text-hover flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Dashboard</a>` : '';

                const headerHtml = `
                    <header class="ui-bg p-4 border-b border-gray-700 flex-shrink-0">
                        <div class="container mx-auto flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                ${dashboardLink}
                                <h1 class="text-xl font-bold text-white">Author's Aid</h1>
                            </div>
                            <nav class="flex space-x-4 items-center">
                                ${navLinksHtml}
                            </nav>
                        </div>
                    </header>`;

                const headerElement = document.createElement('div');
                headerElement.innerHTML = headerHtml;

                const signOutBtn = headerElement.querySelector('#sign-out-btn');
                if (signOutBtn) {
                    signOutBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        await signOut();
                        navigateTo('landing');
                    });
                }
                // Add event listener for the Help link
                const helpLink = headerElement.querySelector('#help-link');
                if (helpLink) {
                    helpLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        renderHelpModal();
                    });
                }

                return headerElement;
            }


            const setupAiPanelListeners = (sectionId) => {
                console.log("setupAiPanelListeners: Setting up listeners for section:", sectionId);
                const outputDiv = document.getElementById('ai-output');

                // Helper function to show content in a modal and allow insertion
                const showContentInModal = (title, content, onAcceptCallback) => {
                    console.log("showContentInModal: Displaying modal for:", title);
                    showModal(title, `<div class="whitespace-pre-wrap text-gray-300 text-sm">${escapeHtml(content)}</div>`, async () => {
                        console.log("showContentInModal: 'Accept & Add to Editor' clicked.");
                        await onAcceptCallback(content);
                    }, 'Accept & Add to Editor');
                };

                // FIX: [v2] Use event delegation for dynamically created AI suggestion buttons
                outputDiv.addEventListener('click', async (e) => {
                    const target = e.target.closest('[data-content]');
                    if (target) {
                        e.preventDefault();
                        const content = target.dataset.content;
                        // Use the modal function to display and allow insertion
                        showContentInModal(`AI Suggestion`, content, (contentToInsert) => {
                            editor.insertText(editor.getLength(), '\n\n' + contentToInsert);
                            showNotification("Content added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    }
                });

                // Initialize AI Style Preference input and listener
                const aiStyleInput = document.getElementById('ai-style-preference-input');
                if (aiStyleInput) {
                    aiStyleInput.value = aiStylePreference; // Load saved preference
                    aiStyleInput.addEventListener('input', debounce(() => {
                        aiStylePreference = aiStyleInput.value; // Save preference on input
                        showNotification('AI style preference updated!', 'info', 1000);
                        console.log("AI style preference updated to:", aiStylePreference);
                    }, 500));
                }

                // FIX: [v2] Correctly check the sectionId for rendering the right AI tools
                if (sectionId === 'brainstorming') {
                    outputDiv.innerHTML = `<div class="p-4 text-gray-400 text-sm">Select a tool to get started.</div>`; // Clear any previous output

                    const ideaInput = document.getElementById('ai-idea-input');

                    document.getElementById('generate-synopsis-concepts-btn').addEventListener('click', async () => {
                        console.log("Generate Synopsis Ideas button clicked.");
                        const idea = editor.getText().trim() || ideaInput.value;
                        if (!idea) { showNotification("Please enter a basic idea in the editor or the text box.", "error"); return; }
                        console.log("Generating synopsis concepts for idea:", idea);
                        const conceptsText = await generateSynopsisIdeas(idea); // Renamed function call
                        outputDiv.innerHTML = ''; // Clear loading after response
                        // Use parseNumberedAiList to get clean suggestions, removing numbers
                        const concepts = parseNumberedAiList(conceptsText, false).map(c => stripMarkdownAndHtml(c.trim()));
                        console.log("Generated synopsis concepts:", concepts);

                        outputDiv.innerHTML = concepts.map((concept, index) => `<button data-content="${escapeHtml(concept)}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Concept ${index + 1}:</strong> ${escapeHtml(concept.substring(0, 80))}...</button>`).join('');
                    });

                    document.getElementById('generate-pov-btn').addEventListener('click', async () => {
                        console.log("Generate POV & Voice button clicked.");
                        const context = editor.getText().trim();
                        if (!context) { showNotification("Please write a synopsis in the editor first.", "error"); return; }
                        console.log("Generating POV suggestions for context:", context);
                        const povsText = await suggestPOVs(context);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        // Use parseNumberedAiList to get clean suggestions, removing numbers
                        const povs = parseNumberedAiList(povsText, false).map(p => stripMarkdownAndHtml(p.trim()));
                        console.log("Generated POV suggestions:", povs);

                        outputDiv.innerHTML = povs.map((pov, index) => `<button data-content="${escapeHtml(pov)}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Option ${index + 1}:</strong> ${escapeHtml(pov.substring(0, 80))}...</button>`).join('');
                    });

                     document.getElementById('generate-structure-btn').addEventListener('click', async () => {
                        console.log("Generate Structural Template button clicked.");
                        const context = editor.getText().trim();
                        if (!context) { showNotification("Please write a synopsis in the editor first.", "error"); return; }
                        console.log("Generating structural templates for context:", context);
                        const structuresText = await suggestStructures(context);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        // Use parseNumberedAiList to get clean suggestions, removing numbers
                        const structures = parseNumberedAiList(structuresText, false).map(s => stripMarkdownAndHtml(s.trim()));
                        console.log("Generated structural templates:", structures);

                        outputDiv.innerHTML = structures.map((structure, index) => `<button data-content="${escapeHtml(structure)}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Option ${index + 1}:</strong> ${escapeHtml(structure.substring(0, 80))}...</button>`).join('');
                    });

                } else if (sectionId === 'book_titles') { // NEW SECTION for book titles
                    document.getElementById('generate-titles-btn').addEventListener('click', async () => {
                        console.log("Generate Titles button clicked.");
                        const synopsisDoc = await getSection(currentUserId, projectId, 'brainstorming');
                        const context = synopsisDoc ? synopsisDoc.content.trim() : '';
                        if (!context) { showNotification("Please write your book's synopsis in the 'Synopsis & Brainstorming' section first to generate titles.", "error"); return; }
                        console.log("Generating titles for context:", context);

                        const titlesText = await generateTitles(context);
                        outputDiv.innerHTML = ''; // Clear loading after response

                        // Use parseNumberedAiList to get clean titles (without leading numbers in the content itself)
                        const titles = parseNumberedAiList(titlesText, false).map(t => stripMarkdownAndHtml(t.trim()));
                        console.log("Generated titles:", titles);

                        outputDiv.innerHTML = titles.map((cleanTitle, index) => {
                            // The `data-content` attribute will store the clean title text
                            // The visible text on the button will include "Title X: " for clarity in the list of suggestions.
                            return `<button data-content="${escapeHtml(cleanTitle)}" class="ai-title-suggestion-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Title ${index + 1}:</strong> ${escapeHtml(cleanTitle)}</button>`;
                        }).join('');
                    });
                }
                else if (sectionId === 'character_development') {
                    const generateBtn = document.getElementById('generate-characters-btn');
                    generateBtn.addEventListener('click', async () => {
                        console.log("Generate Character Profiles button clicked.");
                        const synopsisDoc = await getSection(currentUserId, projectId, 'brainstorming');
                        const projectData = await getProject(currentUserId, projectId); // Fetch project data for title
                        const context = `Synopsis: ${synopsisDoc ? synopsisDoc.content : ''}\nBook Title: ${projectData ? projectData.title : ''}`;
                        console.log("Generating characters for context:", context);
                        const charactersText = await generateCharacterProfiles(context);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        // Use parseNumberedAiList to get clean suggestions, removing numbers
                        const characters = parseNumberedAiList(charactersText, false).map(c => stripMarkdownAndHtml(c.trim()));
                        const fullCharactersText = characters.join('\n\n'); // Re-join for full display
                        console.log("Generated character profiles:", fullCharactersText);

                        showContentInModal('Generated Character Profiles', fullCharactersText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Character profiles added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                } else if (sectionId === 'world_building') {
                    const generateBtn = document.getElementById('generate-world-btn');
                    generateBtn.addEventListener('click', async () => {
                        console.log("Generate World Ideas button clicked.");
                        const synopsisDoc = await getSection(currentUserId, projectId, 'brainstorming');
                        const charDevDoc = await getSection(currentUserId, projectId, 'character_development');
                        const projectData = await getProject(currentUserId, projectId); // Fetch project data for title
                        const context = `Synopsis: ${synopsisDoc ? synopsisDoc.content : ''}\nBook Title: ${projectData ? projectData.title : ''}\nCharacter Development: ${charDevDoc ? charDevDoc.content : ''}`;
                        console.log("Generating world prompts for context:", context);
                        const worldText = await generateWorldPrompts(context);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        // Use parseNumberedAiList to get clean suggestions, removing numbers
                        const prompts = parseNumberedAiList(worldText, false).map(p => stripMarkdownAndHtml(p.trim()));
                        console.log("Generated world prompts:", prompts);

                        outputDiv.innerHTML = prompts.map((prompt, index) => `<button data-content="${escapeHtml(prompt)}" class="ai-suggestion-modal-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2"><strong>Idea ${index + 1}:</strong> ${escapeHtml(prompt.substring(0, 80))}...</button>`).join('');
                    });
                }
                else if (sectionId === 'outline') {
                    const generateBtn = document.getElementById('generate-outline-btn');
                     generateBtn.addEventListener('click', async () => {
                        console.log("Generate Outline button clicked.");
                        outputDiv.innerHTML = `<p>Gathering context and generating outline...</p>`; // Show loading
                        const synopsisDoc = await getSection(currentUserId, projectId, 'brainstorming');
                        const charDevDoc = await getSection(currentUserId, projectId, 'character_development');
                        const worldDoc = await getSection(currentUserId, projectId, 'world_building');
                        const projectData = await getProject(currentUserId, projectId); // Fetch project data for title
                        const context = `Synopsis: ${synopsisDoc ? synopsisDoc.content : ''}\nBook Title: ${projectData ? projectData.title : ''}\nCharacter Development: ${charDevDoc ? charDevDoc.content : ''}\nWorld-building: ${worldDoc ? worldDoc.content : ''}`;
                        console.log("Generating outline for context:", context);
                        const outline = await generateOutlineBeats(context, projectData.title); // Pass bookTitle
                        outputDiv.innerHTML = ''; // Clear loading after response
                        console.log("Generated outline:", outline);
                        showContentInModal('Generated Outline', outline, (content) => {
                            editor.setText(content);
                            showNotification("Outline added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                } else if (sectionId.startsWith('chapter_')) {
                    const continueWritingBtn = document.getElementById('continue-writing-btn'); // Renamed button
                    const analyzeChapterBtn = document.getElementById('analyze-chapter-btn');
                    const proofreadBtn = document.getElementById('proofread-chapter-btn');
                    const suggestYouthPhrasesBtn = document.getElementById('suggest-youth-phrases-btn'); // Get the new button
                    const suggestAlternativesBtn = document.getElementById('suggest-alternatives-btn'); // Get the alternative words button
                    const suggestScriptureBtn = document.getElementById('suggest-scripture-btn'); // Get the scripture button

                    continueWritingBtn.addEventListener('click', async () => { // Event listener for renamed button
                        console.log("Continue Writing button clicked.");
                        const currentText = editor.getText();
                        const projectData = await getProject(currentUserId, projectId); // Fetch project data for title
                        const outlineDoc = await getSection(currentUserId, projectId, 'outline'); // Fetch the outline
                        
                        // FIX: [v2] Get the current chapter title from the sections data
                        const currentChapterTitle = sections.find(s => s.id === sectionId)?.title || 'Untitled Chapter';

                        const projectTitle = projectData ? projectData.title : 'Untitled Book';
                        const outlineContent = outlineDoc ? outlineDoc.content : 'No outline provided.';
                        
                        // FIX: [v2] Check if the chapter content is mostly just the placeholder title
                        if (currentText.trim().length <= currentChapterTitle.length + 5 && currentText.includes(currentChapterTitle)) {
                            // The chapter is effectively empty. Proceed with the first beat.
                            console.log("Chapter is empty. Generating from first beat.");
                        }
                        
                        console.log("Generating next section for current text:", currentText, "with project title:", projectTitle, "and outline:", outlineContent, "for chapter:", currentChapterTitle);
                        // FIX: [v2] Pass the current chapter title to the AI
                        const suggestion = await generateNext(currentText, projectTitle, outlineContent, currentChapterTitle);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        console.log("Generated next section:", suggestion);
                        showContentInModal('Generated Next Section', suggestion, (content) => {
                            editor.insertText(editor.getLength(), ' ' + content);
                            showNotification("Text added!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }
                const analyzeChapterBtn = document.getElementById('analyze-chapter-btn');
                if (analyzeChapterBtn) {
                    analyzeChapterBtn.addEventListener('click', async () => {
                        console.log("Analyze Chapter button clicked.");
                        const chapterText = editor.getText();
                        const synopsisDoc = await getSection(currentUserId, projectId, 'brainstorming');
                        const charDevDoc = await getSection(currentUserId, projectId, 'character_development');
                        const outlineDoc = await getSection(currentUserId, projectId, 'outline');
                        const projectData = await getProject(currentUserId, projectId);

                        const context = `Synopsis: ${synopsisDoc ? synopsisDoc.content : ''}\n` +
                                        `Book Title: ${projectData ? projectData.title : ''}\n` +
                                        `Character Development: ${charDevDoc ? charDevDoc.content : ''}\n` +
                                        `Outline: ${outlineDoc ? outlineDoc.content : ''}`;
                        console.log("Analyzing chapter with context:", context);
                        const analysis = await analyzeChapter(chapterText, context);
                        console.log("Chapter analysis:", analysis);
                        outputDiv.innerHTML = `<div class="whitespace-pre-wrap p-2 bg-gray-900 rounded-md">${analysis}</div>`;
                    });
                }
                const proofreadBtn = document.getElementById('proofread-chapter-btn');
                if (proofreadBtn) {
                    proofreadBtn.addEventListener('click', async () => {
                        console.log("Proofread Chapter button clicked.");
                        const chapterText = editor.getText();
                        console.log("Proofreading text:", chapterText);
                        const suggestionsText = await proofreadChapter(chapterText);
                        const suggestions = parseNumberedAiList(suggestionsText, true).map(s => stripMarkdownAndHtml(s.trim())); // Keep numbers for display
                        console.log("Proofreading suggestions:", suggestions);

                        if (suggestions.length > 0) {
                            outputDiv.innerHTML = `
                                <p class="mb-2">Click a suggestion to apply it:</p>
                                ${suggestions.map((suggestion, index) => {
                                    // Re-extract original and proposed from the cleaned string if needed, or adjust AI prompt
                                    const match = suggestion.match(/Original:\s*(.*?)\s*Proposed:\s*(.*)/is);
                                    let originalDisplay = suggestion;
                                    let proposedDisplay = suggestion;
                                    if (match && match[1] && match[2]) {
                                        originalDisplay = match[1].trim();
                                        proposedDisplay = match[2].trim();
                                    }
                                    return `
                                    <button data-original="${escapeHtml(originalDisplay)}" data-proposed="${escapeHtml(proposedDisplay)}"
                                            class="ai-proofread-suggestion-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2 text-sm">
                                        <strong>Suggestion ${index + 1}:</strong> <span class="line-through text-red-300">${escapeHtml(originalDisplay)}</span> → <span class="text-green-300">${escapeHtml(proposedDisplay)}</span>
                                    </button>
                                `;}).join('')}
                            `;
                        } else {
                            outputDiv.innerHTML = `<p>No proofreading suggestions found or text is already perfect!</p>`;
                        }
                    });
                }

                // Front Matter and Back Matter button listeners
                const generateDedicationBtn = document.getElementById('generate-dedication-btn');
                if (generateDedicationBtn) {
                    generateDedicationBtn.addEventListener('click', async () => {
                        console.log("Generate Dedication button clicked.");
                        const metadataDoc = await getSection(currentUserId, projectId, 'metadata');
                        const metadata = metadataDoc ? JSON.parse(metadataDoc.content) : {};
                        const projectData = await getProject(currentUserId, projectId);
                        const prompt = `Generate a dedication for a Christian book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}". Author: ${metadata.authorName || 'Rene\' Stanley'}. Make it heartfelt and concise, reflecting Christian values.`;
                        console.log("Generating dedication with prompt:", prompt);
                        const dedicationText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        console.log("Generated dedication:", dedicationText);
                        showContentInModal('Generated Dedication', dedicationText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Dedication added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }

                const generateAcknowledgmentsBtn = document.getElementById('generate-acknowledgments-btn');
                if (generateAcknowledgmentsBtn) {
                    generateAcknowledgmentsBtn.addEventListener('click', async () => {
                        console.log("Generate Acknowledgments button clicked.");
                        const metadataDoc = await getSection(currentUserId, projectId, 'metadata');
                        const metadata = metadataDoc ? JSON.parse(metadataDoc.content) : {};
                        const projectData = await getProject(currentUserId, projectId);
                        const prompt = `Generate an acknowledgments section for a Christian book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}". Author: ${metadata.authorName || 'Rene\' Stanley'}. Include thanks to family, friends, and inspiration, with a focus on gratitude and faith.`;
                        console.log("Generating acknowledgments with prompt:", prompt);
                        const acknowledgmentsText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        console.log("Generated acknowledgments:", acknowledgmentsText);
                        // Removed the prepended phrase from the content before showing in modal
                        const cleanedAcknowledgmentsText = acknowledgmentsText.replace(/Here's an acknowledgments section for Rene' Stanley's "When God Writes My Story: Finding Peace in the Waiting," tailored for a Christian Romance genre, focusing on gratitude and faith:\n---\n\n## Acknowledgments/, '## Acknowledgments');
                        showContentInModal('Generated Acknowledgments', cleanedAcknowledgmentsText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Acknowledgments added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }

                const generatePrefaceBtn = document.getElementById('generate-preface-btn');
                if (generatePrefaceBtn) {
                    generatePrefaceBtn.addEventListener('click', async () => {
                        console.log("Generate Preface button clicked.");
                        const synopsisDoc = await getSection(currentUserId, projectId, 'brainstorming');
                        const metadataDoc = await getSection(currentUserId, projectId, 'metadata');
                        const metadata = metadataDoc ? JSON.parse(metadataDoc.content) : {};
                        const projectData = await getProject(currentUserId, projectId);
                        const prompt = `Generate a preface for a Christian book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}". Author: ${metadata.authorName || 'Rene\' Stanley'}. Briefly introduce the book's purpose or inspiration from a Christian perspective. Synopsis: ${synopsisDoc ? synopsisDoc.content : ''}`;
                        console.log("Generating preface with prompt:", prompt);
                        const prefaceText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        console.log("Generated preface:", prefaceText);
                        showContentInModal('Generated Preface', prefaceText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Preface added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }

                const generateBlurbBtn = document.getElementById('generate-blurb-btn');
                if (generateBlurbBtn) {
                    generateBlurbBtn.addEventListener('click', async () => {
                        console.log("Generate Blurb button clicked.");
                        const synopsisDoc = await getSection(currentUserId, projectId, 'brainstorming');
                        const metadataDoc = await getSection(currentUserId, projectId, 'metadata');
                        const metadata = metadataDoc ? JSON.parse(metadataDoc.content) : {};
                        const projectData = await getProject(currentUserId, projectId);
                        const prompt = `Generate a compelling back cover blurb (2-3 paragraphs) for a Christian book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}" targeting "${projectData.targetAudience}". Author: ${metadata.authorName || 'Rene\' Stanley'}. Focus on hooks and intrigue, incorporating Christian themes. Synopsis: ${synopsisDoc ? synopsisDoc.content : ''}`;
                        console.log("Generating blurb with prompt:", prompt);
                        const blurbText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        console.log("Generated blurb:", blurbText);
                        showContentInModal('Generated Blurb', blurbText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Blurb added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }

                const generateAuthorBioBtn = document.getElementById('generate-author-bio-btn');
                if (generateAuthorBioBtn) {
                    generateAuthorBioBtn.addEventListener('click', async () => {
                        console.log("Generate Author Bio button clicked.");
                        const metadataDoc = await getSection(currentUserId, projectId, 'metadata');
                        const metadata = metadataDoc ? JSON.parse(metadataDoc.content) : {};
                        const projectData = await getProject(currentUserId, projectId);
                        const prompt = `Generate a concise (1-2 paragraph) author biography for ${metadata.authorName || 'Rene\' Stanley'}, author of a Christian book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}". Highlight key experiences like being born in Washington D.C., teenage years in Maryland, finding solace in thoughts and observations, interest in older adults' wisdom, and military service in Desert Storm. Emphasize their Christian faith journey and how it influences their writing.`;
                        console.log("Generating author bio with prompt:", prompt);
                        const authorBioText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        console.log("Generated author bio:", authorBioText);
                        showContentInModal('Generated Author Biography', authorBioText, (content) => {
                            editor.insertText(editor.getLength(), '\n\n' + content);
                            showNotification("Author biography added to editor!", "success");
                            outputDiv.innerHTML = '';
                        });
                    });
                }

                const generateDiscussionQuestionsBtn = document.getElementById('generate-discussion-questions-btn');
                if (generateDiscussionQuestionsBtn) {
                    generateDiscussionQuestionsBtn.addEventListener('click', async () => {
                        console.log("Generate Discussion Questions button clicked.");
                        const synopsisDoc = await getSection(currentUserId, projectId, 'brainstorming');
                        const projectData = await getProject(currentUserId, projectId);
                        const prompt = `Generate 5 thought-provoking discussion questions for a book club based on the Christian book titled "${stripMarkdownAndHtml(projectData.title || 'Untitled Book')}" of genre "${projectData.genre}". The questions should directly relate to the book's themes, characters, and spiritual insights. Provide ONLY the numbered questions, without any introductory sentence or bolding for individual questions.`;
                        console.log("Generating discussion questions with prompt:", prompt);
                        const questionsText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                        outputDiv.innerHTML = ''; // Clear loading after response
                        const questions = parseNumberedAiList(questionsText, true).map(q => stripMarkdownAndHtml(q.trim())); // Keep numbers for display
                        console.log("Generated discussion questions (parsed):", questions);

                        if (questions.length > 0) {
                            // Join questions into a single block with a relevant intro
                            const fullContent = `Here are some discussion questions for your book club, based on "${stripMarkdownAndHtml(projectData.title || 'Your Book')}":\n\n` + questions.join('\n\n');
                            console.log("Full discussion questions content for modal:", fullContent);

                            showContentInModal('Generated Discussion Questions', fullContent, (content) => {
                                editor.insertText(editor.getLength(), '\n\n' + content);
                                showNotification("Discussion questions added to editor!", "success");
                                outputDiv.innerHTML = '';
                                console.log("Discussion questions added to editor.");
                            });
                        } else {
                            outputDiv.innerHTML = `<p>No discussion questions found.</p>`;
                            console.log("No discussion questions found.");
                        }
                    });
                }
            };

            const loadSection = async (sectionId) => {
                console.log("loadSection: Loading section:", sectionId);
                const sectionData = await getSection(currentUserId, projectId, sectionId);
                // The project's main title will now always be displayed by projectMainTitle element.
                if (projectMainTitle) {
                    projectMainTitle.textContent = stripMarkdownAndHtml(project.title || 'Untitled Page');
                }

                activeSectionId = sectionId;

                // Hide all content containers initially
                editorContainer.classList.add('hidden');
                coverDisplayContainer.classList.add('hidden');
                metadataFormContainer.classList.add('hidden');
                
                // Show/Hide the footer based on if we are in a chapter section or not
                const footer = document.querySelector('.main-footer');
                if (sectionId.startsWith('chapter_') || sectionId === 'front_matter' || sectionId === 'back_matter') {
                     if (footer) footer.classList.remove('hidden');
                } else {
                     if (footer) footer.classList.add('hidden');
                }

                if (sectionId === 'book_cover') {
                    console.log("loadSection: Displaying book_cover section.");
                    coverDisplayContainer.classList.remove('hidden');
                    // Display previously saved cover if available
                    const projectData = await getProject(currentUserId, projectId);
                    if (projectData && projectData.bookCoverUrl) {
                        console.log("loadSection: Existing book cover found:", projectData.bookCoverUrl);
                        coverDisplayContainer.innerHTML = `
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 p-4">
                                <div class="cover-image-wrapper selected" data-image-url="${escapeHtml(projectData.bookCoverUrl)}">
                                    <img src="${projectData.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/400x600/FF0000/FFFFFF?text=Image+Load+Error';" class="w-full h-auto rounded-lg shadow-lg" alt="Selected Book Cover"/>
                                    <div class="cover-selection-overlay"><i class="fas fa-check-circle"></i> Selected</div>
                                </div>
                                <div class="cover-image-wrapper" data-image-url="https://placehold.co/400x600/111827/FFFFFF?text=More+Options+Coming">
                                    <img src="https://placehold.co/400x600/111827/FFFFFF?text=More+Options+Coming" class="w-full h-auto rounded-lg" alt="Placeholder for more options"/>
                                    <div class="cover-selection-overlay"><i class="fas fa-check-circle"></i> Selected</div>
                                </div>
                                <div class="cover-image-wrapper" data-image-url="https://placehold.co/400x600/374151/FFFFFF?text=More+Options+Coming">
                                    <img src="https://placehold.co/400x600/374151/FFFFFF?w-full h-auto rounded-lg" alt="Placeholder for more options"/>
                                    <div class="cover-selection-overlay"><i class="fas fa-check-circle"></i> Selected</div>
                                </div>
                            </div>
                        `;
                    } else {
                        console.log("loadSection: No existing book cover found.");
                        coverDisplayContainer.innerHTML = `<div class="text-center text-gray-400">Your generated book cover will appear here.</div>`;
                    }
                } else if (sectionId === 'metadata') {
                    console.log("loadSection: Displaying metadata section.");
                    metadataFormContainer.classList.remove('hidden');
                    let metadata = {};
                    try {
                        metadata = JSON.parse(sectionData.content);
                    } catch (e) {
                        console.error("Error parsing metadata content:", e);
                        // Fallback to empty object if content is not valid JSON
                        metadata = {};
                    }
                    console.log("loadSection: Metadata loaded:", metadata);

                    metadataFormContainer.innerHTML = `
                        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 w-full max-w-md">
                            <h3 class="text-xl font-lora font-bold mb-4 text-primary">Project Metadata</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="meta-author-name" class="block text-sm font-medium text-gray-300 mb-1">Author Name</label>
                                    <input type="text" id="meta-author-name" name="authorName" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${escapeHtml(metadata.authorName || '')}">
                                </div>
                                <div>
                                    <label for="meta-copyright-year" class="block text-sm font-medium text-gray-300 mb-1">Copyright Year</label>
                                    <input type="number" id="meta-copyright-year" name="copyrightYear" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${metadata.copyrightYear || new Date().getFullYear()}">
                                </div>
                                <div>
                                    <label for="meta-publisher" class="block text-sm font-medium text-gray-300 mb-1">Publisher</label>
                                    <input type="text" id="meta-publisher" name="publisher" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${escapeHtml(metadata.publisher || '')}">
                                </div>
                                <div>
                                    <label for="meta-isbn" class="block text-sm font-medium text-gray-300 mb-1">ISBN (Optional)</label>
                                    <input type="text" id="meta-isbn" name="isbn" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${escapeHtml(metadata.isbn || '')}">
                                </div>
                                <div>
                                    <label for="meta-series-name" class="block text-sm font-medium text-gray-300 mb-1">Series Name (Optional)</label>
                                    <input type="text" id="meta-series-name" name="seriesName" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${escapeHtml(metadata.seriesName || '')}">
                                </div>
                                <div>
                                    <label for="meta-series-number" class="block text-sm font-medium text-gray-300 mb-1">Series Number (Optional)</label>
                                    <input type="number" id="meta-series-number" name="seriesNumber" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${metadata.seriesNumber || ''}">
                                </div>
                                <div>
                                    <label for="meta-lccn" class="block text-sm font-medium text-gray-300 mb-1">Library of Congress Control Number (LCCN)</label>
                                    <input type="text" id="meta-lccn" name="lccn" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring" value="${escapeHtml(metadata.lccn || '')}">
                                </div>
                                <button id="save-metadata-btn" class="w-full mt-4 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Save Metadata</button>
                            </div>
                        </div>
                    `;

                    document.getElementById('save-metadata-btn').addEventListener('click', async () => {
                        console.log("Save Metadata button clicked.");
                        const newMetadata = {
                            authorName: document.getElementById('meta-author-name').value,
                            copyrightYear: parseInt(document.getElementById('meta-copyright-year').value) || null,
                            publisher: document.getElementById('meta-publisher').value,
                            isbn: document.getElementById('meta-isbn').value,
                            seriesName: document.getElementById('meta-series-name').value,
                            seriesNumber: parseInt(document.getElementById('meta-series-number').value) || null,
                            lccn: document.getElementById('meta-lccn').value, // Save LCCN
                        };
                        console.log("Updating project metadata with:", newMetadata);
                        await updateProjectMetadata(currentUserId, projectId, newMetadata);
                    });

                } else {
                    console.log("loadSection: Displaying Quill editor for section:", sectionId);
                    editorContainer.classList.remove('hidden');
                    if (!editor) {
                        console.log("loadSection: Initializing new Quill editor.");
                        const toolbarOptions = [['bold', 'italic', 'underline'], [{ 'header': 1 }, { 'header': 2 }], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']];
                        // Initialize Quill with the toolbar and editor container
                        editor = new Quill('#editor', {
                            modules: { toolbar: '#editor-toolbar' }, // Link toolbar to its ID
                            theme: 'snow'
                        });
                        // FIX: [v2] Add selection-change listener to update currentSelectionRange
                        editor.on('selection-change', (range) => {
                            currentSelectionRange = range;
                            console.log("Quill selection changed:", currentSelectionRange);
                        });
                        editor.on('text-change', debounce(async () => {
                            const content = JSON.stringify(editor.getContents());
                            console.log("Quill text change detected. Saving content for section:", activeSectionId);
                            await updateSectionContent(currentUserId, projectId, activeSectionId, content);
                            showNotification('Progress Saved', 'success', 1500);
                        }, 1500));
                    }
                    
                    // FIX: [v2] Check if chapter content is empty and add a placeholder title.
                    if (sectionId.startsWith('chapter_') && sectionData.content.trim() === '{"ops":[{"insert":"\\n"}]}') {
                        const chapterTitle = sections.find(s => s.id === sectionId)?.title;
                        const placeholderTitle = `<h2>${chapterTitle || 'Untitled Chapter'}</h2>`;
                        editor.setContents(editor.clipboard.convert(placeholderTitle));
                    } else {
                        try {
                            console.log("Setting Quill editor content for section:", sectionId, "Content:", sectionData.content);
                            editor.setContents(JSON.parse(sectionData.content));
                        } catch(e) {
                            console.warn("Failed to parse JSON content for section", sectionId, ". Setting as plain text.", e);
                            editor.setText(sectionData.content || '');
                        }
                    }
                }

                renderSidebar();
                renderAiPanel(sectionId);
            };

            // Helper function to extract a clean title from HTML content for sidebar display
            function extractCleanTitleForSidebar(htmlContent) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                let title = '';

                // Prioritize H1, then H2, then H3
                const h1 = tempDiv.querySelector('h1');
                const h2 = tempDiv.querySelector('h2');
                const h3 = tempDiv.querySelector('h3');

                if (h1 && h1.textContent.trim().length > 0) {
                    title = h1.textContent.trim();
                } else if (h2 && h2.textContent.trim().length > 0) {
                    title = h2.textContent.trim();
                } else if (h3 && h3.textContent.trim().length > 0) {
                    title = h3.textContent.trim();
                }

                // Remove common markdown prefixes and leading numbers for display
                title = title.replace(/^#+\s*/, ''); // Remove markdown H1, H2, H3
                title = title.replace(/^\d+\.\s*/, ''); // Remove "1. " or "2. "
                title = title.replace(/\*\*(.*?)\*\*/g, '$1'); // Remove bold markdown
                title = title.replace(/__(.*?)__/g, '$1'); // Remove bold markdown (underscore)
                title = title.replace(/\*(.*?)\*/g, '$1'); // Remove italic markdown
                title = title.replace(/_(.*?)_/g, '$1'); // Remove italic markdown (underscore)
                
                return title.trim() || 'Untitled';
            }

            sections = await getProjectSections(currentUserId, projectId);
            console.log("setupEditorFunctionality: Fetched project sections:", sections);
            await loadSection(activeSectionId);
        }
        
        // FIX: [v2] The header rendering function is now defined in the global scope
        function renderHeader(isLoggedIn, inEditor = false, userId = '') {
            let navLinksHtml = '';
            let userDisplay = '';
            if (isLoggedIn) {
                userDisplay = `<span class="text-gray-400 text-sm">${userId.substring(0, 8)}...</span>`; // Display truncated user ID
                navLinksHtml = `
                    <a href="#" id="help-link" class="accent-text-hover transition-colors text-sm">Help</a>
                    ${userDisplay}
                    <button id="sign-out-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md text-sm transition-colors">Logout</button>
                `;
            }
            const dashboardLink = inEditor ? `<a href="#" data-route="dashboard" class="nav-button text-sm accent-text-hover flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Dashboard</a>` : '';

            const headerHtml = `
                <header class="ui-bg p-4 border-b border-gray-700 flex-shrink-0">
                    <div class="container mx-auto flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            ${dashboardLink}
                            <h1 class="text-xl font-bold text-white">Author's Aid</h1>
                        </div>
                        <nav class="flex space-x-4 items-center">
                            ${navLinksHtml}
                        </nav>
                    </div>
                </header>`;

            const headerElement = document.createElement('div');
            headerElement.innerHTML = headerHtml;

            const signOutBtn = headerElement.querySelector('#sign-out-btn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await signOut();
                    navigateTo('landing');
                });
            }
            // Add event listener for the Help link
            const helpLink = headerElement.querySelector('#help-link');
            if (helpLink) {
                helpLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderHelpModal();
                });
            }

            return headerElement;
        }

        //======================================================================
        // --- MAIN APPLICATION LOGIC ---
        //======================================================================

        // FIX: [v2] Consolidated two user ID variables into one for consistency
        // let mainCurrentUserId = null;

        function navigateTo(viewName, data = {}) {
            console.log("navigateTo: Navigating to view:", viewName, "with data:", data);
            appContainer.innerHTML = ''; // Clear existing content
            // Ensure body overflow is managed correctly based on view
            document.body.style.overflow = (viewName === 'landing' || viewName === 'dashboard') ? 'auto' : 'hidden';

            // Control visibility of theme switcher
            const themeSwitcher = document.getElementById('theme-switcher');
            if (themeSwitcher) {
                themeSwitcher.style.display = (viewName === 'landing' || viewName === 'dashboard') ? 'block' : 'none';
                console.log("Theme switcher display set to:", themeSwitcher.style.display);
            }

            if (viewName === 'editor' && data.projectId) {
                document.location.hash = `editor/${data.projectId}`;
            } else if (viewName === 'dashboard') {
                document.location.hash = 'dashboard';
            } else {
                document.location.hash = '';
            }
            console.log("Current hash set to:", document.location.hash);

            switch (viewName) {
                case 'landing': renderLandingPage(); break;
                // FIX: [v2] Use single `currentUserId` variable
                case 'dashboard': if (currentUserId) renderDashboard(currentUserId); break;
                case 'editor': if (currentUserId && data.projectId) renderEditor(currentUserId, data.projectId); break;
                // FIX: [v2] Use single `currentUserId` variable
                default: if(currentUserId) renderDashboard(currentUserId); else renderLandingPage();
            }
        }

        // --- App Startup ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded: Application starting up.");
            const auth = initializeAuth(firebaseConfig);
            initializeDb(firebaseConfig);
            console.log("Firebase Auth and Firestore initialized.");

            function handleThemeSwitching() {
                function applyTheme(themeName) {
                    console.log("Applying theme:", themeName);
                    document.documentElement.className = '';
                    document.documentElement.classList.add(themeName);
                    document.querySelectorAll('.theme-button').forEach(btn => {
                        btn.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-gray-900', 'ring-white');
                        if (btn.dataset.theme === themeName) btn.classList.add('ring-2', 'ring-offset-2', 'ring-offset-gray-900', 'ring-white');
                    });
                    currentTheme = themeName; // Update global theme tracker
                    // Re-render dashboard to apply new border colors
                    // FIX: [v2] Use single `currentUserId` variable
                    if (document.location.hash === '#dashboard' && currentUserId) {
                        console.log("Re-rendering dashboard due to theme change.");
                        renderDashboard(currentUserId);
                    }
                }
                document.body.addEventListener('click', (event) => {
                    if (event.target.matches('.theme-button')) {
                        applyTheme(event.target.dataset.theme);
                    }
                });
            }
            handleThemeSwitching();

            onAuth(async (user) => {
                console.log("onAuth: Auth state changed. User:", user);
                if (user) {
                    // FIX: [v2] Use single `currentUserId` variable
                    currentUserId = user.uid;
                    console.log("User is logged in. UID:", currentUserId);

                    // Check if the user is anonymous and display a prompt to link account
                    if (user.isAnonymous) {
                        showNotification('You are signed in as a guest. Your data may be lost if you clear browser data. Consider signing up to save your work permanently!', 'info', 7000);
                        console.log("User is anonymous. Showing notification.");
                    }

                    const hash = document.location.hash;
                    if (hash.startsWith('#editor/')) {
                        const projectId = hash.split('/')[1];
                        navigateTo('editor', { projectId });
                    } else {
                        navigateTo('dashboard');
                    }
                } else {
                    // FIX: [v2] Use single `currentUserId` variable
                    currentUserId = null;
                    console.log("User is logged out. Navigating to landing page.");
                    navigateTo('landing');
                }
            });

            document.body.addEventListener('click', (event) => {
                const target = event.target.closest('.nav-button, [data-route]');
                if (target) {
                    event.preventDefault();
                    const view = target.dataset.route;
                    const projectId = target.dataset.id;
                    console.log("Navigation button clicked. View:", view, "ProjectId:", projectId);
                    navigateTo(view, { projectId });
                }
            });
        });
    </script>
</body>
</html>
