<!DOCTYPE html>
<html lang="en" class="theme-default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Author's Aid | Your AI Co-author for Christian Literature</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
    <!-- Font Awesome for eye icon and loading spinner -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            display: flex;
            flex-direction: column;
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #D1D5DB; 
        }
        #app-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        #app-main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow this container to scroll */
        }

        .font-lora { font-family: 'Lora', serif; }

        /* --- THEME DEFINITIONS --- */
        .theme-default .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(59, 130, 246, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(139, 92, 246, 0.08), transparent 60%); }
        .theme-default .accent-bg { background-color: #2563eb; }
        .theme-default .accent-bg-hover:hover { background-color: #1d4ed8; }
        .theme-default .accent-text { color: #60a5fa; }
        .theme-default .accent-text-hover:hover { color: #3b82f6; }
        .theme-default .accent-ring:focus { ring-color: #3b82f6; }
        .theme-default .ui-bg { background-color: #1f2937; }

        .theme-red .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(220, 38, 38, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(159, 18, 57, 0.1), transparent 60%); }
        .theme-red .accent-bg { background-color: #dc2626; }
        .theme-red .accent-bg-hover:hover { background-color: #b91c1c; }
        .theme-red .accent-text { color: #f87171; }
        .theme-red .accent-text-hover:hover { color: #ef4444; }
        .theme-red .accent-ring:focus { ring-color: #ef4444; }
        .theme-red .ui-bg { background-color: #261717; }


        .theme-gold .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(252, 211, 77, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(245, 158, 11, 0.1), transparent 60%); }
        .theme-gold .accent-bg { background-color: #f59e0b; }
        .theme-gold .accent-bg-hover:hover { background-color: #d97706; }
        .theme-gold .accent-text { color: #fcd34d; }
        .theme-gold .accent-text-hover:hover { color: #fbbf24; }
        .theme-gold .accent-ring:focus { ring-color: #fbbf24; }
        .theme-gold .ui-bg { background-color: #292211; }

        .theme-green .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(16, 185, 129, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(5, 150, 105, 0.1), transparent 60%); }
        .theme-green .accent-bg { background-color: #059669; }
        .theme-green .accent-bg-hover:hover { background-color: #047857; }
        .theme-green .accent-text { color: #34d399; }
        .theme-green .accent-text-hover:hover { color: #10b981; }
        .theme-green .accent-ring:focus { ring-color: #10b981; }
        .theme-green .ui-bg { background-color: #132a23; }

        .theme-purple .gradient-bg { background-color: #000000; background-image: radial-gradient(circle at top right, rgba(139, 92, 246, 0.1), transparent 50%), radial-gradient(circle at bottom left, rgba(124, 58, 237, 0.1), transparent 60%); }
        .theme-purple .accent-bg { background-color: #7c3aed; }
        .theme-purple .accent-bg-hover:hover { background-color: #6d28d9; }
        .theme-purple .accent-text { color: #a78bfa; }
        .theme-purple .accent-text-hover:hover { color: #8b5cf6; }
        .theme-purple .accent-ring:focus { ring-color: #8b5cf6; }
        .theme-purple .ui-bg { background-color: #241c33; }

        /* Quill Editor specific styles */
        .ql-container { border: none !important; display: flex; flex-direction: column; height: 100%; }
        .ql-editor {
            flex-grow: 1;
            font-family: 'Lora', serif;
            font-size: 1.125rem;
            line-height: 1.75;
            background-color: #111827;
            color: #D1D5DB !important;
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto;
            padding-top: 0 !important; 
            padding-bottom: 1rem; 
        }
        .ql-editor p:first-child,
        .ql-editor h1:first-child,
        .ql-editor h2:first-child,
        .ql-editor h3:first-child,
        .ql-editor ol:first-child,
        .ql-editor ul:first-child {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        .ql-toolbar {
            background-color: #1F2937 !important;
            border-top-left-radius: 8px !important;
            border-top-right-radius: 8px !important;
            border: 1px solid #374151 !important;
            border-bottom: none !important;
        }
        .ql-snow .ql-stroke { stroke: #9CA3AF !important; }
        .ql-snow .ql-picker-label { color: #9CA3AF !important; }
        .ql-snow .ql-picker-options { background-color: #374151 !important; color: #D1D5DB !important; }

        /* Custom scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1F2937; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }

        /* Styles for password toggle */
        .password-input-container {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9CA3AF;
        }

        /* Book Cover Selection Styles */
        .cover-image-wrapper {
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .cover-image-wrapper:hover {
            border-color: #60a5fa;
        }
        .cover-image-wrapper.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        .cover-image-wrapper img {
            display: block;
        }
        .cover-selection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .cover-image-wrapper.selected .cover-selection-overlay {
            opacity: 1;
        }

        /* Loading spinner for buttons */
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 1em;
            height: 1em;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5em;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom style for dashboard card border based on theme */
        .project-card.theme-border-default { border-color: #2563eb; }
        .project-card.theme-border-red { border-color: #dc2626; }
        .project-card.theme-border-gold { border-color: #f59e0b; }
        .project-card.theme-border-green { border-color: #059669; }
        .project-card.theme-border-purple { border-color: #7c3aed; }

        textarea::placeholder, input::placeholder {
            color: #6B7280;
        }
        
        .suggestion-item {
            background-color: #374151;
            border-left: 3px solid #60a5fa;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .suggestion-item:hover {
            background-color: #4B5563;
        }
        .suggestion-original {
            text-decoration: line-through;
            color: #9CA3AF;
            font-size: 0.8rem;
            word-break: break-word; /* Ensure long text wraps */
        }
        .suggestion-replacement {
            color: #F3F4F6;
            font-weight: 500;
            word-break: break-word; /* Ensure long text wraps */
            white-space: normal; /* Ensure text wraps */
        }
       
        #toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            transform: translateY(-150%);
            transition: transform 0.5s ease-in-out;
            z-index: 100;
        }
        #toast-notification.show {
            transform: translateY(0);
        }

        .sidebar-link-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .sidebar-link-container .section-link {
            flex-grow: 1;
        }
        .delete-section-btn {
            background: none;
            border: none;
            color: #9CA3AF;
            cursor: pointer;
            padding: 0.25rem;
            margin-left: 0.5rem;
            display: none; /* Hidden by default */
        }
        .sidebar-link-container:hover .delete-section-btn {
            display: inline-block; /* Show on hover */
        }
        .delete-section-btn:hover {
            color: #EF4444; /* Red on hover */
        }


    </style>
</head>
<body>
    
    <!-- Main Application Container -->
    <div id="app-container"></div>

    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4"></div>
    
    <div id="toast-notification"></div>

    <!-- Theme Switcher (Global) -->
    <div id="theme-switcher" class="fixed bottom-4 right-4 bg-gray-900/80 backdrop-blur-sm p-3 rounded-xl border border-gray-700 shadow-lg">
        <div class="flex space-x-2">
            <button data-theme="theme-default" class="theme-button w-6 h-6 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-offset-gray-900 ring-white" title="Default Blue"></button>
            <button data-theme="theme-red" class="theme-button w-6 h-6 rounded-full bg-red-500" title="Redeemer's Red"></button>
            <button data-theme="theme-gold" class="theme-button w-6 h-6 rounded-full bg-amber-400" title="Golden Light"></button>
            <button data-theme="theme-green" class="theme-button w-6 h-6 rounded-full bg-emerald-500" title="Graceful Green"></button>
            <button data-theme="theme-purple" class="theme-button w-6 h-6 rounded-full bg-violet-500" title="Royal Purple"></button>
        </div>
    </div>

    <!-- Global Footer for all views -->
    <footer id="app-global-footer" class="ui-bg p-4 border-t border-gray-700 flex-shrink-0 hidden">
        <div id="footer-content-landing-dashboard" class="container mx-auto text-center text-gray-500 hidden">
            <p>&copy; 2025 Author's Aid. All Rights Reserved.</p>
        </div>
        <div id="footer-content-editor" class="container mx-auto flex justify-between items-center hidden">
             <!-- Chapter Navigation -->
            <div class="flex items-center space-x-2">
                <button id="prev-chapter-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">&lt; Prev</button>
                <button id="add-front-matter-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">+ New Front Matter Page</button>
                <button id="add-chapter-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">+ New Chapter</button>
                <button id="add-back-matter-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">+ New Back Matter Page</button>
                <button id="next-chapter-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Next &gt;</button>
            </div>
            <button id="export-project-btn" class="accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Export Project</button>
        </div>
    </footer>

    <!-- ALL APPLICATION JAVASCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut as firebaseSignOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, linkWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, serverTimestamp, query, onSnapshot, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVsziM6I1QEU22YNPGTwLvN0EuW4k2SiY",
            authDomain: "christian-author-app-54c4d.firebaseapp.com",
            projectId: "christian-author-app-54c4d",
            storageBucket: "christian-author-app-54c4d.firebasestorage.app",
            messagingSenderId: "386312831448",
            appId: "1:386312831448:web:80999eae638bbed28572ad"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        //======================================================================
        // --- CONSOLIDATED JAVASCRIPT MODULES ---
        //======================================================================

        // --- auth.js content ---
        let authInstance;
        function initializeAuth(config) { if (!authInstance) { const app = initializeApp(config); authInstance = getAuth(app); } return authInstance; }
        function onAuth(callback) { return onAuthStateChanged(authInstance, callback); }
        async function signInAnon() {
            try {
                const result = await signInAnonymously(authInstance);
                showNotification('Signed in as guest!', 'success');
                return result;
            } catch (e) {
                console.error("Anon sign-in failed:", e);
                showNotification(`Guest sign-in failed: ${e.message}`, 'error');
            }
        }
        async function signOut() {
            try {
                await firebaseSignOut(authInstance);
                showNotification('Signed out successfully.', 'info');
            } catch (e) {
                console.error("Sign-out failed:", e);
                showNotification(`Sign-out failed: ${e.message}`, 'error');
            }
        }

        async function signUpWithEmail(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(authInstance, email, password);
                showNotification('Account created successfully!', 'success');
                return userCredential.user;
            } catch (e) {
                console.error("Sign-up failed:", e);
                showNotification(`Sign-up failed: ${e.message}`, 'error');
                return null;
            }
        }

        async function signInWithEmail(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(authInstance, email, password);
                showNotification('Logged in successfully!', 'success');
                return userCredential.user;
            } catch (e) {
                console.error("Login failed:", e);
                showNotification(`Login failed: ${e.message}`, 'error');
                return null;
            }
        }

        async function linkGuestAccount(email, password) {
            try {
                const credential = EmailAuthProvider.credential(authInstance.currentUser.email, password);
                await linkWithCredential(authInstance.currentUser, credential);
                showNotification('Guest account linked successfully!', 'success');
                return true;
            } catch (e) {
                console.error("Linking guest account failed:", e);
                showNotification(`Linking account failed: ${e.message}`, 'error');
                return false;
            }
        }

        // --- firestore.js content ---
        let dbInstance;
        let storageInstance;
        function initializeDb(config) {
            if (!dbInstance) {
                const app = initializeApp(config);
                dbInstance = getFirestore(app);
                storageInstance = getStorage(app);
            }
            return dbInstance;
        }
        function getProjectsCollection(userId) { return collection(dbInstance, `artifacts/${appId}/users/${userId}/projects`); }
        async function createProject(userId, data) {
            try {
                const projectRef = await addDoc(getProjectsCollection(userId), { ...data, createdAt: serverTimestamp(), lastModified: serverTimestamp() });
                const sectionsCollection = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectRef.id}/sections`);
                const emptyContent = JSON.stringify({ ops: [{ insert: '\n' }] });
                
                const metadataContent = JSON.stringify({ 
                    authorName: '', copyrightYear: '', publisher: '', isbn: '', seriesName: '', seriesNumber: '', lccn: '', 
                    coverDesigner: '', interiorDesigner: '', publisherWebsite: '', authorBio: '', authorWorks: '' 
                });

                const sectionsToAdd = [
                    { id: 'metadata', title: 'Project Metadata', content: metadataContent, order: 0 },
                    { id: 'brainstorming', title: 'Synopsis & Brainstorming', content: emptyContent, order: 1 },
                    { id: 'book_titles', title: 'Book Titles', content: emptyContent, order: 2 },
                    { id: 'character_development', title: 'Character Development', content: emptyContent, order: 3 },
                    { id: 'world_building', title: 'World-building', content: emptyContent, order: 4 },
                    { id: 'outline', title: 'Outline', content: emptyContent, order: 5 },
                    { id: 'book_cover', title: 'Book Cover', content: '', order: 6 },
                    { id: 'copyright', title: 'Copyright', content: emptyContent, order: 7 },
                    { id: 'dedication', title: 'Dedication', content: emptyContent, order: 8 },
                    { id: 'foreword', title: 'Foreword', content: emptyContent, order: 9 },
                    { id: 'preface', title: 'Preface', content: emptyContent, order: 10 },
                    { id: 'acknowledgments', title: 'Acknowledgments', content: emptyContent, order: 10.5 },
                    { id: 'chapter_1', title: 'Chapter 1', content: emptyContent, order: 11 },
                    { id: 'about_the_author', title: 'About the Author', content: emptyContent, order: 100 },
                    { id: 'discussion_questions', title: 'Discussion Questions', content: emptyContent, order: 101 },
                ];

                for (const section of sectionsToAdd) {
                    await setDoc(doc(sectionsCollection, section.id), { title: section.title, content: section.content, order: section.order });
                }
                
                return projectRef.id;
            } catch (e) { console.error("Error creating project:", e); showNotification(`Error creating project: ${e.message}`, 'error'); }
        }
        async function addChapter(userId, projectId, chapterNumber) {
             try {
                const sectionsCollection = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`);
                const newChapterId = `chapter_${chapterNumber}`;
                const emptyContent = JSON.stringify({ ops: [{ insert: '\n' }] });
                const baseOrder = 11;
                await setDoc(doc(sectionsCollection, newChapterId), { title: `Chapter ${chapterNumber}`, content: emptyContent, order: baseOrder + chapterNumber - 1 });
                return true;
            } catch (e) { console.error("Error adding chapter:", e); showNotification(`Error adding chapter: ${e.message}`, 'error'); return false; }
        }

        async function addFrontMatterPage(userId, projectId, pageTitle, order) {
            try {
                const sectionsCollection = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`);
                const newPageId = pageTitle.toLowerCase().replace(/\s+/g, '_') + `_${Date.now()}`;
                const emptyContent = JSON.stringify({ ops: [{ insert: '\n' }] });
                await setDoc(doc(sectionsCollection, newPageId), { title: pageTitle, content: emptyContent, order: order });
                return true;
            } catch (e) { console.error("Error adding front matter page:", e); showNotification(`Error adding page: ${e.message}`, 'error'); return false; }
        }

        async function addBackMatterPage(userId, projectId, pageTitle, order) {
            try {
                const sectionsCollection = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`);
                const newPageId = pageTitle.toLowerCase().replace(/\s+/g, '_') + `_${Date.now()}`;
                const emptyContent = JSON.stringify({ ops: [{ insert: '\n' }] });
                await setDoc(doc(sectionsCollection, newPageId), { title: pageTitle, content: emptyContent, order: order });
                return true;
            } catch (e) { console.error("Error adding back matter page:", e); showNotification(`Error adding page: ${e.message}`, 'error'); return false; }
        }
        
        async function deleteSection(userId, projectId, sectionId) {
            try {
                const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, sectionId);
                await deleteDoc(sectionRef);
                return true;
            } catch (e) {
                console.error("Error deleting section:", e);
                showNotification(`Error deleting page: ${e.message}`, 'error');
                return false;
            }
        }

        async function getProjects(userId) { try { const qSnapshot = await getDocs(getProjectsCollection(userId)); const projects = []; qSnapshot.forEach(d => projects.push({ id: d.id, ...d.data() })); projects.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); return projects; } catch (e) { console.error("Error fetching projects:", e); showNotification(`Error fetching projects: ${e.message}`, 'error'); return []; } }
        async function getProject(userId, projectId) { try { const docRef = doc(getProjectsCollection(userId), projectId); const docSnap = await getDoc(docRef); return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null; } catch (e) { console.error("Error fetching project:", e); showNotification(`Error fetching project: ${e.message}`, 'error'); } }
        async function getProjectSections(userId, projectId) { try { const sectionsRef = collection(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`); const q = query(sectionsRef, orderBy("order")); const qSnapshot = await getDocs(q); const sections = []; qSnapshot.forEach(d => sections.push({ id: d.id, ...d.data() })); return sections; } catch (e) { console.error("Error fetching sections:", e); showNotification(`Error fetching sections: ${e.message}`, 'error'); return []; } }
        async function getSection(userId, projectId, sectionId) { try { const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, sectionId); const docSnap = await getDoc(sectionRef); return docSnap.exists() ? docSnap.data() : null; } catch (e) { console.error("Error getting section:", e); showNotification(`Error getting section: ${e.message}`, 'error'); return null; } }
        async function updateSectionContent(userId, projectId, sectionId, content) { try { const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, sectionId); await updateDoc(sectionRef, { content }); const projectRef = doc(getProjectsCollection(userId), projectId); await updateDoc(projectRef, { lastModified: serverTimestamp() }); } catch (e) { console.error("Error updating section:", e); showNotification(`Error updating section: ${e.message}`, 'error'); } }
        async function updateProjectCover(userId, projectId, coverUrl) { 
            try {
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { bookCoverUrl: coverUrl, lastModified: serverTimestamp() });
                showNotification('Book cover saved successfully!', 'success');
            } catch (e) {
                console.error("Error updating project cover:", e);
                showNotification(`Error saving cover: ${e.message}`, 'error');
            }
        }
        async function updateProjectTitle(userId, projectId, newTitle) {
            try {
                const cleanedTitle = stripMarkdownAndHtml(newTitle);
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { title: cleanedTitle, lastModified: serverTimestamp() });
                showNotification('Project title updated!', 'success');
            } catch (e) {
                console.error("Error updating project title:", e);
                showNotification(`Error updating project title: ${e.message}`, 'error');
            }
        }
        
        async function populateCopyrightPage(userId, projectId) {
            const projectData = await getProject(userId, projectId);
            const metadataSection = await getSection(userId, projectId, 'metadata');
            if (!projectData || !metadataSection) return;

            const metadata = JSON.parse(metadataSection.content);
            const projectTitle = projectData.title || 'Untitled Project';

            if (!metadata.authorName || !metadata.copyrightYear) {
                return;
            }

            let copyrightText = `${projectTitle}\n\n`;
            copyrightText += `Copyright © ${metadata.copyrightYear} by ${metadata.authorName}\n\n`;
            copyrightText += `All rights reserved. No part of this publication may be reproduced, distributed, or transmitted in any form or by any means, including photocopying, recording, or other electronic or mechanical methods, without the prior written permission of the publisher, except in the case of brief quotations embodied in critical reviews and certain other noncommercial uses permitted by copyright law.\n\n`;
            if(metadata.publisher) copyrightText += `Published by ${metadata.publisher}\n`;
            if(metadata.publisherWebsite) copyrightText += `${metadata.publisherWebsite}\n\n`;
            if(metadata.isbn) copyrightText += `ISBN: ${metadata.isbn}\n`;
            if(metadata.lccn) copyrightText += `Library of Congress Control Number: ${metadata.lccn}\n\n`;
            if(metadata.coverDesigner) copyrightText += `Cover design by ${metadata.coverDesigner}\n`;
            if(metadata.interiorDesigner) copyrightText += `Interior design by ${metadata.interiorDesigner}\n`;

            const quillContent = JSON.stringify({ ops: [{ insert: copyrightText + '\n' }] });
            await updateSectionContent(userId, projectId, 'copyright', quillContent);
            showNotification('Copyright page auto-updated!', 'info', 2000);
        }

        async function updateProjectMetadata(userId, projectId, metadata) {
            try {
                const sectionRef = doc(dbInstance, `artifacts/${appId}/users/${userId}/projects/${projectId}/sections`, 'metadata');
                await updateDoc(sectionRef, { content: JSON.stringify(metadata) });
                const projectRef = doc(getProjectsCollection(userId), projectId);
                await updateDoc(projectRef, { lastModified: serverTimestamp() });
                
                await populateCopyrightPage(userId, projectId);
                
                showNotification('Project metadata saved!', 'success');
            } catch (e) {
                console.error("Error updating project metadata:", e);
                showNotification(`Error saving metadata: ${e.message}`, 'error');
            }
        }

        async function deleteProject(userId, projectId) {
            try {
                await deleteDoc(doc(getProjectsCollection(userId), projectId));
                showNotification('Project deleted.', 'success');
            } catch (e) {
                console.error("Error deleting project:", e);
                showNotification(`Error deleting project: ${e.message}`, 'error');
            }
        }

        // --- utils.js content ---
        function debounce(func, wait) { let timeout; return function(...args) { const later = () => { clearTimeout(timeout); func(...args); args = null; }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
        
        let toastTimeout;
        function showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-notification');
            if (!container) return;

            clearTimeout(toastTimeout);

            let bgColor, icon;
            switch(type){ 
                case 'success': bgColor='bg-green-500/90 border-green-400'; icon='<i class="fas fa-check-circle mr-2"></i>'; break; 
                case 'error': bgColor='bg-red-500/90 border-red-400'; icon='<i class="fas fa-exclamation-circle mr-2"></i>'; break; 
                default: bgColor='bg-blue-500/90 border-blue-400'; icon='<i class="fas fa-info-circle mr-2"></i>'; break; 
            }
            container.innerHTML = `<div class="p-4 rounded-lg shadow-xl text-white ${bgColor} border flex items-center">${icon} ${message}</div>`;
            
            container.classList.add('show');
            
            toastTimeout = setTimeout(() => {
                container.classList.remove('show');
            }, duration);
        }

        function showModal(title, contentHtml, onConfirm, confirmText = 'Confirm', showCancel = true) {
            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) return;
            modalContainer.innerHTML = `<div class="bg-gray-800 text-gray-200 rounded-lg shadow-2xl w-full max-w-lg p-6 border border-gray-700"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-lora font-bold">${title}</h2><button id="modal-close-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button></div><div id="modal-content" class="max-h-[70vh] overflow-y-auto">${contentHtml}</div><div class="mt-6 flex justify-end space-x-4">${showCancel ? '<button id="modal-cancel-btn" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 transition-colors">Cancel</button>' : ''}<button id="modal-confirm-btn" type="submit" class="py-2 px-4 rounded-lg accent-bg accent-bg-hover transition-colors font-semibold">${confirmText}</button></div></div>`;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            const closeModal = () => { modalContainer.classList.add('hidden'); modalContainer.classList.remove('flex'); modalContainer.innerHTML = ''; };
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            if (showCancel) {
                document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
            }
            const confirmBtn = document.getElementById('modal-confirm-btn');
            if(onConfirm) {
                 confirmBtn.addEventListener('click', async () => {
                    const form = modalContainer.querySelector('form');
                    if (form && !form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    await onConfirm(modalContainer); 
                    closeModal();
                });
            } else {
                confirmBtn.addEventListener('click', closeModal);
            }
            
            modalContainer.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const passwordInput = toggle.previousElementSibling;
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    toggle.querySelector('i').classList.toggle('fa-eye');
                    toggle.querySelector('i').classList.toggle('fa-eye-slash');
                });
            });
        }

        function stripMarkdownAndHtml(text) {
            if (!text) return '';
            let cleanedText = text;
            cleanedText = cleanedText.replace(/\*\*(.*?)\*\*/g, '$1');
            cleanedText = cleanedText.replace(/__(.*?)__/g, '$1');
            cleanedText = cleanedText.replace(/\*(.*?)\*/g, '$1');
            cleanedText = cleanedText.replace(/_(.*?)_/g, '$1');
            cleanedText = cleanedText.replace(/\*/g, '');
            cleanedText = cleanedText.replace(/^#+\s*/gm, '');
            cleanedText = cleanedText.replace(/<[^>]*>/g, '');
            return cleanedText.trim();
        }

        function parseNumberedAiList(aiText, keepNumbers = false) {
            if (!aiText) return [];
            const results = [];
            let lines = aiText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            if (lines.length > 0 && !lines[0].match(/^(\d+)\.\s*(.*)/) && !lines[0].toLowerCase().includes('name:')) {
                lines.shift();
            }
            let hasNumberedItems = false;
            for (const line of lines) {
                if (line.match(/^(\d+)\.\s*(.*)/)) {
                    hasNumberedItems = true;
                    break;
                }
            }
            if (hasNumberedItems) {
                let currentItem = '';
                for (const line of lines) {
                    const match = line.match(/^(\d+)\.\s*(.*)/);
                    if (match) {
                        if (currentItem) results.push(currentItem.trim());
                        const content = match[2];
                        currentItem = keepNumbers ? `${match[1]}. ${content}` : content;
                    } else {
                        currentItem += `\n${line}`;
                    }
                }
                if(currentItem) results.push(currentItem.trim());
            } else {
                const paragraphs = aiText.split(/\n\s*\n/).map(p => p.trim()).filter(p => p.length > 0);
                for (const paragraph of paragraphs) {
                    results.push(paragraph);
                }
            }
            return results;
        }

        function escapeHTML(unsafe) {
            const toStr = String(unsafe);
            return toStr
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }


        // --- aiService.js content ---
        const API_KEY = "AIzaSyCVsziM6I1QEU22YNPGTwLvN0EuW4k2SiY";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
        let aiStylePreference = "";
        
        const characterTypesKnowledge = `
            Character Taxonomy for Reference:
            - Protagonist: The main character.
            - Antagonist: The character who opposes the protagonist.
            - Mentor: A wise character who guides the protagonist.
            - Deuteragonist: The second most important character.
            - Love Interest: A character with whom the protagonist has a romantic relationship.
            - Confidant: A character in whom the protagonist confides.
            - Foil: A character who contrasts with the protagonist to highlight particular qualities.
            - Sidekick: A companion to the protagonist.
        `;
        
        const BOOK_STRUCTURES_KNOWLEDGE = `
            A plot is the sequence of events that make up a story. It is the way that the story unfolds, from the beginning to the end. There are various ways you could structure the plot a fiction novel

            3 Act Structure: Divides the story into three parts: The setup, the confrontation, and the resolution.
            4 Act Structure: Divides the story into four parts: The setup, the rising action, the climax, and the resolution.
            5 Act Structure (Used by screenwriters & playwrights): Divides the story into five parts: The setup, the rising action, the climax, the falling action, and the resolution.
            Hero’s Journey: A narrative structure that involves a hero who goes on a journey, faces challenges, and ultimately returns home transformed. Stages include the call to adventure, meeting the mentor, crossing the threshold, trials and challenges, the innermost cave, the reward, the road back, the resurrection, and the return.
            Story Circle - Dan Harmon’s (Rick & Morty): An eight-step structure focusing on a character's transformation: 1. A character is in a zone of comfort. 2. They want something. 3. They enter an unfamiliar situation. 4. They adapt to it. 5. They get what they wanted. 6. They pay a heavy price for it. 7. They return to their familiar situation. 8. They have changed as a result of the journey.
        `;

        async function generateImage(prompt) {
            console.log("generateImage: Starting image generation for prompt:", prompt);
            try {
                document.getElementById('cover-display-container').innerHTML = `<div class="flex items-center justify-center py-4"><div class="loading-spinner"></div><span class="ml-2">Generating images...</span></div>`;
                const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 3 } };
                const response = await fetch(IMAGEN_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `Image generation failed with status ${response.status}.`;
                    if (errorData?.error?.message) errorMessage += ` Details: ${errorData.error.message}`;
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                if (result.predictions?.length > 0) {
                    return result.predictions.map(p => `data:image/png;base64,${p.bytesBase64Encoded}`);
                } else {
                    return [];
                }
            } catch (e) {
                console.error("Error calling Imagen API:", e);
                showNotification(`Image generation failed: ${e.message}`, 'error');
                return [];
            }
        }

        async function callGemini(contents, generationConfig = {}) {
            console.log("callGemini: Starting Gemini call with contents:", contents);
            const outputDiv = document.getElementById('ai-output');
            try {
                if (outputDiv) outputDiv.innerHTML = `<div class="flex items-center justify-center py-4"><div class="loading-spinner"></div><span class="ml-2">Generating...</span></div>`;
                const finalContents = contents.map(item => {
                    if (item.parts?.[0]?.text) {
                        return { ...item, parts: [{ text: `AI Style Preference: ${aiStylePreference}\n\n${item.parts[0].text}` }] };
                    }
                    return item;
                });
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: finalContents, generationConfig })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `API request failed with status ${response.status}.`;
                     if (errorData?.error?.message) errorMessage += ` Details: ${errorData.error.message}`;
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    return "Error: Could not generate content (unexpected AI response).";
                }
            } catch (e) {
                console.error("Error calling Gemini API:", e);
                showNotification(`AI call failed: ${e.message}`, 'error');
                return `Error: API call failed: ${e.message}`;
            } finally {
                if (outputDiv) outputDiv.innerHTML = '';
            }
        }

        async function generateSynopsisIdeas(idea) {
            const prompt = `You are an AI story consultant for Christian literature. Based on the user's basic idea, generate a numbered list of 5 distinct core concept ideas for a new Christian book. Each concept should be a single, concise paragraph describing the core idea. The tone should be encouraging and creative.\n\nBasic Idea: "${idea}"`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateOutlineBeats(context) { 
            const prompt = `You are an AI outliner for a Christian author. Based on the provided project details (synopsis, characters, world-building), generate a detailed chapter-by-chapter outline with key beats for each chapter. Ensure the outline aligns with Christian themes and values established in the context.
            **IMPORTANT:** When referring to characters in the outline beats, ALWAYS use their specific character names (e.g., "Amara," "Nana Elena") instead of their roles (e.g., "protagonist," "mentor").

            For each chapter, list the chapter title, and then provide a numbered list of key beats for that chapter. For example:
            Chapter 1: The Beginning
            1. Beat 1 of Chapter 1: Introduce protagonist and their core conflict.
            2. Beat 2 of Chapter 1: Character meets mentor.
            3. Beat 3 of Chapter 1: Call to adventure.

            Project Details:
            ---
            ${context}
            ---

            Generate the chapter-by-chapter outline:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        
        async function generateCharacterProfiles(context, authorContext) {
            const prompt = `You are an AI character developer for Christian fiction. Your task is to generate a numbered list of 5 distinct character profiles based on the provided context.

            **Strict Formatting Rules:**
            1.  Start each profile with the character's name, followed immediately by their character type from the taxonomy in parentheses. Example: "1. Elara (Protagonist)".
            2.  Do NOT use any markdown formatting like asterisks (* or **). All text should be plain.
            3.  Each profile must include: a name, character type, age, a detailed backstory, core motivations, and personality quirks.
            4.  Do not include any introductory text before the first numbered character.

            --- Character Taxonomy for Reference ---
            ${characterTypesKnowledge}
            --- End Taxonomy ---

            Author Context:
            ---
            ${authorContext}
            ---

            Project Details:
            ---
            ${context}
            ---

            Generate 5 character profiles following all rules:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }

        async function suggestAlternatives(selectedText, context) { 
            const prompt = `You are an AI thesaurus and editor for Christian literature. The user has selected a sentence and wants alternative phrasing for its key ideas. Analyze the following sentence and provide a list of alternative phrases for its most significant parts. Do not suggest alternatives for the entire sentence, but for its core components.
            \n\nContext:\n---\n${context}\n---\n\nSelected Text: "${selectedText}"
            \n\nProvide alternatives as a JSON array of objects, where each object has "original" and "suggestion" keys. For example: [{"original": "a generation to guard their hearts", "suggestion": "a generation to shield their hearts"}].`; 
            const config = { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { original: { type: "STRING" }, suggestion: { type: "STRING" } }, required: ["original", "suggestion"] } } };
            return callGemini([{ role: "user", parts: [{ text: prompt }] }], config); 
        }
        async function suggestScripture(selectedText, context) { 
            const prompt = `You are a theological assistant specializing in the NIV Bible. Based on the following selected text, suggest a list of 3 relevant NIV Bible scriptures.
            \n\nSelected Text for Context:\n---\n${context}\n---\n\nProvide the response as a JSON array of objects, where each object has "reference" and "text" keys.`; 
            const config = { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { reference: { type: "STRING" }, text: { type: "STRING" } }, required: ["reference", "text"] } } };
            return callGemini([{ role: "user", parts: [{ text: prompt }] }], config); 
        }
        async function suggestPOVs(context) { const prompt = `You are an AI writing coach for Christian authors. Based on the story's synopsis, generate a numbered list of 3 potential Point of View (POV) & Voice choices. For each, briefly explain how that choice would shape the narration and affect the reader's experience, particularly in a Christian context.\n\nSynopsis:\n---\n${context}\n-\n\nGenerate 3 POV & Voice options:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        
        async function suggestBookStructures(context) { 
            const prompt = `You are an AI writing coach for Christian authors. Your knowledge base of book structures is below.
        
            --- KNOWLEDGE BASE ---
            ${BOOK_STRUCTURES_KNOWLEDGE}
            --- END KNOWLEDGE BASE ---

            Based on the story's synopsis below, suggest a numbered list of 3 potential book structures from your knowledge base. For each suggestion, provide only the name of the structure and a single, concise sentence explaining why it fits the synopsis.

            **IMPORTANT FORMATTING RULES:**
            - Do NOT include any introductory text or conversational filler before the list.
            - Do NOT include any text other than the numbered list.
            - Example of a perfect response item: "1. The Hero's Journey: This structure fits well because it frames the protagonist's spiritual crisis as a transformative quest."

            Synopsis:
            ---
            ${context}
            ---

            Suggest 3 book structures:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]); 
        }

        async function analyzeChapter(chapterText, context) {
            const prompt = `You are an AI developmental editor for Christian manuscripts. Review the following book chapter in the context of the provided project details. Provide high-level feedback on Pacing, Plot Progression, and Character Consistency, specifically noting how well it integrates Christian themes or moral lessons. The feedback should be constructive and encouraging.\n\nProject Details:\n---\n${context}\n---\n\nChapter Text to Analyze:\n---\n${chapterText}\n---\n\nProvide your analysis:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function proofreadChapter(chapterText) { 
            const prompt = `You are an AI proofreader. Review the following text for grammatical errors, spelling mistakes, or punctuation issues. For each suggestion, provide the original text, the proposed change, and a brief reasoning.\n\nText to Proofread:\n---\n${chapterText}\n---\n\nProvide suggestions as a JSON array of objects with keys "original", "suggestion", and "reasoning".`; 
            const config = { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { original: { type: "STRING" }, suggestion: { type: "STRING" }, reasoning: { type: "STRING" } }, required: ["original", "suggestion", "reasoning"] } } };
            return callGemini([{ role: "user", parts: [{ text: prompt }] }], config);
        }
        async function suggestYouthPhrases(selectedText, context) { const prompt = `You are an AI dialogue coach. Given the following selected text (likely dialogue) and its surrounding context, provide a numbered list of 5 alternative phrases that sound more contemporary or like common youth slang. Ensure suggestions are appropriate and fit a Christian context if possible.\n\nContext:\n---\n${context}\n---\n\nSelected Text: "${selectedText}"\n\nProvide 5 youth phrase alternatives:`; return callGemini([{ role: "user", parts: [{ text: prompt }] }]); }
        async function generateCoverConcepts(context) {
            const prompt = `You are an AI art director for Christian book covers. Based on the provided book synopsis, generate 3 distinct and compelling visual concepts for a book cover. Each concept should be a short, descriptive paragraph that could be used as a prompt for an AI image generator. Focus on imagery that reflects Christian themes, symbolism, or the spiritual journey of the characters. Provide ONLY the descriptive image prompt text.\n\nSynopsis:\n---\n${context}\n---\n\nGenerate 3 book cover concepts:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateNext(currentText, outlineContent) {
            const prompt = `You are a Christian ghostwriter. Your task is to continue the narrative.
            Based on the following outline and the current text, write the next logical section of the story, focusing on advancing the plot according to the next relevant beat in the outline.
            Ensure the tone, style, and Christian themes are consistent with the overall manuscript.

            Overall Outline:
            ---
            ${outlineContent}
            ---

            Current Chapter Content:
            ---
            ${currentText}
            ---

            Continue the story, adhering to the outline's progression:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        
        async function generateTitles(context) {
            const prompt = `You are an AI creative assistant for Christian authors. Based on the following synopsis or brainstorming content, generate a numbered list of 5 distinct and compelling title suggestions for a Christian book. Provide ONLY the numbered list of titles and optional subtitles.\n\nContent:\n---\n${context}\n---\n\nGenerate 5 title suggestions:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }

        async function generateFrontMatter(context, topic) {
            const prompt = `You are an AI publishing assistant for Christian authors. For a book with the following details, generate content for the "${topic}" section of the front matter. Do not include a title or any template-like explanations.
            \n\nProject Details:\n---\n${context}\n---\n\nGenerate content for the ${topic}:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateBackMatter(context, topic) {
            const prompt = `You are an AI publishing assistant for Christian authors. For a book with the following details, generate content for the "${topic}" section of the back matter. Do not include a title or any template-like explanations.
            \n\nProject Details:\n---\n${context}\n---\n\nGenerate content for the ${topic}:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }

        // --- NEW WORLD-BUILDING & CHARACTER FUNCTIONS ---
        async function generateSettingDescription(location, setting, plot) {
            const prompt = `This story will take place in ${location} within a ${setting} setting. Write a short, plain-text description about this environment that ties into the following plot. Do not use any markdown formatting. \n\n${plot}`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateLocationIdeas(context) {
            const prompt = `Write a numbered list of a few ideas where the story can take place based on the following Plot & Story idea. Do not use any markdown formatting. \n\n${context}`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateTechnologyIdeas(context) {
            const prompt = `Write a numbered list of a few ideas about the technology in the story that helps the characters move through the plot, based on this context. Do not use any markdown formatting.\n\n${context}`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function developTechnologyIdeas(context) {
            const prompt = `The technology needed in the story will be communication systems, systems that allow the civilization to analyze planets, asteroids, and threats beyond the solar system, Space Armor, Mechanical space suits, and Defense systems. Develop a numbered list of a few ideas for some technology based off the information provided in the story context. Do not use any markdown formatting.\n\n${context}`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function developPowerSystem(context) {
            const prompt = `Develop a power system for the story based on the following context. Describe it as plain text, without markdown formatting.\n\n${context}`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function describeFuturisticWeapons(context) {
            const prompt = `Describe futuristic weapons that allow characters to protect their civilization from threats, to explore the solar system, and to fight enemies that pose a threat, based on this story context. Use plain text without markdown.\n\n${context}`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateWeaponList(context) {
            const prompt = `Generate a numbered list of weapons that tie into the story idea and the plot. Do not use markdown formatting.\n\n${context}`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function createTransportationIdeas(context) {
            const prompt = `Create a numbered list of ideas for interplanetary space travel for the civilization in the story, as well as for space marines. Include things like cruise ships, starships, and battleships, based on the following context. Do not use markdown formatting.\n\n${context}`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function identifyNeededCharacters(context) {
            const prompt = `Based on the following story context, what characters are needed to move the story forward? Provide a list of character roles and a brief explanation for each. Use plain text without markdown.
            \n\nStory Context:\n---\n${context}\n---`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateCharacterBackstory(characterName, context) {
            const prompt = `Write a detailed backstory for the character named "${characterName}". Use the provided story context to ensure the backstory is relevant and compelling. Use plain text without markdown.
            \n\nStory Context:\n---\n${context}\n---`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateCharacterArc(characterName, context) {
            const prompt = `Write a compelling character arc for "${characterName}". Describe their journey and transformation from the beginning to the end of the story, based on the provided context. Use plain text without markdown.
            \n\nStory Context:\n---\n${context}\n---`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function generateCharacterName(characterType) {
            const prompt = `Generate a numbered list of 10 potential names for a ${characterType} character in a Christian novel. Do not use markdown formatting.`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }
        async function expandOnText(selectedText, fullContext) {
            const prompt = `You are an AI writing assistant. The user has highlighted a piece of text from their chapter and wants to expand on it.
            Based on the highlighted text and the full chapter context, generate a numbered list of 3 distinct and compelling new paragraphs that could be inserted immediately after the highlighted text.
            The new paragraphs should logically follow the highlighted text, add depth or detail, and maintain the existing tone and style.

            **Strict Formatting Rules:**
            - Do NOT use any markdown formatting like asterisks (* or **). All text should be plain.
            - Do NOT include any introductory text or conversational filler before the list.

            --- Full Chapter Context ---
            ${fullContext}
            --- End Context ---

            --- Highlighted Text to Expand On ---
            "${selectedText}"
            --- End Highlighted Text ---

            Generate 3 new paragraph options:`;
            return callGemini([{ role: "user", parts: [{ text: prompt }] }]);
        }


        // --- views.js content ---
        const appContainer = document.getElementById('app-container');
        let currentUserId = null;
        let currentSelectionRange = null;
        let currentTheme = 'theme-default';

        function renderHelpModal() {
            const helpContent = `
                <div class="space-y-4 text-gray-300 overflow-y-auto max-h-[70vh] pr-4">
                    <p class="text-lg font-semibold text-white">Welcome to Author's Aid!</p>
                    <p>Your AI Co-author is here to assist you through every step of your manuscript writing journey, grounded in Christian values.</p>
                    <h4 class="text-md font-semibold text-white mt-4">Getting Started:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Sign Up/Login:</strong> Create an account to save your projects permanently across sessions. You can also continue as a guest, but guest data may not persist.</li>
                        <li><strong>New Project:</strong> From the Dashboard, click "+ New Project" to start a new book. Provide a title and select its type, genre, and target audience.</li>
                        <li><strong>Dashboard:</strong> View all your existing projects, open them, or delete them.</li>
                    </ul>
                    <h4 class="text-md font-semibold text-white mt-4">Using the Editor:</h4>
                    <p>The main editor screen is where your writing and AI tools come together. It's divided into three main panels:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Left Sidebar:</strong> Navigate between different sections of your project (Synopsis & Brainstorming, Book Titles, Character Development, Outline, Chapters, Book Cover, etc.).</li>
                        <li><strong>Center Panel:</strong> This is your primary writing area, powered by Quill.js. Type directly here, and your progress is automatically saved.</li>
                        <li><strong>Right Sidebar (AI Co-Author):</strong> This is where you interact with the AI tools.</li>
                    </ul>
                    <h4 class="text-md font-semibold text-white mt-4">AI Co-Author Features:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>AI Style Preference:</strong> Use the text area at the top to describe the writing style or tone you'd like the AI to adopt (e.g., "Write in a formal, encouraging tone," "Use concise, impactful language"). This preference is applied to all AI-generated content.</li>
                        <li><strong>Generate Synopsis Ideas (Synopsis & Brainstorming):</strong> Provide a basic idea in the editor, and the AI will generate core concept ideas for your book.</li>
                        <li><strong>POV & Voice (Synopsis & Brainstorming):</strong> Based on your synopsis, the AI can suggest different points of view and narrative voices.</li>
                        <li><strong>Book Structure (Synopsis & Brainstorming):</strong> Get AI-generated structural ideas (e.g., Three-Act Structure) for your story.</li>
                        <li><strong>Generate Character Profiles (Character Development):</strong> The AI helps you create detailed character ideas based on your story's concept.</li>
                        <li><strong>Generate Chapter Beats (Outline):</strong> Get a detailed chapter-by-chapter outline based on your project's synopsis, characters, and world-building.</li>
                        <li><strong>Continue Writing (Chapters):</strong> Overcome writer's block! Click this button in any chapter to have the AI generate the next section of text, using your existing content and project context.</li>
                        <li><strong>Analyze Chapter (Chapters):</strong> Get high-level feedback on pacing, plot progression, and character consistency for your chapter.</li>
                        <li><strong>Proofread Chapter (Chapters):</strong> Receive suggested corrections for grammar, spelling, and punctuation. Click on a suggestion to apply the fix directly to your text.</li>
                        <li><strong>Suggest Youth Phrases (Chapters):</strong> Select text (e.g., dialogue) and get contemporary youth slang suggestions, suitable for a Christian context.</li>
                        <li><strong>Generate Image Prompts (Book Cover):</strong> Get descriptive prompts for an AI image generator based on your book's synopsis. Click a concept to generate a visual book cover.</li>
                        <li><strong>Select Book Cover (Book Cover):</strong> After generating images, click on your preferred cover to highlight it and save its URL to your project.</li>
                    </ul>
                    <h4 class="text-md font-semibold text-white mt-4">Exporting Your Work:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Export Project:</strong> Use the "Export Project" button in the footer to download your entire manuscript as a clean HTML file. This file is suitable for importing into professional book formatting software for eBook and print preparation.</li>
                    </ul>
                    <p class="text-sm text-gray-400 mt-4">Remember that AI generation relies on external services. If you encounter "API call failed" errors, please check your Google Cloud Project settings for API enablement and quotas.</p>
                </div>
            `;
            showModal('How to Use Author\'s Aid', helpContent, null, 'Close', false);
        }


        function renderHeader(isLoggedIn, inEditor = false, userId = '') {
            let navLinksHtml = '';
            let userDisplay = '';
            if (isLoggedIn) {
                userDisplay = `<span class="text-gray-300 text-sm">${userId.substring(0, 8)}...</span>`; 
                navLinksHtml = `
                    <a href="#" id="help-link" class="text-gray-300 hover:text-white transition-colors text-sm">Help</a>
                    ${userDisplay}
                    <button id="sign-out-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md text-sm transition-colors">Logout</button>
                `;
            }
             const dashboardLink = inEditor ? `<a href="#" data-route="dashboard" class="nav-button text-sm text-gray-300 hover:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Dashboard</a>` : '';

            const headerHtml = `
                <header class="ui-bg p-4 border-b border-gray-700 flex-shrink-0">
                    <div class="container mx-auto flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            ${dashboardLink}
                            <h1 class="text-xl font-bold text-white">Author's Aid</h1>
                        </div>
                        <nav class="flex space-x-4 items-center">
                            ${navLinksHtml}
                        </nav>
                    </div>
                </header>`;

            const headerElement = document.createElement('div');
            headerElement.innerHTML = headerHtml;

            const signOutBtn = headerElement.querySelector('#sign-out-btn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await signOut();
                    navigateTo('landing');
                });
            }
            const helpLink = headerElement.querySelector('#help-link');
            if (helpLink) {
                helpLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderHelpModal();
                });
            }

            return headerElement;
        }

        async function handleSignUpClick(e) {
            e.preventDefault();
            const content = `
                <form id="signup-form">
                    <p class="text-gray-400 mb-4">Create an account to save your work permanently.</p>
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="email" name="email" required autocomplete="email" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                    </div>
                    <div class="password-input-container">
                        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="password" name="password" required minlength="6" autocomplete="new-password" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        <span class="password-toggle" data-target="password"><i class="fas fa-eye"></i></span>
                        <p class="text-xs text-gray-400 mt-1">Minimum 6 characters.</p>
                    </div>
                </form>
            `;
            showModal('Sign Up for Free', content, async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                if (email && password) {
                    const user = authInstance.currentUser;
                    if (user && user.isAnonymous) {
                        const success = await linkGuestAccount(email, password);
                        if (success) navigateTo('dashboard');
                    } else {
                        const newUser = await signUpWithEmail(email, password);
                        if (newUser) navigateTo('dashboard');
                    }
                }
            }, 'Sign Up');
        }

        async function handleLoginClick(e) {
            e.preventDefault();
            const content = `
                <form id="login-form">
                    <p class="text-gray-400 mb-4">Log in to access your saved projects.</p>
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="login-email" name="email" required autocomplete="email" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                    </div>
                    <div class="password-input-container">
                        <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="login-password" name="password" required autocomplete="current-password" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        <span class="password-toggle" data-target="login-password"><i class="fas fa-eye"></i></span>
                    </div>
                </form>
            `;
            showModal('Log In', content, async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (email && password) {
                    const user = await signInWithEmail(email, password);
                    if (user) navigateTo('dashboard');
                }
            }, 'Login');
        }

        function renderLandingPage() {
            document.body.style.overflow = 'auto';
            document.getElementById('theme-switcher').style.display = 'block';
            appContainer.innerHTML = `
                <div class="gradient-bg">
                    <header class="absolute top-0 left-0 w-full z-10 p-4">
                        <div class="container mx-auto flex justify-between items-center">
                            <h1 class="text-2xl font-bold font-lora text-white">Author's Aid</h1>
                            <nav class="hidden md:flex space-x-6 items-center">
                                <a href="#features" class="accent-text-hover transition-colors">Features</a>
                                <a href="#" id="sign-up-link" class="accent-text-hover transition-colors">Sign Up</a>
                                <a href="#" id="login-link" class="accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg transition-colors">Login</a>
                            </nav>
                        </div>
                    </header>
                    <main class="relative pt-32 pb-20 md:pt-48 md:pb-32">
                        <div class="container mx-auto text-center px-4">
                            <h2 class="text-4xl md:text-6xl font-bold font-lora text-white leading-tight mb-4">Your AI Co-Author, Guided by Faith</h2>
                            <p class="text-lg md:text-xl text-gray-400 max-w-3xl mx-auto mb-8">
                                Welcome, Rene' Stanly. Your personalized writing partner, trained on your unique style and grounded in Christian values. From manuscript to cover, let's bring your next masterpiece to life.
                            </p>
                            <button id="guest-btn" class="accent-bg accent-bg-hover text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 inline-block">Continue as Guest</button>
                        </div>
                    </main>
                    <section id="features" class="py-20 bg-black/30">
                        <div class="container mx-auto px-4"><div class="text-center mb-12"><h3 class="text-3xl md:text-4xl font-bold font-lora">A Tool for Every Step of Your Journey</h3></div>
                        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">AI Co-Author & Ghostwriter</h4><p class="text-gray-400">Trained on your works, the AI learns your voice to help write, edit, and offer suggestions that sound authentically like you.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Multi-Format Support</h4><p class="text-gray-400">Get a tailored roadmap for fiction, non-fiction, devotionals, or Bible studies.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Faith-Based Assistance</h4><p class="text-gray-400">Get suggestions for relevant NIV Bible scriptures and theological insights.</p></div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800"><h4 class="text-xl font-semibold mb-2 text-white">Book Cover Generation</h4><p class="text-gray-400">Generate professional front, spine, and back covers using AI image prompts.
</p></div>
                        </div>
                    </section>
                    <section id="cta" class="py-20 bg-black/30">
                        <div class="container mx-auto text-center px-4">
                            <h3 class="text-3xl md:text-4xl font-bold font-lora text-white mb-4">Ready to Write Your Next Chapter?</h3>
                            <p class="text-lg text-gray-400 max-w-2xl mx-auto mb-8">Sign up today to begin your journey with an AI partner that understands your faith, your voice, and your vision.</p>
                            <div class="max-w-md mx-auto">
                                <form class="flex flex-col sm:flex-row gap-4">
                                    <input type="email" placeholder="Enter your email" class="w-full px-4 py-3 rounded-lg bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 accent-ring" required>
                                    <button type="submit" id="signup-free-btn" class="accent-bg accent-bg-hover text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">Sign Up for Free</button>
                                </form>
                            </div>
                        </div>
                    </section>
                </div>
            `;
            document.getElementById('guest-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                showNotification('Signing in as guest...');
                await signInAnon();
            });
            document.getElementById('signup-free-btn').addEventListener('click', handleSignUpClick);
            document.getElementById('login-link').addEventListener('click', handleLoginClick);
            document.getElementById('sign-up-link').addEventListener('click', handleSignUpClick);
        }

        async function renderDashboard(userId) {
            currentUserId = userId;
            document.body.style.overflow = 'auto';
            document.getElementById('theme-switcher').style.display = 'block';
            appContainer.innerHTML = '';
            appContainer.appendChild(renderHeader(true, false, userId));
            const mainContent = document.createElement('main');
            mainContent.className = "container mx-auto p-8 flex-grow";
            mainContent.innerHTML = `<div class="text-center text-gray-400">Loading projects...</div>`;
            appContainer.appendChild(mainContent);

            const projects = await getProjects(userId);
            let listHtml = projects.map(p => {
                const themeBorderClass = `theme-border-${currentTheme.replace('theme-', '')}`;
                return `
                <div class="project-card bg-gray-800 p-4 rounded-lg border-2 ${themeBorderClass} flex flex-col items-center text-center">
                    <div class="mb-2">
                        ${p.bookCoverUrl ? `<img src="${p.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/150x225/1F2937/D1D5DB?text=Image+Load+Error';" class="w-[150px] h-[225px] object-cover rounded-md shadow-md" alt="Book Cover Thumbnail"/>` : `<img src="https://placehold.co/150x225/1F2937/D1D5DB?text=No+Cover" class="w-[150px] h-[225px] object-cover rounded-md shadow-md" alt="Placeholder Cover"/>`}
                    </div>
                    <div class="flex-grow flex flex-col justify-between w-full">
                        <div>
                            <h3 class="text-xl font-lora font-semibold text-white leading-tight mb-1">${stripMarkdownAndHtml(p.title || 'Untitled Project')}</h3>
                            ${p.authorName ? `<p class="text-sm text-gray-400">by ${escapeHTML(p.authorName)}</p>` : ''}
                        </div>
                        <p class="text-xs text-gray-500 mt-auto">Edited: ${p.lastModified ? new Date(p.lastModified.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                    </div>
                    <div class="flex mt-4 space-x-2 w-full">
                        <button data-route="editor" data-id="${p.id}" class="nav-button flex-grow accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Open</button>
                        <button data-action="delete" data-id="${p.id}" class="bg-gray-600 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">🗑️</button>
                    </div>
                </div>`;
            }).join('');

            if (projects.length === 0) {
                listHtml = `<p class="col-span-full text-center text-gray-400">You have no projects yet. Start your first one!</p>`;
            }

            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-lora font-bold text-white">Your Projects</h2>
                    <button id="new-project-btn" class="accent-bg accent-bg-hover text-white font-bold py-2 px-6 rounded-lg text-lg">+ New Project</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    ${listHtml}
                </div>`;

            document.getElementById('new-project-btn').addEventListener('click', handleNewProject);
            mainContent.addEventListener('click', (event) => {
                const deleteBtn = event.target.closest('[data-action="delete"]');
                if (deleteBtn) {
                    const projectId = deleteBtn.dataset.id;
                    handleDeleteProject(projectId);
                }
            });
        }

        function handleNewProject() {
            const content = `
                <form id="new-project-form">
                    <div class="space-y-4">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Enter your book title (optional)</label>
                            <input type="text" id="title" name="title" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                        </div>
                        <div>
                            <label for="bookType" class="block text-sm font-medium text-gray-300 mb-1">Book Type</label>
                            <select id="bookType" name="bookType" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>Fiction</option>
                                <option>Non-Fiction</option>
                                <option>Low Content</option>
                            </select>
                        </div>
                        <div>
                            <label for="genre" class="block text-sm font-medium text-gray-300 mb-1">Genre</label>
                            <select id="genre" name="genre" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>Christian Romance</option>
                                <option>Christian Fantasy</option>
                                <option>Christian Thriller</option>
                                <option>Children's Storybook</option>
                                <option>Devotional</option>
                                <option>Bible Study</option>
                                <option>Memoir</option>
                                <option>Christian Living</option>
                                <option>Theology</option>
                                <option>History</option>
                                <option>Prayer Journal</option>
                                <option>Gratitude Journal</option>
                                <option>Planner</option>
                            </select>
                        </div>
                        <div>
                            <label for="targetAudience" class="block text-sm font-medium text-gray-300 mb-1">Target Audience</label>
                            <select id="targetAudience" name="targetAudience" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 accent-ring">
                                <option>African American Adult</option>
                                <option>African American Young Adult</option>
                                <option>African American Children</option>
                                <option>Adult</option>
                                <option>Young Adult</option>
                                <option>Middle Grade</option>
                                <option>Children</option>
                                <option>All Ages</option>
                            </select>
                        </div>
                    </div>
                </form>
            `;
            showModal('Create a New Project', content, async () => {
                const title = document.getElementById('title').value || 'Untitled Project';
                const bookType = document.getElementById('bookType').value;
                const genre = document.getElementById('genre').value;
                const targetAudience = document.getElementById('targetAudience').value;
                const projectData = { title, bookType, genre, targetAudience };
                const newId = await createProject(currentUserId, projectData);
                if (newId) navigateTo('editor', { projectId: newId });
            }, 'Create Project');
        }

        function handleDeleteProject(projectId) {
            showModal('Confirm Deletion', '<p>Are you sure you want to permanently delete this project and all its content?</p>', async () => {
                await deleteProject(currentUserId, projectId);
                renderDashboard(currentUserId);
            }, 'Delete');
        }

        async function renderEditor(userId, projectId) {
            console.log("renderEditor: Rendering editor for projectId:", projectId);
            currentUserId = userId;
            document.body.style.overflow = 'hidden';
            document.getElementById('theme-switcher').style.display = 'none';
            appContainer.innerHTML = '';

            appContainer.appendChild(renderHeader(true, true, userId));
            const mainContent = document.createElement('main');
            mainContent.className = "flex flex-grow flex-col h-full min-h-0";
            mainContent.innerHTML = `<div class="text-center text-gray-400">Loading project...</div>`;
            appContainer.appendChild(mainContent);

            const project = await getProject(userId, projectId);
            if (!project) {
                mainContent.innerHTML = `<div class="text-center text-red-400 p-8">Error: Project not found.</div>`;
                return;
            }

            mainContent.innerHTML = `
                <div class="flex flex-grow overflow-hidden">
                    <div id="left-sidebar" class="w-2/12 bg-gray-800 p-4 border-r border-gray-700 flex flex-col overflow-y-auto"></div>
                    <div id="center-panel" class="w-7/12 p-8 flex flex-col overflow-y-auto bg-[#111827]">
                        <h3 id="project-main-title" class="text-3xl font-lora font-bold mb-4 text-white">${stripMarkdownAndHtml(project.title || 'Untitled Page')}</h3>
                        <div id="editor-container" class="flex-grow relative flex flex-col">
                           <div id="editor-toolbar"></div>
                           <div id="editor" class="flex-grow"></div>
                        </div>
                         <div id="cover-display-container" class="hidden flex-grow relative items-center justify-center"></div>
                         <div id="metadata-form-container" class="hidden flex-grow relative items-center justify-center p-4"></div>
                    </div>
                    <div id="right-sidebar" class="w-3/12 bg-gray-800 p-4 border-l border-gray-700 flex flex-col overflow-y-auto"></div>
                </div>
            `;

            const editorFooter = document.getElementById('app-global-footer');
            if (editorFooter) {
                editorFooter.classList.remove('hidden');
                document.getElementById('footer-content-editor').classList.remove('hidden');
                document.getElementById('footer-content-landing-dashboard').classList.add('hidden');
            }
            
            await setupEditorFunctionality(userId, projectId);
        }

        async function setupEditorFunctionality(userId, projectId) {
            let project = await getProject(userId, projectId);
            const projectMainTitle = document.getElementById('project-main-title');
            const leftSidebar = document.getElementById('left-sidebar');
            const rightSidebar = document.getElementById('right-sidebar');
            const editorContainer = document.getElementById('editor-container');
            const coverDisplayContainer = document.getElementById('cover-display-container');
            const metadataFormContainer = document.getElementById('metadata-form-container');

            let activeSectionId = 'brainstorming';
            let editor;
            let sections = [];

            const renderSidebar = () => {
                getProject(userId, projectId).then(updatedProject => {
                    if (updatedProject) {
                        project = updatedProject;
                        projectMainTitle.textContent = stripMarkdownAndHtml(project.title || 'Untitled Page');
                    }

                    const sidebarHeader = `
                        <div class="flex flex-col items-center mb-4">
                            ${project.bookCoverUrl ? `<img src="${project.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/120x180/1F2937/D1D5DB?text=Cover';" class="w-30 h-45 object-cover rounded-md shadow-md mb-2" alt="Book Cover Thumbnail"/>` : `<img src="https://placehold.co/120x180/1F2937/D1D5DB?text=No+Cover" class="w-30 h-45 object-cover rounded-md shadow-md mb-2" alt="Placeholder Cover"/>`}
                        </div>`;
                    
                    const sectionGroups = {
                        project: [], frontMatter: [], chapters: [], backMatter: []
                    };

                    const corePages = ['metadata', 'brainstorming', 'book_titles', 'character_development', 'world_building', 'outline', 'book_cover', 'copyright', 'dedication', 'foreword', 'preface', 'acknowledgments', 'chapter_1', 'about_the_author', 'discussion_questions'];

                    sections.forEach(s => {
                        if (s.order < 7) sectionGroups.project.push(s);
                        else if (s.order >= 7 && s.order < 11) sectionGroups.frontMatter.push(s);
                        else if (s.order >= 11 && s.order < 100) sectionGroups.chapters.push(s);
                        else sectionGroups.backMatter.push(s);
                    });

                    const createSectionLinks = (group) => group.map(s => `
                        <div class="sidebar-link-container">
                            <a href="#" data-section-id="${s.id}" class="section-link p-2 rounded-md text-gray-300 hover:bg-gray-700 transition-colors ${s.id === activeSectionId ? 'bg-blue-600 text-white' : ''}">${s.title}</a>
                            ${!corePages.includes(s.id) ? `<button data-section-id="${s.id}" class="delete-section-btn" title="Delete Page">🗑️</button>` : ''}
                        </div>
                    `).join('');

                    const sidebarNav = `
                        <nav id="project-sections" class="flex flex-col space-y-1 flex-grow overflow-y-auto">
                            ${createSectionLinks(sectionGroups.project)}
                            ${sectionGroups.frontMatter.length > 0 ? `<div class="pt-4 mt-2 border-t border-gray-700"><h4 class="text-xs font-bold uppercase text-gray-500 px-2 mb-2">Front Matter</h4></div>` : ''}
                            ${createSectionLinks(sectionGroups.frontMatter)}
                            ${sectionGroups.chapters.length > 0 ? `<div class="pt-4 mt-2 border-t border-gray-700"><h4 class="text-xs font-bold uppercase text-gray-500 px-2 mb-2">Chapters</h4></div>` : ''}
                            ${createSectionLinks(sectionGroups.chapters)}
                            ${sectionGroups.backMatter.length > 0 ? `<div class="pt-4 mt-2 border-t border-gray-700"><h4 class="text-xs font-bold uppercase text-gray-500 px-2 mb-2">Back Matter</h4></div>` : ''}
                            ${createSectionLinks(sectionGroups.backMatter)}
                        </nav>
                    `;

                    leftSidebar.innerHTML = sidebarHeader + sidebarNav;
                    leftSidebar.querySelectorAll('.section-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            activeSectionId = e.target.dataset.sectionId;
                            loadSection(activeSectionId);
                        });
                    });
                    
                    leftSidebar.querySelectorAll('.delete-section-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const sectionIdToDelete = e.target.dataset.sectionId;
                            const sectionToDelete = sections.find(s => s.id === sectionIdToDelete);
                            showModal('Confirm Deletion', `<p>Are you sure you want to delete the page "${sectionToDelete.title}"?</p>`, async () => {
                                const success = await deleteSection(userId, projectId, sectionIdToDelete);
                                if (success) {
                                    sections = await getProjectSections(userId, projectId);
                                    if (activeSectionId === sectionIdToDelete) {
                                        activeSectionId = 'brainstorming';
                                        await loadSection(activeSectionId);
                                    }
                                    renderSidebar();
                                    showNotification('Page deleted.', 'success');
                                }
                            }, 'Delete');
                        });
                    });
                });
            };
            
            const updateChapterNavButtons = () => {
                const chapterSections = sections.filter(s => s.id.startsWith('chapter_'));
                const currentIndex = chapterSections.findIndex(s => s.id === activeSectionId);
                const prevBtn = document.getElementById('prev-chapter-btn');
                const nextBtn = document.getElementById('next-chapter-btn');
                if (prevBtn && nextBtn) {
                    prevBtn.disabled = currentIndex <= 0;
                    nextBtn.disabled = currentIndex < 0 || currentIndex >= chapterSections.length - 1;
                }
            };
            
            document.getElementById('prev-chapter-btn').addEventListener('click', () => {
                const chapterSections = sections.filter(s => s.id.startsWith('chapter_'));
                const currentIndex = chapterSections.findIndex(s => s.id === activeSectionId);
                if (currentIndex > 0) loadSection(chapterSections[currentIndex - 1].id);
            });

            document.getElementById('next-chapter-btn').addEventListener('click', () => {
                const chapterSections = sections.filter(s => s.id.startsWith('chapter_'));
                const currentIndex = chapterSections.findIndex(s => s.id === activeSectionId);
                if (currentIndex >= 0 && currentIndex < chapterSections.length - 1) loadSection(chapterSections[currentIndex + 1].id);
            });

            document.getElementById('add-chapter-btn').addEventListener('click', async () => {
                const chapterCount = sections.filter(s => s.id.startsWith('chapter_')).length;
                const success = await addChapter(userId, projectId, chapterCount + 1);
                if(success) {
                    sections = await getProjectSections(userId, projectId);
                    renderSidebar();
                    showNotification(`Chapter ${chapterCount + 1} added!`, 'success');
                }
            });

            document.getElementById('add-front-matter-btn').addEventListener('click', () => {
                const content = `<form><label for="page-title" class="block text-sm font-medium text-gray-300 mb-1">Page Title</label><input type="text" id="page-title" name="title" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" required></form>`;
                showModal('Add Front Matter Page', content, async (modal) => {
                    const pageTitle = modal.querySelector('#page-title').value;
                    if (pageTitle) {
                        const frontMatterSections = sections.filter(s => s.order >= 7 && s.order < 11);
                        const lastOrder = frontMatterSections.length > 0 ? Math.max(...frontMatterSections.map(s => s.order)) : 6.9;
                        const success = await addFrontMatterPage(userId, projectId, pageTitle, lastOrder + 0.1);
                        if (success) {
                            sections = await getProjectSections(userId, projectId);
                            renderSidebar();
                            showNotification(`Page "${pageTitle}" added!`, 'success');
                        }
                    }
                }, 'Add Page');
            });

            document.getElementById('add-back-matter-btn').addEventListener('click', () => {
                const content = `<form><label for="page-title" class="block text-sm font-medium text-gray-300 mb-1">Page Title</label><input type="text" id="page-title" name="title" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" required></form>`;
                showModal('Add Back Matter Page', content, async (modal) => {
                    const pageTitle = modal.querySelector('#page-title').value;
                    if (pageTitle) {
                        const backMatterSections = sections.filter(s => s.order >= 100);
                        const lastOrder = backMatterSections.length > 0 ? Math.max(...backMatterSections.map(s => s.order)) : 99;
                        const success = await addBackMatterPage(userId, projectId, pageTitle, lastOrder + 1);
                        if (success) {
                            sections = await getProjectSections(userId, projectId);
                            renderSidebar();
                            showNotification(`Page "${pageTitle}" added!`, 'success');
                        }
                    }
                }, 'Add Page');
            });

            document.getElementById('export-project-btn').addEventListener('click', async () => {
                showNotification('Preparing manuscript for export...', 'info');
                try {
                    const allSections = await getProjectSections(userId, projectId);
                    let fullHtmlContent = '<html><head><meta charset="UTF-8"><title>'+escapeHTML(project.title || 'Untitled Manuscript')+'</title></head><body>';
                    fullHtmlContent += `<h1>${stripMarkdownAndHtml(project.title || 'Untitled Manuscript')}</h1>\n\n`;

                    for (const section of allSections) {
                        if (section.id === 'book_cover' || section.id === 'metadata' || section.id === 'book_titles') continue;
                        fullHtmlContent += `<h2>${section.title}</h2>\n`;
                        const tempDiv = document.createElement('div');
                        const tempQuill = new Quill(tempDiv, { readOnly: true });
                        try { tempQuill.setContents(JSON.parse(section.content)); } 
                        catch (e) { tempQuill.setText(section.content || ''); }
                        fullHtmlContent += tempDiv.querySelector('.ql-editor').innerHTML + '\n\n';
                    }
                    fullHtmlContent += '</body></html>';

                    const blob = new Blob([fullHtmlContent], { type: 'text/html;charset=utf-8' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `${stripMarkdownAndHtml(project.title).replace(/\s+/g, '-') || 'untitled-manuscript'}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showNotification('Manuscript exported as HTML!', 'success');

                } catch (e) {
                    console.error("Export failed:", e);
                    showNotification(`Export failed: ${e.message}`, 'error');
                }
            });

            const renderAiPanel = (sectionId) => {
                let contextualButtonsHtml = '';
                
                const pageGenerators = `
                    <div class="pt-4 mt-4 border-t border-gray-700">
                        <p class="text-sm font-semibold mb-2 text-gray-200">Front & Back Matter</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button data-topic="Copyright" data-matter-type="front" class="generate-matter-btn w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Copyright</button>
                            <button data-topic="Dedication" data-matter-type="front" class="generate-matter-btn w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Dedication</button>
                            <button data-topic="Foreword" data-matter-type="front" class="generate-matter-btn w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Foreword</button>
                            <button data-topic="Preface" data-matter-type="front" class="generate-matter-btn w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Preface</button>
                            <button data-topic="Acknowledgments" data-matter-type="front" class="generate-matter-btn w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Acknowledgments</button>
                            <button data-topic="About the Author" data-matter-type="back" class="generate-matter-btn w-full col-span-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">About the Author</button>
                        </div>
                    </div>`;

                if (sectionId === 'brainstorming') {
                    contextualButtonsHtml = `
                        <div>
                            <p class="text-sm font-semibold mb-2 text-gray-200">Generate Synopsis Ideas</p>
                            <textarea id="ai-idea-input" class="w-full h-24 p-2 bg-gray-700 border border-gray-600 rounded-md text-sm" placeholder="e.g., A story about a family..."></textarea>
                            <button id="generate-synopsis-concepts-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate</button>
                        </div>
                        <div class="pt-4 border-t border-gray-700">
                            <p class="text-sm font-semibold mb-2 text-gray-200">Brainstorming Tools</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="generate-pov-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">POV & Voice</button>
                                <button id="generate-book-structure-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Book Structure</button>
                            </div>
                        </div>`;
                } else if (sectionId === 'book_titles') {
                     contextualButtonsHtml = `<div><p class="text-sm font-semibold mb-2 text-gray-200">Generate Book Titles</p><button id="generate-titles-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Titles</button></div>`;
                } else if (sectionId === 'character_development') {
                    contextualButtonsHtml = `
                        <div>
                            <p class="text-sm font-semibold mb-2 text-gray-200">Generate Full Profiles</p>
                            <button id="generate-characters-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate 5 Profiles</button>
                        </div>
                        <div class="pt-4 mt-4 border-t border-gray-700 space-y-4">
                            <div>
                                <p class="text-sm font-semibold mb-2 text-gray-200">Targeted Generation</p>
                                <input type="text" id="character-name-input" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white text-sm" placeholder="Enter Character Name">
                                <div class="grid grid-cols-2 gap-2 mt-2">
                                    <button id="generate-backstory-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm">Backstory</button>
                                    <button id="generate-arc-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm">Character Arc</button>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-semibold mb-2 text-gray-200">Name Generation</p>
                                <select id="character-type-select" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white text-sm">
                                    <option>Protagonist</option>
                                    <option>Antagonist</option>
                                    <option>Love Interest</option>
                                    <option>Mentor</option>
                                    <option>Sidekick</option>
                                    <option>Supporting Character</option>
                                </select>
                                <button id="generate-name-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm">Get Names</button>
                            </div>
                             <div>
                                <p class="text-sm font-semibold mb-2 text-gray-200">Story Needs</p>
                                <button id="identify-needed-characters-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm">Needed Characters</button>
                            </div>
                        </div>
                    `;
                } else if (sectionId === 'world_building') {
                    contextualButtonsHtml = `
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm font-semibold mb-2 text-gray-200">Setting & Location</p>
                                <input type="text" id="wb-location-input" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white text-sm mb-2" placeholder="Location (e.g., Mars Colony)">
                                <input type="text" id="wb-setting-input" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white text-sm mb-2" placeholder="Setting (e.g., Dystopian Future)">
                                <button id="generate-setting-desc-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm">Describe Environment</button>
                                <button id="generate-location-ideas-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm mt-2">Suggest Locations</button>
                            </div>
                            <div class="pt-4 border-t border-gray-700">
                                <p class="text-sm font-semibold mb-2 text-gray-200">Technology</p>
                                <button id="generate-tech-ideas-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm">Get Tech Ideas</button>
                                <button id="develop-tech-ideas-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm mt-2">Develop Specific Tech</button>
                            </div>
                             <div class="pt-4 border-t border-gray-700">
                                <p class="text-sm font-semibold mb-2 text-gray-200">Power Systems</p>
                                <button id="develop-power-system-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm">Develop Power System</button>
                            </div>
                            <div class="pt-4 border-t border-gray-700">
                                <p class="text-sm font-semibold mb-2 text-gray-200">Weaponry</p>
                                <button id="describe-weapons-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm">Describe Weapons</button>
                                <button id="generate-weapon-list-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm mt-2">List Weapons</button>
                            </div>
                            <div class="pt-4 border-t border-gray-700">
                                <p class="text-sm font-semibold mb-2 text-gray-200">Transportation</p>
                                <button id="create-transport-ideas-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg text-sm">Get Vehicle Ideas</button>
                            </div>
                        </div>
                    `;
                } else if (sectionId === 'outline') {
                    contextualButtonsHtml = `<div><p class="text-sm font-semibold mb-2 text-gray-200">Generate Chapter Beats</p><button id="generate-outline-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Outline</button></div>`;
                } else if (sectionId.startsWith('chapter_')) {
                    contextualButtonsHtml = `
                        <div>
                            <p class="text-sm font-semibold mb-2 text-gray-200">Drafting & Revising</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="continue-writing-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Continue Writing</button>
                                <button id="analyze-chapter-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Analyze Chapter</button>
                            </div>
                            <button id="proofread-chapter-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg mt-2">Proofread</button>
                            <button id="expand-text-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg mt-2">Expand on Selection</button>
                        </div>`;
                } else if (sectionId === 'book_cover') {
                    contextualButtonsHtml = `<div><p class="text-sm font-semibold mb-2 text-gray-200">Generate Image Prompts</p><button id="generate-image-prompts-btn" class="w-full mt-2 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Generate Image Prompts</button></div>`;
                }

                const aiPanelHtml = `
                    <h3 class="text-lg font-bold mb-4">AI Co-Author</h3>
                    <div class="space-y-4 flex-grow flex flex-col">
                        <div class="pb-4 border-b border-gray-700">
                            <p class="text-sm font-semibold mb-2 text-gray-200">AI Style Preference</p>
                            <textarea id="ai-style-preference-input" class="w-full h-20 p-2 bg-gray-700 border border-gray-600 rounded-md text-sm" placeholder="e.g., Write in a formal, encouraging tone."></textarea>
                        </div>
                        ${contextualButtonsHtml}
                        <div class="pt-4 border-t border-gray-700 flex-shrink-0">
                            <p class="text-sm font-semibold mb-2 text-gray-200">Editing & Faith Tools</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="suggest-alternatives-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Alternative Words</button>
                                <button id="suggest-scripture-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Suggest Scripture</button>
                                <button id="suggest-youth-phrases-btn" class="w-full accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-lg">Youth Phrases</button>
                            </div>
                        </div>
                        ${pageGenerators}
                        <div id="ai-output" class="mt-4 text-sm text-gray-300 space-y-2 flex-grow overflow-y-auto"></div>
                    </div>`;

                rightSidebar.innerHTML = aiPanelHtml;
                setupAiPanelListeners(userId, projectId, editor);
            };

            const setupAiPanelListeners = (userId, projectId, editor) => {
                const outputDiv = document.getElementById('ai-output');

                const showContentInModal = (title, content, onAcceptCallback) => {
                    showModal(title, `<div class="whitespace-pre-wrap text-gray-300 text-sm">${escapeHTML(content)}</div>`, async () => {
                        await onAcceptCallback(content);
                    }, 'Accept & Add to Editor');
                };

                const aiStyleInput = document.getElementById('ai-style-preference-input');
                if (aiStyleInput) {
                    aiStyleInput.value = aiStylePreference;
                    aiStyleInput.addEventListener('input', debounce(() => {
                        aiStylePreference = aiStyleInput.value;
                        showNotification('AI style preference updated!', 'info', 1000);
                    }, 500));
                }
                
                const getFullProjectContext = async () => {
                    const projectData = await getProject(userId, projectId);
                    const allSections = await getProjectSections(userId, projectId);
                    const tempDiv = document.createElement('div');
                    const tempQuill = new Quill(tempDiv);
                    const getQuillText = (sectionId) => {
                        const section = allSections.find(s => s.id === sectionId);
                        if (!section || !section.content) return '';
                        try { tempQuill.setContents(JSON.parse(section.content)); return tempQuill.getText().trim(); } 
                        catch (e) { return section.content; }
                    };
                    return `Book Title: ${projectData.title || 'Untitled'}\n\nSynopsis: ${getQuillText('brainstorming')}\nCharacters: ${getQuillText('character_development')}\nWorld-building: ${getQuillText('world_building')}\nOutline: ${getQuillText('outline')}`.trim();
                };

                const getAuthorContext = async () => {
                    const metadataSection = await getSection(userId, projectId, 'metadata');
                    if (!metadataSection) return "Author bio and works not available.";
                    try {
                        const metadata = JSON.parse(metadataSection.content);
                        return `Author Bio: ${metadata.authorBio || 'Not provided'}\n\nOther Works by Author: ${metadata.authorWorks || 'Not provided'}`;
                    } catch(e) {
                         return "Author bio and works not available.";
                    }
                };

                outputDiv.addEventListener('click', async (e) => {
                    const suggestionItem = e.target.closest('.suggestion-item');
                    if (suggestionItem) {
                        const newText = suggestionItem.dataset.suggestion;
                        const originalText = suggestionItem.dataset.original;
                        if (editor && currentSelectionRange) {
                            const selectedText = editor.getText(currentSelectionRange.index, currentSelectionRange.length);
                            const startIndexInSelection = selectedText.indexOf(originalText);
                            if (startIndexInSelection !== -1) {
                                const absoluteStartIndex = currentSelectionRange.index + startIndexInSelection;
                                editor.deleteText(absoluteStartIndex, originalText.length);
                                editor.insertText(absoluteStartIndex, newText);
                            } else {
                                editor.deleteText(currentSelectionRange.index, currentSelectionRange.length);
                                editor.insertText(currentSelectionRange.index, newText);
                            }
                            const newEditorContent = JSON.stringify(editor.getContents());
                            await updateSectionContent(currentUserId, projectId, activeSectionId, newEditorContent);
                            outputDiv.innerHTML = ''; 
                        }
                        return;
                    }
                    
                    const titleBtn = e.target.closest('.title-suggestion-btn');
                    if (titleBtn) {
                        const newTitle = titleBtn.dataset.title;
                        await updateProjectTitle(userId, projectId, newTitle);
                        projectMainTitle.textContent = newTitle;
                        outputDiv.innerHTML = '';
                        return;
                    }
                });

                const addClickListener = (id, handler) => {
                    const btn = document.getElementById(id);
                    if (btn) btn.addEventListener('click', handler);
                };
                
                const handleBrainstormingChoice = async (generatorFunction, title, idea = null, insertionCallback = null) => {
                    const context = await getFullProjectContext();
                    if (!context && !idea) { showNotification("Please write a synopsis first.", "error"); return; }
                    const resultsText = await generatorFunction(idea || context);
                    const results = parseNumberedAiList(resultsText, false).map(c => stripMarkdownAndHtml(c.trim()));
                    
                    let modalContent = results.map((result, index) => 
                        `<button data-content="${escapeHTML(result)}" class="brainstorm-choice-btn w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-md mb-2">
                            <strong>Option ${index + 1}:</strong> ${escapeHTML(result)}
                        </button>`
                    ).join('');

                    showModal(title, modalContent, null, '', false);

                    const modalContainer = document.getElementById('modal-container');
                    const choiceHandler = async (e) => {
                        const target = e.target.closest('.brainstorm-choice-btn');
                        if (target) {
                            const content = target.dataset.content;
                            if (insertionCallback) {
                                insertionCallback(content);
                            } else if (editor) {
                                editor.insertText(editor.getLength(), '\n\n' + content);
                                const newEditorContent = JSON.stringify(editor.getContents());
                                await updateSectionContent(currentUserId, projectId, activeSectionId, newEditorContent);
                                showNotification("Content saved!", "success");
                            }
                            modalContainer.querySelector('#modal-close-btn')?.click();
                            modalContainer.removeEventListener('click', choiceHandler);
                        }
                    };
                    modalContainer.addEventListener('click', choiceHandler);
                };

                const showContentInModalAndSave = (title, contentPromise, prefix = '') => {
                    contentPromise.then(content => {
                        showModal(title, `<div class="whitespace-pre-wrap text-gray-300 text-sm">${escapeHTML(content)}</div>`, async () => {
                            if (editor) {
                                editor.insertText(editor.getLength(), `\n\n${prefix}` + content);
                                const newEditorContent = JSON.stringify(editor.getContents());
                                await updateSectionContent(currentUserId, projectId, activeSectionId, newEditorContent);
                                showNotification("Content saved!", "success");
                            }
                        }, 'Accept & Add to Editor');
                    });
                };


                addClickListener('generate-synopsis-concepts-btn', async () => {
                    const idea = document.getElementById('ai-idea-input').value.trim();
                    if (!idea) { showNotification("Please enter a basic idea.", "error"); return; }
                    handleBrainstormingChoice( () => generateSynopsisIdeas(idea), 'Choose a Synopsis Idea');
                });
                addClickListener('generate-pov-btn', () => handleBrainstormingChoice(suggestPOVs, 'Choose a Point of View'));
                
                addClickListener('generate-book-structure-btn', () => handleBrainstormingChoice(suggestBookStructures, 'Choose a Book Structure'));

                addClickListener('generate-image-prompts-btn', async () => {
                    const context = await getFullProjectContext();
                    if (!context) { showNotification("Please write a synopsis first.", "error"); return; }
                    const conceptsText = await generateCoverConcepts(context);
                    const concepts = parseNumberedAiList(conceptsText, false).map(c => stripMarkdownAndHtml(c.trim()));
                    let modalContent = concepts.map((concept, index) => `
                        <div class="p-2 bg-gray-700 rounded-md mb-2">
                            <textarea class="w-full h-24 p-2 bg-gray-800 border border-gray-600 rounded-md text-sm mb-2">${escapeHTML(concept)}</textarea>
                            <button data-prompt-index="${index}" class="ai-image-prompt-btn accent-bg accent-bg-hover text-white font-semibold py-1 px-3 rounded-lg">Generate Images</button>
                        </div>`
                    ).join('');
                    showModal('Generated Cover Prompts', modalContent, null, 'Close', false);
                    
                    document.getElementById('modal-container').addEventListener('click', e => {
                        if (e.target.classList.contains('ai-image-prompt-btn')) {
                            const prompt = e.target.previousElementSibling.value;
                            document.getElementById('modal-close-btn').click();
                            generateImage(prompt).then(imageUrls => {
                                if (imageUrls.length > 0) {
                                    coverDisplayContainer.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 p-4">${imageUrls.map(url => `
                                        <div class="cover-image-wrapper" data-image-url="${url}">
                                            <img src="${url}" class="w-full h-auto rounded-lg shadow-lg" alt="Generated Book Cover"/>
                                            <div class="cover-selection-overlay"><i class="fas fa-check-circle"></i></div>
                                        </div>
                                    `).join('')}</div>`;
                                    
                                    coverDisplayContainer.querySelectorAll('.cover-image-wrapper').forEach(wrapper => {
                                        wrapper.addEventListener('click', async (e) => {
                                            const selectedWrapper = e.currentTarget;
                                            const base64Url = selectedWrapper.dataset.imageUrl;
                                            showNotification('Saving cover...', 'info');
                                            try {
                                                const storagePath = `artifacts/${appId}/users/${userId}/projects/${projectId}/project_covers/${Date.now()}.png`;
                                                const storageRef = ref(storageInstance, storagePath);
                                                const uploadResult = await uploadString(storageRef, base64Url, 'data_url');
                                                const downloadUrl = await getDownloadURL(uploadResult.ref);
                                                await updateProjectCover(userId, projectId, downloadUrl);
                                                project.bookCoverUrl = downloadUrl;
                                                coverDisplayContainer.querySelectorAll('.cover-image-wrapper').forEach(w => w.classList.remove('selected'));
                                                selectedWrapper.classList.add('selected');
                                                renderSidebar();
                                            } catch (error) {
                                                console.error("Error uploading image and updating cover:", error);
                                                showNotification(`Error saving cover: ${error.message}`, 'error');
                                            }
                                        });
                                    });
                                }
                            });
                        }
                    });
                });
                
                addClickListener('generate-titles-btn', async () => {
                    const context = await getFullProjectContext();
                    if (!context) { showNotification("Please write a synopsis first.", "error"); return; }
                    const titlesText = await generateTitles(context);
                    const titles = parseNumberedAiList(titlesText, true); 
                    outputDiv.innerHTML = titles.map((title) => {
                        const cleanTitle = title.replace(/^\d+\.\s*/, '');
                        return `<button data-title="${escapeHTML(cleanTitle)}" class="title-suggestion-btn w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-md mb-2">${escapeHTML(title)}</button>`;
                    }).join('');
                });

                addClickListener('generate-characters-btn', async () => {
                    const context = await getFullProjectContext();
                    const authorCtx = await getAuthorContext();
                    if (!context) { showNotification("Please write a synopsis first.", "error"); return; }
                    showContentInModalAndSave('Generated Character Profiles', generateCharacterProfiles(context, authorCtx));
                });
                
                addClickListener('identify-needed-characters-btn', async () => {
                    const context = await getFullProjectContext();
                    if (!context) { showNotification("Please write a synopsis first.", "error"); return; }
                    showContentInModalAndSave('Needed Characters', identifyNeededCharacters(context));
                });

                addClickListener('generate-backstory-btn', async () => {
                    const name = document.getElementById('character-name-input').value.trim();
                    if (!name) { showNotification("Please enter a character name.", "error"); return; }
                    const context = await getFullProjectContext();
                    showContentInModalAndSave(`Backstory for ${name}`, generateCharacterBackstory(name, context), `--- BACKSTORY: ${name} ---\n\n`);
                });

                addClickListener('generate-arc-btn', async () => {
                    const name = document.getElementById('character-name-input').value.trim();
                    if (!name) { showNotification("Please enter a character name.", "error"); return; }
                    const context = await getFullProjectContext();
                    showContentInModalAndSave(`Character Arc for ${name}`, generateCharacterArc(name, context), `--- CHARACTER ARC: ${name} ---\n\n`);
                });

                addClickListener('generate-name-btn', async () => {
                    const type = document.getElementById('character-type-select').value;
                    handleBrainstormingChoice( () => generateCharacterName(type), `Names for ${type}`);
                });

                // --- WORLD-BUILDING LISTENERS ---
                addClickListener('generate-setting-desc-btn', async () => {
                    const location = document.getElementById('wb-location-input').value.trim();
                    const setting = document.getElementById('wb-setting-input').value.trim();
                    if(!location || !setting) { showNotification("Please provide a location and setting.", "error"); return; }
                    const context = await getFullProjectContext();
                    showContentInModalAndSave('Setting Description', generateSettingDescription(location, setting, context));
                });
                addClickListener('generate-location-ideas-btn', () => handleBrainstormingChoice(generateLocationIdeas, 'Location Ideas'));
                addClickListener('generate-tech-ideas-btn', () => handleBrainstormingChoice(generateTechnologyIdeas, 'Technology Ideas'));
                addClickListener('develop-tech-ideas-btn', () => handleBrainstormingChoice(developTechnologyIdeas, 'Developed Technology Ideas'));
                addClickListener('develop-power-system-btn', async () => {
                    const context = await getFullProjectContext();
                    if (!context) { showNotification("Please write a synopsis first.", "error"); return; }
                    showContentInModalAndSave('Power System Idea', developPowerSystem(context));
                });
                addClickListener('describe-weapons-btn', async () => {
                     const context = await getFullProjectContext();
                    if (!context) { showNotification("Please write a synopsis first.", "error"); return; }
                    showContentInModalAndSave('Weapon Descriptions', describeFuturisticWeapons(context));
                });
                addClickListener('generate-weapon-list-btn', () => handleBrainstormingChoice(generateWeaponList, 'Weapon Ideas'));
                addClickListener('create-transport-ideas-btn', () => handleBrainstormingChoice(createTransportationIdeas, 'Transportation Ideas'));


                addClickListener('generate-outline-btn', async () => {
                    const context = await getFullProjectContext();
                    if (!context) { showNotification("Please fill out your synopsis, characters, and world-building sections first.", "error"); return; }
                    showContentInModalAndSave('Generated Outline', generateOutlineBeats(context));
                });

                addClickListener('continue-writing-btn', async () => {
                    const currentText = editor.getText();
                    const context = await getFullProjectContext();
                    if (!context) { showNotification("Please ensure you have project details.", "error"); return; }
                    showContentInModalAndSave('Suggested Continuation', generateNext(currentText, context));
                });

                addClickListener('analyze-chapter-btn', async () => {
                    const chapterText = editor.getText();
                    if (!chapterText.trim()) { showNotification("Please write something to analyze.", "error"); return; }
                    const context = await getFullProjectContext();
                    const analysis = await analyzeChapter(chapterText, context);
                    outputDiv.innerHTML = `<div class="whitespace-pre-wrap p-2 bg-gray-900 rounded-md">${escapeHTML(analysis)}</div>`;
                });

                addClickListener('proofread-chapter-btn', async () => {
                    currentSelectionRange = editor.getSelection();
                    if (!currentSelectionRange || currentSelectionRange.length === 0) {
                        showNotification("Please select text to proofread.", "error"); return;
                    }
                    const chapterText = editor.getText(currentSelectionRange.index, currentSelectionRange.length);
                    const suggestionsJson = await proofreadChapter(chapterText);
                    try {
                        const suggestions = JSON.parse(suggestionsJson);
                        outputDiv.innerHTML = suggestions.map(s => `
                            <div class="suggestion-item" data-original="${escapeHTML(s.original)}" data-suggestion="${escapeHTML(s.suggestion)}">
                                <div class="suggestion-original">${escapeHTML(s.original)}</div>
                                <div class="suggestion-replacement">${escapeHTML(s.suggestion)}</div>
                                <div class="text-xs text-gray-400 mt-1">${escapeHTML(s.reasoning)}</div>
                            </div>`).join('');
                    } catch (e) {
                        outputDiv.innerHTML = `<div class="text-red-400">Could not get suggestions.</div>`;
                    }
                });
                
                addClickListener('expand-text-btn', async () => {
                    currentSelectionRange = editor.getSelection();
                    if (!currentSelectionRange || currentSelectionRange.length === 0) {
                        showNotification("Please select text to expand on.", "error"); return;
                    }
                    const selectedText = editor.getText(currentSelectionRange.index, currentSelectionRange.length);
                    const fullTextContext = editor.getText();
                    
                    const insertionCallback = async (content) => {
                        if (editor && currentSelectionRange) {
                            const insertPosition = currentSelectionRange.index + currentSelectionRange.length;
                            editor.insertText(insertPosition, '\n\n' + content);
                            const newEditorContent = JSON.stringify(editor.getContents());
                            await updateSectionContent(currentUserId, projectId, activeSectionId, newEditorContent);
                            showNotification("Expansion saved!", "success");
                        }
                    };
                    
                    handleBrainstormingChoice(() => expandOnText(selectedText, fullTextContext), 'Choose an Expansion', null, insertionCallback);
                });


                document.querySelectorAll('.generate-matter-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const topic = e.target.dataset.topic;
                        const matterType = e.target.dataset.matterType;
                        const context = await getFullProjectContext();
                        showContentInModalAndSave(`${topic} Ideas`, matterType === 'front' ? generateFrontMatter(context, topic) : generateBackMatter(context, topic), `--- ${topic.toUpperCase()} ---\n\n`);
                    });
                });

                const handleSelectionTools = async (e) => {
                    if (!editor) return;
                    currentSelectionRange = editor.getSelection();
                    if (!currentSelectionRange || currentSelectionRange.length === 0) {
                        showNotification("Please select some text first.", "error"); return;
                    }
                    const selectedText = editor.getText(currentSelectionRange.index, currentSelectionRange.length);
                    const fullTextContext = editor.getText();
                    
                    if (e.target.id === 'suggest-alternatives-btn') {
                        const resultsJson = await suggestAlternatives(selectedText, fullTextContext);
                        try {
                            const results = JSON.parse(resultsJson);
                            outputDiv.innerHTML = results.map(s => `<div class="suggestion-item" data-original="${escapeHTML(s.original)}" data-suggestion="${escapeHTML(s.suggestion)}"><div class="suggestion-original">${escapeHTML(s.original)}</div><div class="suggestion-replacement">${escapeHTML(s.suggestion)}</div></div>`).join('');
                        } catch (e) { outputDiv.innerHTML = `<div class="text-red-400">Could not get suggestions.</div>`; }
                    } else if (e.target.id === 'suggest-scripture-btn') {
                        const resultsJson = await suggestScripture(selectedText, fullTextContext);
                        try {
                            const results = JSON.parse(resultsJson);
                            let modalContent = results.map(s => `<div class="p-2 bg-gray-700 rounded-md mb-2"><p class="font-bold">${escapeHTML(s.reference)}</p><p class="mb-2">${escapeHTML(s.text)}</p><button data-scripture="${escapeHTML(s.reference + ': ' + s.text)}" class="add-scripture-btn accent-bg accent-bg-hover text-white font-semibold py-1 px-3 rounded-lg text-sm">Add</button></div>`).join('');
                            showModal('Suggested Scriptures', modalContent, null, 'Close', false);
                            document.getElementById('modal-container').addEventListener('click', e => {
                                if (e.target.classList.contains('add-scripture-btn')) {
                                    const scripture = e.target.dataset.scripture;
                                    editor.insertText(editor.getLength(), '\n\n' + scripture);
                                    const newEditorContent = JSON.stringify(editor.getContents());
                                    updateSectionContent(currentUserId, projectId, activeSectionId, newEditorContent);
                                    showNotification("Scripture saved!", "success");
                                }
                            });
                        } catch (e) { showNotification("Could not parse scripture suggestions.", "error"); }
                    } else { // Youth Phrases
                        const resultsText = await suggestYouthPhrases(selectedText, fullTextContext);
                        const results = parseNumberedAiList(resultsText, false);
                         outputDiv.innerHTML = results.map(s => `<div class="suggestion-item" data-original="${escapeHTML(selectedText)}" data-suggestion="${escapeHTML(s)}"><div class="suggestion-replacement">${escapeHTML(s)}</div></div>`).join('');
                    }
                };

                addClickListener('suggest-alternatives-btn', handleSelectionTools);
                addClickListener('suggest-scripture-btn', handleSelectionTools);
                addClickListener('suggest-youth-phrases-btn', handleSelectionTools);
            };
            
            const loadSection = async (sectionId) => {
                const sectionData = await getSection(userId, projectId, sectionId);
                project = await getProject(userId, projectId);
                if (projectMainTitle) projectMainTitle.textContent = stripMarkdownAndHtml(project.title || 'Untitled Page');
                activeSectionId = sectionId;

                editorContainer.classList.add('hidden');
                coverDisplayContainer.classList.add('hidden');
                metadataFormContainer.classList.add('hidden');

                if (sectionId === 'book_cover') {
                    coverDisplayContainer.classList.remove('hidden');
                    if (project?.bookCoverUrl) {
                        coverDisplayContainer.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 p-4"><div class="cover-image-wrapper selected" data-image-url="${escapeHTML(project.bookCoverUrl)}"><img src="${project.bookCoverUrl}" onerror="this.onerror=null;this.src='https://placehold.co/400x600/FF0000/FFFFFF?text=Image+Load+Error';" class="w-full h-auto rounded-lg shadow-lg" alt="Selected Book Cover"/><div class="cover-selection-overlay"><i class="fas fa-check-circle"></i> Selected</div></div></div>`;
                    } else {
                        coverDisplayContainer.innerHTML = `<div class="text-center text-gray-400">Your generated book cover will appear here.</div>`;
                    }
                } else if (sectionId === 'metadata') {
                    metadataFormContainer.classList.remove('hidden');
                    let metadata = {};
                    try { metadata = JSON.parse(sectionData.content); } catch(e) {}
                    
                    metadataFormContainer.innerHTML = `
                        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 w-full max-w-2xl">
                            <h3 class="text-xl font-lora font-bold mb-4 text-white">Project Metadata</h3>
                            <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="meta-author-name" class="block text-sm font-medium text-gray-300 mb-1">Author Name</label><input type="text" id="meta-author-name" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.authorName || '')}"></div>
                                    <div><label for="meta-copyright-year" class="block text-sm font-medium text-gray-300 mb-1">Copyright Year</label><input type="number" id="meta-copyright-year" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.copyrightYear || new Date().getFullYear())}"></div>
                                </div>
                                <div><label for="meta-publisher" class="block text-sm font-medium text-gray-300 mb-1">Publisher</label><input type="text" id="meta-publisher" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.publisher || '')}"></div>
                                <div><label for="meta-publisher-website" class="block text-sm font-medium text-gray-300 mb-1">Publisher Website (Optional)</label><input type="url" id="meta-publisher-website" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.publisherWebsite || '')}"></div>
                                <div><label for="meta-isbn" class="block text-sm font-medium text-gray-300 mb-1">ISBN (Optional)</label><input type="text" id="meta-isbn" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.isbn || '')}"></div>
                                <div><label for="meta-lccn" class="block text-sm font-medium text-gray-300 mb-1">LCCN (Optional)</label><input type="text" id="meta-lccn" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.lccn || '')}"></div>
                                <div><label for="meta-cover-designer" class="block text-sm font-medium text-gray-300 mb-1">Cover Designer (Optional)</label><input type="text" id="meta-cover-designer" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.coverDesigner || '')}"></div>
                                <div><label for="meta-interior-designer" class="block text-sm font-medium text-gray-300 mb-1">Interior Designer (Optional)</label><input type="text" id="meta-interior-designer" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" value="${escapeHTML(metadata.interiorDesigner || '')}"></div>
                                <div>
                                    <label for="meta-author-bio" class="block text-sm font-medium text-gray-300 mb-1">Author Biography</label>
                                    <textarea id="meta-author-bio" rows="4" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white">${escapeHTML(metadata.authorBio || '')}</textarea>
                                    <p class="text-xs text-gray-500 mt-1">Used for the 'About the Author' page and for AI context.</p>
                                </div>
                                <div>
                                    <label for="meta-author-works" class="block text-sm font-medium text-gray-300 mb-1">Other Works by Author</label>
                                    <textarea id="meta-author-works" rows="3" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" placeholder="e.g., Book 1, Book 2...">${escapeHTML(metadata.authorWorks || '')}</textarea>
                                    <p class="text-xs text-gray-500 mt-1">Helps the AI learn your style and genre.</p>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button id="save-metadata-btn" class="accent-bg accent-bg-hover text-white font-semibold py-2 px-6 rounded-lg">Save Metadata</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('save-metadata-btn').addEventListener('click', async () => {
                        const newMetadata = {
                            authorName: document.getElementById('meta-author-name').value,
                            copyrightYear: document.getElementById('meta-copyright-year').value,
                            publisher: document.getElementById('meta-publisher').value,
                            publisherWebsite: document.getElementById('meta-publisher-website').value,
                            isbn: document.getElementById('meta-isbn').value,
                            lccn: document.getElementById('meta-lccn').value,
                            coverDesigner: document.getElementById('meta-cover-designer').value,
                            interiorDesigner: document.getElementById('meta-interior-designer').value,
                            authorBio: document.getElementById('meta-author-bio').value,
                            authorWorks: document.getElementById('meta-author-works').value,
                        };
                        await updateProjectMetadata(userId, projectId, newMetadata);
                    });
                } else {
                    editorContainer.classList.remove('hidden');
                    try {
                        let content = JSON.parse(sectionData.content);
                        editor.setContents(content, 'api');
                    } catch (e) {
                        editor.setText(sectionData.content || '', 'api');
                    }
                }
                
                renderSidebar();
                renderAiPanel(sectionId);
                updateChapterNavButtons();
            };

            editor = new Quill('#editor', {
                modules: { toolbar: '#editor-toolbar' },
                theme: 'snow',
                placeholder: 'Start writing your masterpiece...'
            });

            editor.on('text-change', debounce(async (delta, oldDelta, source) => {
                if (source === 'user') {
                    const content = JSON.stringify(editor.getContents());
                    await updateSectionContent(userId, projectId, activeSectionId, content);
                }
            }, 500));

            sections = await getProjectSections(userId, projectId);
            await loadSection(activeSectionId);
        }

        const navigateTo = (route, params = {}) => {
            const appContainer = document.getElementById('app-container');
            appContainer.innerHTML = `<div class="text-center text-gray-400 p-8">Loading...</div>`;
            const footer = document.getElementById('app-global-footer');
            if (footer) {
                if (route === 'landing' || route === 'dashboard') {
                    footer.classList.remove('hidden');
                    document.getElementById('footer-content-landing-dashboard').classList.remove('hidden');
                    document.getElementById('footer-content-editor').classList.add('hidden');
                } else { // editor view
                    footer.classList.remove('hidden');
                    document.getElementById('footer-content-editor').classList.remove('hidden');
                    document.getElementById('footer-content-landing-dashboard').classList.add('hidden');
                }
            }

            if (route === 'landing') {
                renderLandingPage();
            } else if (route === 'dashboard') {
                renderDashboard(currentUserId);
            } else if (route === 'editor') {
                renderEditor(currentUserId, params.projectId);
            }
        };

        // --- Main App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAuth(firebaseConfig);
            initializeDb(firebaseConfig);

            onAuth(user => {
                if (user) {
                    currentUserId = user.uid;
                    navigateTo('dashboard');
                } else {
                    currentUserId = null;
                    navigateTo('landing');
                }
            });

            document.body.addEventListener('click', (e) => {
                const navBtn = e.target.closest('.nav-button');
                if (navBtn) {
                    e.preventDefault();
                    navigateTo(navBtn.dataset.route, { projectId: navBtn.dataset.id });
                }
            });

            document.getElementById('theme-switcher').addEventListener('click', (e) => {
                const button = e.target.closest('.theme-button');
                if (button) {
                    currentTheme = button.dataset.theme;
                    document.documentElement.className = currentTheme;
                    document.querySelectorAll('.theme-button').forEach(btn => btn.classList.remove('ring-white'));
                    button.classList.add('ring-white');
                    if(currentUserId) renderDashboard(currentUserId);
                }
            });
        });

    </script>
</body>
</html>
